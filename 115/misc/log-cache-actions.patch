# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1732288370 -3600
# Parent  cce07ccb2caeb94cf2292c5544eda13008558e92

diff --git a/mailnews/db/msgdb/src/nsMsgDatabase.cpp b/mailnews/db/msgdb/src/nsMsgDatabase.cpp
--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp
+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp
@@ -37,8 +37,12 @@
 #include "mozilla/Components.h"
 #include "mozilla/mailnews/MimeHeaderParser.h"
 #include "mozilla/intl/LocaleService.h"
 
+/* for logging to Error Console */
+#include "nsIScriptError.h"
+#include "nsMsgUtils.h"
+
 using namespace mozilla::mailnews;
 using namespace mozilla;
 
 #if defined(DEBUG_sspitzer_) || defined(DEBUG_seth_)
@@ -4608,9 +4612,10 @@ nsMsgDatabase::GetCachedHits(const nsACS
                 new nsMsgDBEnumerator(this, table, nullptr, nullptr));
   return NS_OK;
 }
 
-NS_IMETHODIMP nsMsgDatabase::InvalidateCache(const nsACString& aSearchFolderUri) {
+NS_IMETHODIMP nsMsgDatabase::InvalidateCache(
+    const nsACString& aSearchFolderUri) {
   // Mork doesn't offer a way to delete a table, and we can't update with
   // something invalid which we would detect later. So just make it empty.
   nsTArray<nsMsgKey> newHits;
   nsTArray<nsMsgKey> staleHits;
@@ -4736,8 +4741,39 @@ mdb_pos nsMsgDatabase::FindInsertIndexIn
 }
 NS_IMETHODIMP
 nsMsgDatabase::UpdateHdrInCache(const nsACString& aSearchFolderUri,
                                 nsIMsgDBHdr* aHdr, bool aAdd) {
+  nsCString msg;
+  nsMsgKey key2;
+  aHdr->GetMessageKey(&key2);
+  // nsCString subject;
+  // aHdr->GetSubject(subject);
+  PRTime date;
+  aHdr->GetDate(&date);
+  char dateBuf[64];
+  PRExplodedTime exploded;
+  PR_ExplodeTime(date, PR_GMTParameters, &exploded);
+  PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), "%a %b %d %H:%M:%S %Y",
+                         &exploded);
+  nsCOMPtr<nsIMsgFolder> folder;
+  GetFolder(getter_AddRefs(folder));
+  nsCString uri;
+  if (folder) folder->GetURI(uri);
+  if (aAdd) {
+    msg = nsPrintfCString("Search %s, folder %s: Adding key=%" PRIu32 
+                          ", date=%s",
+                          PromiseFlatCString(aSearchFolderUri).get(), uri.get(), key2,
+                          dateBuf);
+  } else {
+    msg = nsPrintfCString("Search %s, folder %s: Deleting key=%" PRIu32
+                          ", date=%s",
+                          PromiseFlatCString(aSearchFolderUri).get(), uri.get(), key2,
+                          dateBuf);
+  }
+  MsgLogToConsole4(NS_ConvertUTF8toUTF16(msg),
+                   NS_LITERAL_STRING_FROM_CSTRING(__FILE__), __LINE__,
+                   nsIScriptError::infoFlag);
+
   nsCOMPtr<nsIMdbTable> table;
   nsresult err =
       GetSearchResultsTable(aSearchFolderUri, true, getter_AddRefs(table));
   NS_ENSURE_SUCCESS(err, err);
