# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1732021753 -3600
# Parent  b84532fe6257ce66ce7fc6c52beebb35cbf60c0f

diff --git a/mailnews/db/msgdb/src/nsMsgDatabase.cpp b/mailnews/db/msgdb/src/nsMsgDatabase.cpp
--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp
+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp
@@ -37,8 +37,12 @@
 #include "mozilla/Components.h"
 #include "mozilla/mailnews/MimeHeaderParser.h"
 #include "mozilla/intl/LocaleService.h"
 
+/* for logging to Error Console */
+#include "nsIScriptError.h"
+#include "nsMsgUtils.h"
+
 using namespace mozilla::mailnews;
 using namespace mozilla;
 
 #if defined(DEBUG_sspitzer_) || defined(DEBUG_seth_)
@@ -4608,9 +4612,10 @@ nsMsgDatabase::GetCachedHits(const nsACS
                 new nsMsgDBEnumerator(this, table, nullptr, nullptr));
   return NS_OK;
 }
 
-NS_IMETHODIMP nsMsgDatabase::InvalidateCache(const nsACString& aSearchFolderUri) {
+NS_IMETHODIMP nsMsgDatabase::InvalidateCache(
+    const nsACString& aSearchFolderUri) {
   // Mork doesn't offer a way to delete a table, and we can't update with
   // something invalid which we would detect later. So just make it empty.
   nsTArray<nsMsgKey> newHits;
   nsTArray<nsMsgKey> staleHits;
@@ -4736,8 +4741,35 @@ mdb_pos nsMsgDatabase::FindInsertIndexIn
 }
 NS_IMETHODIMP
 nsMsgDatabase::UpdateHdrInCache(const nsACString& aSearchFolderUri,
                                 nsIMsgDBHdr* aHdr, bool aAdd) {
+  nsCString msg;
+  nsMsgKey key2;
+  aHdr->GetMessageKey(&key2);
+  nsCString subject;
+  aHdr->GetSubject(subject);
+  PRTime date;
+  aHdr->GetDate(&date);
+  char dateBuf[64];
+  PRExplodedTime exploded;
+  PR_ExplodeTime(date, PR_GMTParameters, &exploded);
+  PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), "%a %b %d %H:%M:%S %Y",
+                         &exploded);
+  if (aAdd) {
+    msg = nsPrintfCString("Folder %s: Adding key=%" PRIu32
+                          ", date=%s, subject='%s'",
+                          PromiseFlatCString(aSearchFolderUri).get(), key2,
+                          dateBuf, subject.get());
+  } else {
+    msg = nsPrintfCString("Folder %s: Deleting key=%" PRIu32
+                          ", date=%s, subject='%s'",
+                          PromiseFlatCString(aSearchFolderUri).get(), key2,
+                          dateBuf, subject.get());
+  }
+  MsgLogToConsole4(NS_ConvertUTF8toUTF16(msg),
+                   NS_LITERAL_STRING_FROM_CSTRING(__FILE__), __LINE__,
+                   nsIScriptError::infoFlag);
+
   nsCOMPtr<nsIMdbTable> table;
   nsresult err =
       GetSearchResultsTable(aSearchFolderUri, true, getter_AddRefs(table));
   NS_ENSURE_SUCCESS(err, err);
