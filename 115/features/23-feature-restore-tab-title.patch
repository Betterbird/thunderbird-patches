# HG changeset patch
# User alta88@fixall.com
# Date 1691428159 -7200
# Parent  9d94511cb5ea51b2ee04adc377ee6010e206512c
Feature: Tab title persist and restore.

Authored by Alta88 and contributed to the Betterbird Project.
See https://github.com/Betterbird/thunderbird-patches/blob/main/LICENSE for license details.
All uses require attribution to the Author.

diff --git a/mail/base/content/mailTabs.js b/mail/base/content/mailTabs.js
--- a/mail/base/content/mailTabs.js
+++ b/mail/base/content/mailTabs.js
@@ -230,16 +230,19 @@ var mailTabType = {
                   restoreState.ext[tabMonitor.monitorName],
                   false
                 );
               }
             } catch (ex) {
               console.error(ex);
             }
           }
+
+          // Restore last title immediately.
+          tabmail.tabInfo[0].tabNode.label = restoreState.state?.title ?? "";
         }
 
         let { chromeBrowser, closed } = tabmail.tabInfo[0];
         if (
           chromeBrowser.contentDocument.readyState == "complete" &&
           chromeBrowser.currentURI.spec == "about:3pane"
         ) {
           chromeBrowser.contentWindow.restoreState(persistedState);
diff --git a/mail/base/content/tabmail.js b/mail/base/content/tabmail.js
--- a/mail/base/content/tabmail.js
+++ b/mail/base/content/tabmail.js
@@ -895,16 +895,22 @@ var { UIFontSize } = ChromeUtils.import(
         if (browser && !tab.browser) {
           tab.browser = browser;
           if (!tab.linkedBrowser) {
             tab.linkedBrowser = browser;
           }
         }
 
         let restoreState = this._restoringTabState;
+
+        // Set the title property immediately only if there is a restore value.
+        if (restoreState?.state?.title) {
+          tab.title = restoreState.state.title;
+        }
+
         for (let tabMonitor of this.tabMonitors) {
           try {
             if (
               "onTabRestored" in tabMonitor &&
               restoreState &&
               tabMonitor.monitorName in restoreState.ext
             ) {
               tabMonitor.onTabRestored(
@@ -1290,19 +1296,21 @@ var { UIFontSize } = ChromeUtils.import(
         tabState = persistFunc.call(tab.mode.tabType, tab);
       } catch (ex) {
         // Report this so that our unit testing framework sees this
         // error and (extension) developers likewise can see when their
         // extensions are ill-behaved.
         console.error(ex);
       }
 
+      // Persist the last title for snappy startup restore.
       if (!tabState) {
-        return null;
+        tabState = {};
       }
+      tabState.title = tab.title;
 
       let ext = {};
       for (let tabMonitor of this.tabMonitors) {
         try {
           if ("onTabPersist" in tabMonitor) {
             let monState = tabMonitor.onTabPersist(tab);
             if (monState !== null) {
               ext[tabMonitor.monitorName] = monState;
@@ -1774,16 +1782,22 @@ var { UIFontSize } = ChromeUtils.import(
         for (let tabMonitor of this.tabMonitors) {
           try {
             tabMonitor.onTabTitleChanged(tab);
           } catch (ex) {
             console.error(ex);
           }
         }
 
+        // Don't set an empty value. Current title is from session store; only
+        // update with a new title.
+        if (!newLabel) {
+          return;
+        }
+
         // If the displayed tab is the one at the moment of creation
         // (aTabNodeOrInfo is null), set the default title as its title.
         tabNode.setAttribute("label", newLabel);
         // Update the window title if we're the displayed tab.
         if (iTab == this.tabContainer.selectedIndex) {
           this.setDocumentTitle(tab);
         }
 
