# HG changeset patch
# User alta88@fixall.com
# Date 1701196733 -3600
# Parent  daadde284aa40884f75076cbe85ba2f24d93ee9e
Feature: Attachment List on top option for compose

Authored by Alta88 and contributed to the Betterbird Project.
See https://github.com/Betterbird/thunderbird-patches/blob/main/LICENSE for license details.
All uses require attribution to the Author.

diff --git a/mail/app/profile/all-thunderbird.js b/mail/app/profile/all-thunderbird.js
--- a/mail/app/profile/all-thunderbird.js
+++ b/mail/app/profile/all-thunderbird.js
@@ -593,16 +593,18 @@ pref("mail.spotlight.loglevel", "Warn");
 
 // Whether to use a panel that looks like an OS X sheet for customization
 #ifdef XP_MACOSX
 pref("toolbar.customization.usesheet", true);
 #else
 pref("toolbar.customization.usesheet", false);
 #endif
 
+// Attachment list location on top if true; applies to new compose windows.
+pref("mail.compose.attachments.display.top", false);
 // Start compositions with (empty) attachment pane showing
 pref("mail.compose.show_attachment_pane", false);
 // Check for missing attachments?
 pref("mail.compose.attachment_reminder", true);
 // Words that should trigger a missing attachments warning.
 pref("mail.compose.attachment_reminder_keywords", "chrome://messenger/locale/messengercompose/composeMsgs.properties");
 // When no action is taken on the inline missing attachment notification,
 // show an alert on send?
diff --git a/mail/base/content/widgets/mailWidgets.js b/mail/base/content/widgets/mailWidgets.js
--- a/mail/base/content/widgets/mailWidgets.js
+++ b/mail/base/content/widgets/mailWidgets.js
@@ -771,16 +771,19 @@
       icon.setAttribute("alt", "");
       icon.setAttribute("draggable", "false");
       // Allow the src to be invalid.
       icon.classList.add("attachmentcell-icon", "invisible-on-broken");
       item.appendChild(icon);
 
       let textLabel = this.ownerDocument.createElement("span");
       textLabel.classList.add("attachmentcell-name");
+      // For overflow-x which creates a cropped text, by default there will
+      // be a tabstop on the element - prevent this.
+      textLabel.setAttribute("tabindex", "-1");
       item.appendChild(textLabel);
 
       let extensionLabel = this.ownerDocument.createElement("span");
       extensionLabel.classList.add("attachmentcell-extension");
       item.appendChild(extensionLabel);
 
       let sizeLabel = this.ownerDocument.createElement("span");
       sizeLabel.setAttribute("role", "note");
diff --git a/mail/base/content/widgets/pane-splitter.js b/mail/base/content/widgets/pane-splitter.js
--- a/mail/base/content/widgets/pane-splitter.js
+++ b/mail/base/content/widgets/pane-splitter.js
@@ -409,17 +409,17 @@
         return;
       }
 
       let vertical = this.resizeDirection == "vertical";
       let collapseSize =
         Number(
           this.getAttribute(vertical ? "collapse-height" : "collapse-width")
         ) || 0;
-      let ltrDir = this.parentNode.matches(":dir(ltr)");
+      let ltrDir = this.ownerDocument.body.matches(":dir(ltr)");
 
       this._dragStartInfo = {
         wasCollapsed: this.isCollapsed,
         // Whether this will resize vertically.
         vertical,
         pos: vertical ? event.clientY : event.clientX,
         // Whether decreasing X/Y should increase the size.
         negative: vertical
diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -967,20 +967,23 @@ var defaultController = {
         cmd.setAttribute("checked", gAttachMyPublicPGPKey);
         return isPgpConfigured();
       },
       doCommand() {},
     },
 
     cmd_toggleAttachmentPane: {
       isEnabled() {
-        return !gWindowLocked && gAttachmentBucket.itemCount;
+        let cmd = document.getElementById("cmd_toggleAttachmentPane");
+        cmd.setAttribute("checked", getShowAttachmentPanePref());
+        return !gWindowLocked;
       },
       doCommand() {
         toggleAttachmentPane("toggle");
+        setShowAttachmentPanePref();
       },
     },
 
     cmd_reorderAttachments: {
       isEnabled() {
         if (!gAttachmentBucket.itemCount) {
           let reorderAttachmentsPanel = document.getElementById(
             "reorderAttachmentsPanel"
@@ -5194,19 +5197,18 @@ async function ComposeStartup() {
         continue;
       }
     }
     // Did not find the required data in the draft to reconstruct the cloudFile
     // information. Fall back to no-draft-restore-support.
     attachmentItem.attachment.sendViaCloud = false;
   }
 
-  if (Services.prefs.getBoolPref("mail.compose.show_attachment_pane")) {
-    toggleAttachmentPane("show");
-  }
+  let show = addedAttachmentItems.length > 0 || getShowAttachmentPanePref();
+  toggleAttachmentPane(show ? "show" : "hide");
 
   // Fill custom headers.
   let otherHeaders = Services.prefs
     .getCharPref("mail.compose.other.header", "")
     .split(",")
     .map(h => h.trim())
     .filter(Boolean);
   for (let i = 0; i < otherHeaders.length; i++) {
@@ -5518,24 +5520,24 @@ async function ComposeLoad() {
   let messageHeader = document.getElementById("MsgHeadersToolbar");
   let recipientsContainer = document.getElementById("recipientsContainer");
   // In the unlikely situation where the recipients container is already
   // overflowing, we make sure to increase the minHeight by the overflow.
   let headerHeight =
     messageHeader.clientHeight +
     recipientsContainer.scrollHeight -
     recipientsContainer.clientHeight;
-  messageHeader.style.minHeight = `${headerHeight}px`;
+  messageHeader.parentElement.style.setProperty(
+    "--MsgHeadersToolbar-minHeight",
+    `${headerHeight}px`
+  );
 
   // Setup the attachment bucket.
   gAttachmentBucket = document.getElementById("attachmentBucket");
 
-  let attachmentArea = document.getElementById("attachmentArea");
-  attachmentArea.addEventListener("toggle", attachmentAreaOnToggle);
-
   // Setup the attachment animation counter.
   gAttachmentCounter = document.getElementById("newAttachmentIndicator");
   gAttachmentCounter.addEventListener(
     "animationend",
     toggleAttachmentAnimation
   );
 
   // Set up the drag & drop event listeners.
@@ -5620,16 +5622,18 @@ async function ComposeLoad() {
   ToolbarIconColor.init();
 
   // initialize the customizeDone method on the customizeable toolbar
   var toolbox = document.getElementById("compose-toolbox");
   toolbox.customizeDone = function (aEvent) {
     MailToolboxCustomizeDone(aEvent, "CustomizeComposeToolbar");
   };
 
+  InitAttachmentPane();
+
   updateAttachmentPane();
   updateAriaLabelsAndTooltipsOfAllAddressRows();
 
   for (let input of document.querySelectorAll(".address-row-input")) {
     input.onBeforeHandleKeyDown = event =>
       addressInputOnBeforeHandleKeyDown(event);
   }
 
@@ -8506,16 +8510,122 @@ async function RemoveAllAttachments() {
 
   if (!gAttachmentBucket.itemCount) {
     return;
   }
 
   await RemoveAttachments(gAttachmentBucket.itemChildren);
 }
 
+function InitAttachmentPane() {
+  let headersParent = document.getElementById("composeContentBox");
+  let attachmentSplitter = document.getElementById("attachmentSplitter");
+  headersParent.classList.toggle(
+    "attachment-area-hidden",
+    attachmentSplitter.isCollapsed
+  );
+  attachmentSplitter.addEventListener("splitter-collapsed", () => {
+    headersParent.classList.toggle(
+      "attachment-area-hidden",
+      attachmentSplitter.isCollapsed
+    );
+  });
+  attachmentSplitter.addEventListener("splitter-expanded", () => {
+    headersParent.classList.toggle(
+      "attachment-area-hidden",
+      attachmentSplitter.isCollapsed
+    );
+  });
+
+  SetAttachmenPaneLocation();
+}
+
+/**
+ * Set the location of the attachment list pane, per pref.
+ */
+function SetAttachmenPaneLocation() {
+  let location = getAttachmentPaneLocationPref();
+  let headersParent = document.getElementById("composeContentBox");
+  let attachmentSplitter = document.getElementById("attachmentSplitter");
+  if (headersParent.getAttribute("attachmentpanelocation") == location) {
+    // Already in the right location.
+    return;
+  }
+  const attachmentListConfigMap = {
+    top: {
+      parentId: "MsgHeadersToolbar",
+      resizeId: "attachmentBucket",
+      resizeDirection: "horizontal",
+      resizeDimension: "width",
+      defaultSize: 200,
+      collapseSize: 50,
+    },
+    bottom: {
+      parentId: "composeContentBox",
+      resizeId: "attachmentBucket",
+      resizeDirection: "vertical",
+      resizeDimension: "height",
+      defaultSize: 34,
+      collapseSize: 50,
+    },
+  };
+
+  let configMap = attachmentListConfigMap[location];
+  let attachmentArea = document.getElementById("attachmentArea");
+  let attachmentList = document.getElementById("attachmentBucket");
+
+  let parentId = configMap.parentId;
+  let resizeDirection = configMap.resizeDirection;
+  let isVertical = resizeDirection == "vertical";
+  let dimension = configMap.resizeDimension;
+  let oppositeDimension = isVertical ? "width" : "height";
+  let defaultSize = configMap.defaultSize;
+  let collapseSize = String(configMap.collapseSize);
+
+  headersParent.setAttribute("attachmentpanelocation", location);
+
+  let desiredParent = document.getElementById(parentId);
+  desiredParent.appendChild(attachmentSplitter);
+  desiredParent.appendChild(attachmentArea);
+  attachmentSplitter.setAttribute("resize-direction", resizeDirection);
+  attachmentSplitter.setAttribute(`collapse-${dimension}`, collapseSize);
+
+  attachmentList.setAttribute("orient", isVertical ? "horizontal" : "vertical");
+  // Required for context menus to be correct; selectedCount is off on dom move.
+  attachmentList.clearSelection();
+  attachmentList.selectItem(attachmentList.currentItem);
+  // Need to append again after a dom move.
+  attachmentList.controllers.appendController(attachmentBucketController);
+
+  // Set up attachments area size and persistence.
+  let pageURL = document.URL;
+  let attachmentsSize = Services.xulStore.getValue(
+    pageURL,
+    "attachmentSplitter",
+    dimension
+  );
+  attachmentSplitter[dimension] = Number(attachmentsSize) || defaultSize;
+  // Don't use the setter so persisted width/height isn't forgotten.
+  attachmentSplitter.removeAttribute(oppositeDimension);
+
+  attachmentSplitter.addEventListener("splitter-resized", () => {
+    let newSize = Math.round(attachmentSplitter[dimension]) || 0;
+    Services.xulStore.setValue(
+      pageURL,
+      "attachmentSplitter",
+      dimension,
+      String(newSize)
+    );
+    if (newSize < collapseSize) {
+      // When toggling the menuitem after drag collapse, open with default size.
+      attachmentSplitter[dimension] = defaultSize;
+    }
+  });
+}
+
 /**
  * Show or hide the attachment pane after updating its header bar information
  * (number and total file size of attachments) and tooltip.
  *
  * @param aShowBucket {Boolean} true: show the attachment pane
  *                              false (or omitted): hide the attachment pane
  */
 function UpdateAttachmentBucket(aShowBucket) {
@@ -8525,41 +8635,47 @@ function UpdateAttachmentBucket(aShowBuc
 /**
  * Update the header bar information (number and total file size of attachments)
  * and tooltip of attachment pane, then (optionally) show or hide the pane.
  *
  * @param aShowPane {string} "show":  show the attachment pane
  *                           "hide":  hide the attachment pane
  *                           omitted: just update without changing pane visibility
  */
-function updateAttachmentPane(aShowPane) {
+async function updateAttachmentPane(aShowPane) {
   let count = gAttachmentBucket.itemCount;
-
   document.l10n.setAttributes(
     document.getElementById("attachmentBucketCount"),
     "attachment-bucket-count-value",
     {
       count,
     }
   );
 
+  document.getElementById("attachment-indicator").tooltipText =
+    await document.l10n.formatValue("attachment-bucket-count-value", { count });
+
   let attachmentsSize = 0;
   for (let item of gAttachmentBucket.itemChildren) {
     gAttachmentBucket.invalidateItem(item);
     attachmentsSize += item.cloudHtmlFileSize
       ? item.cloudHtmlFileSize
       : item.attachment.size;
   }
 
   document.getElementById("attachmentBucketSize").textContent =
     count > 0 ? gMessenger.formatFileSize(attachmentsSize) : "";
 
-  document
-    .getElementById("composeContentBox")
-    .classList.toggle("attachment-area-hidden", !count);
+  let composeContentBox = document.getElementById("composeContentBox");
+  let attachmentSplitter = document.getElementById("attachmentSplitter");
+  composeContentBox.classList.toggle("has-attachment", count > 0);
+  composeContentBox.classList.toggle(
+    "attachment-area-hidden",
+    attachmentSplitter.isCollapsed
+  );
 
   attachmentBucketUpdateTooltips();
 
   // If aShowPane argument is omitted, it's just updating, so we're done.
   if (aShowPane === undefined) {
     return;
   }
 
@@ -8629,17 +8745,20 @@ async function RemoveAttachments(items) 
     gAttachmentBucket.clearSelection();
 
     AttachmentsChanged();
     dispatchAttachmentBucketEvent("attachments-removed", removedAttachments);
   }
 
   // Collapse the attachment container if all the items have been deleted.
   if (!gAttachmentBucket.itemCount) {
-    toggleAttachmentPane("hide");
+    if (!getShowAttachmentPanePref()) {
+      toggleAttachmentPane("hide");
+    }
+    gAttachmentBucket.style.minHeight = "";
   } else {
     // Try to restore the original focused item or somewhere close by.
     gAttachmentBucket.currentIndex =
       focusIndex < gAttachmentBucket.itemCount
         ? focusIndex
         : gAttachmentBucket.itemCount - 1;
   }
 
@@ -8935,74 +9054,42 @@ function moveSelectedAttachments(aDirect
  * Toggle attachment pane view state: show or hide it.
  * If aAction parameter is omitted, toggle current view state.
  *
  * @param {string} [aAction = "toggle"] - "show":   show attachment pane
  *                                        "hide":   hide attachment pane
  *                                        "toggle": toggle attachment pane
  */
 function toggleAttachmentPane(aAction = "toggle") {
-  let attachmentArea = document.getElementById("attachmentArea");
+  let attachmentSplitter = document.getElementById("attachmentSplitter");
+
+  // First collapse will not work unless resizeElement getter is already set up.
+  attachmentSplitter.resizeElement;
 
   if (aAction == "toggle") {
-    // Interrupt if we don't have any attachment as we don't want nor need to
-    // show an empty container.
-    if (!gAttachmentBucket.itemCount) {
-      return;
-    }
-
-    if (attachmentArea.open && document.activeElement != gAttachmentBucket) {
+    if (!getShowAttachmentPanePref() && !attachmentSplitter.isCollapsed) {
+      // If the splitter is not collapsed, it's due to there being attachments
+      // added and not due to the pref. Simulate a "show" to change the pref on
+      // a "toggle".
+      aAction = "show";
+    } else {
+      aAction = attachmentSplitter.isCollapsed ? "show" : "hide";
+    }
+    if (document.activeElement != gAttachmentBucket) {
       // Interrupt and move the focus to the attachment pane if it's already
       // visible but not currently focused.
       moveFocusToAttachmentPane();
-      return;
-    }
-
-    // Toggle attachment pane.
-    attachmentArea.open = !attachmentArea.open;
-  } else {
-    attachmentArea.open = aAction != "hide";
-  }
-}
-
-/**
- * Update the #attachmentArea according to its open state.
- */
-function attachmentAreaOnToggle() {
-  let attachmentArea = document.getElementById("attachmentArea");
-  let bucketHasFocus = document.activeElement == gAttachmentBucket;
-  if (attachmentArea.open && !bucketHasFocus) {
-    moveFocusToAttachmentPane();
-  } else if (!attachmentArea.open && bucketHasFocus) {
-    // Move the focus to the message body only if the bucket was focused.
-    focusMsgBody();
-  }
-
-  // Make the splitter non-interactive whilst the bucket is hidden.
-  document
-    .getElementById("composeContentBox")
-    .classList.toggle("attachment-bucket-closed", !attachmentArea.open);
-
-  // Update the checkmark on menuitems hooked up with cmd_toggleAttachmentPane.
-  // Menuitem does not have .checked property nor .toggleAttribute(), sigh.
-  for (let menuitem of document.querySelectorAll(
-    'menuitem[command="cmd_toggleAttachmentPane"]'
-  )) {
-    if (attachmentArea.open) {
-      menuitem.setAttribute("checked", "true");
-      continue;
-    }
-    menuitem.removeAttribute("checked");
-  }
-
-  // Update the title based on the collapsed status of the bucket.
-  document.l10n.setAttributes(
-    attachmentArea.querySelector("summary"),
-    attachmentArea.open ? "attachment-area-hide" : "attachment-area-show"
-  );
+    }
+  }
+
+  if (aAction == "hide") {
+    attachmentSplitter.collapse();
+  } else if (aAction == "show") {
+    attachmentSplitter.expand();
+  }
 }
 
 /**
  * Ensure the focus is properly moved to the Attachment Bucket, and to the first
  * available item if present.
  */
 function moveFocusToAttachmentPane() {
   gAttachmentBucket.focus();
@@ -9130,31 +9217,32 @@ function reorderAttachmentsPanelOnPopupS
   // required for updating the reorder commands.
   gAttachmentBucket.focus();
   // We're updating commands before showing the panel so that button states
   // don't change after the panel is shown, and also because focus is still
   // in attachment bucket right now, which is required for updating them.
   updateReorderAttachmentsItems();
 }
 
-function attachmentHeaderContextOnPopupShowing() {
-  let initiallyShowItem = document.getElementById(
-    "attachmentHeaderContext_initiallyShowItem"
-  );
-
-  initiallyShowItem.setAttribute(
-    "checked",
-    Services.prefs.getBoolPref("mail.compose.show_attachment_pane")
-  );
-}
-
-function toggleInitiallyShowAttachmentPane(aMenuItem) {
+function getAttachmentPaneLocationPref() {
+  let pref = Services.prefs.getBoolPref("mail.compose.attachments.display.top");
+  return pref ? "top" : "bottom";
+}
+
+function getShowAttachmentPanePref() {
+  return Services.prefs.getBoolPref("mail.compose.show_attachment_pane");
+}
+
+function setShowAttachmentPanePref() {
+  // Pref is set only by the menuitem oncommand, after toggle state, or by
+  // dragging the splitter to the collapsed state.
+  let attachmentSplitter = document.getElementById("attachmentSplitter");
   Services.prefs.setBoolPref(
     "mail.compose.show_attachment_pane",
-    aMenuItem.getAttribute("checked")
+    !attachmentSplitter.isCollapsed
   );
 }
 
 /**
  * Handle blur event on attachment pane and control visibility of
  * reorderAttachmentsPanel.
  */
 function attachmentBucketOnBlur() {
@@ -9195,33 +9283,38 @@ function attachmentBucketOnKeyPress(even
       if (reorderAttachmentsPanel.state == "open") {
         reorderAttachmentsPanel.hidePopup();
         return;
       }
 
       if (gAttachmentBucket.itemCount) {
         // Deselect selected items in a full bucket if any.
         if (gAttachmentBucket.selectedCount) {
-          gAttachmentBucket.clearSelection();
+          // Click will clear the selection better than clearSelection() for
+          // Enter to bring up a filepicker with a non empty bucket.
+          gAttachmentBucket.click();
           return;
         }
 
         // Move the focus to the message body.
         focusMsgBody();
         return;
       }
 
       // Close an empty bucket.
-      toggleAttachmentPane("hide");
+      if (!getShowAttachmentPanePref()) {
+        toggleAttachmentPane("hide");
+      }
       break;
 
     case "Enter":
-      // Enter on empty bucket to add file attachments, convenience
+      // Enter on empty bucket or bucket with no selection (ESC clears
+      // existing selection) to add file attachments, convenience
       // keyboard equivalent of single-click on bucket whitespace.
-      if (!gAttachmentBucket.itemCount) {
+      if (!gAttachmentBucket.hasSelection) {
         goDoCommand("cmd_attachFile");
       }
       break;
 
     case "ArrowLeft":
       gAttachmentBucket.moveByOffset(-1, !event.ctrlKey, event.shiftKey);
       event.preventDefault();
       break;
@@ -9249,27 +9342,34 @@ function attachmentBucketOnKeyPress(even
 
       event.preventDefault();
       break;
   }
 }
 
 function attachmentBucketOnClick(aEvent) {
   // Handle click on attachment pane whitespace normally clear selection.
-  // If there are no attachments in the bucket, show 'Attach File(s)' dialog.
+  // If there are no attachments in the bucket or no selection, show
+  // 'Attach File(s)' dialog.
   if (
     aEvent.button == 0 &&
     aEvent.target.getAttribute("is") == "attachment-list" &&
-    !aEvent.target.firstElementChild
+    !aEvent.target.hadSelection
   ) {
     goDoCommand("cmd_attachFile");
   }
 }
 
 function attachmentBucketOnSelect() {
+  // We have to keep our own flags, as core code always selects an item before
+  // later event handlers; the select event is fired twice on some clicks.
+  gAttachmentBucket.hadSelection =
+    gAttachmentBucket.hasSelection && !gAttachmentBucket.selectedCount;
+  gAttachmentBucket.hasSelection = gAttachmentBucket.selectedCount > 0;
+
   attachmentBucketUpdateTooltips();
   updateAttachmentItems();
 }
 
 function attachmentBucketUpdateTooltips() {
   // Attachment pane whitespace tooltip
   if (gAttachmentBucket.selectedCount) {
     gAttachmentBucket.tooltipText = getComposeBundle().getString(
@@ -10351,16 +10451,42 @@ var envelopeDragObserver = {
       let attachments = this.getValidAttachments(event);
       if (attachments.length) {
         // We're dragging files that can potentially be attached or added
         // inline, so update the variable.
         gIsDraggingAttachments = true;
 
         event.stopPropagation();
         event.preventDefault();
+
+        // Set various heights to position and size the drop targets and
+        // overlay elegantly.
+        let composeContentBox = document.getElementById("composeContentBox");
+        let height = document.getElementById("compose-toolbox").clientHeight;
+        composeContentBox.style.setProperty(
+          "--compose-toolbox-height",
+          `${height}px`
+        );
+        height = document.getElementById("FormatToolbox").clientHeight;
+        height += document.getElementById("headersSplitter").clientHeight;
+        composeContentBox.style.setProperty(
+          "--FormatToolbox-height",
+          `${height}px`
+        );
+        height = document.getElementById("MsgHeadersToolbar").clientHeight;
+        composeContentBox.style.setProperty(
+          "--MsgHeadersToolbar-height",
+          `${height}px`
+        );
+        height = document.getElementById("status-bar").clientHeight;
+        composeContentBox.style.setProperty(
+          "--status-bar-height",
+          `${height}px`
+        );
+
         document
           .getElementById("dropAttachmentOverlay")
           .classList.add("showing");
 
         document.l10n.setAttributes(
           document.getElementById("addAsAttachmentLabel"),
           "drop-file-label-attachment",
           {
@@ -10380,19 +10506,19 @@ var envelopeDragObserver = {
         // want to allow adding as text, as well as dragging only images, and
         // if this is not a plain text message.
         // NOTE: We're using event.dataTransfer.files.length instead of
         // attachments.length because we only need to consider images coming
         // from outside the application. The attachments array might contain
         // files dragged from other compose windows or received message, which
         // should not trigger the inline attachment overlay.
         document
-          .getElementById("addInline")
+          .getElementById("dropAttachmentOverlay")
           .classList.toggle(
-            "hidden",
+            "add-inline-hidden",
             !gIsValidInline &&
               (!event.dataTransfer.files.length ||
                 this.isNotDraggingOnlyImages(event.dataTransfer) ||
                 !gMsgCompose.composeHTML)
           );
       } else {
         DragAddressOverTargetControl(event);
       }
diff --git a/mail/components/compose/content/messengercompose.xhtml b/mail/components/compose/content/messengercompose.xhtml
--- a/mail/components/compose/content/messengercompose.xhtml
+++ b/mail/components/compose/content/messengercompose.xhtml
@@ -753,25 +753,16 @@
             command="cmd_reorderAttachments"/>
   <menuseparator id="attachmentListContext_removeAllSeparator"/>
   <menuitem id="attachmentListContext_removeAllItem"
             label="&removeAllAttachments.label;"
             accesskey="&removeAllAttachments.accesskey;"
             command="cmd_removeAllAttachments"/>
 </menupopup>
 
-<menupopup id="attachmentHeaderContext"
-           onpopupshowing="attachmentHeaderContextOnPopupShowing();">
-  <menuitem id="attachmentHeaderContext_initiallyShowItem"
-            type="checkbox"
-            label="&initiallyShowAttachmentPane.label;"
-            accesskey="&initiallyShowAttachmentPane.accesskey;"
-            oncommand="toggleInitiallyShowAttachmentPane(this);"/>
-</menupopup>
-
 <menupopup id="format-toolbar-context-menu"
            onpopupshowing="ToolbarContextMenu.updateExtension(this);">
   <menuitem oncommand="ToolbarContextMenu.openAboutAddonsForContextAction(this.parentElement)"
             data-l10n-id="toolbar-context-menu-manage-extension"
             class="customize-context-manageExtension"/>
   <menuitem oncommand="ToolbarContextMenu.removeExtensionForContextAction(this.parentElement)"
             data-l10n-id="toolbar-context-menu-remove-extension"
             class="customize-context-removeExtension"/>
@@ -2070,17 +2061,19 @@
 #ifdef XP_MACOSX
            iconsize="small"
 #endif
            defaultset="button-send,separator,button-encryption,button-encryption-options,button-address,spellingButton,button-save,button-contacts,spring,button-attach"
            customizable="true"
            context="toolbar-context-menu">
   </toolbar>
 </toolbox>
-  <html:div id="composeContentBox" class="printPreviewStack attachment-area-hidden">
+  <html:div id="composeContentBox"
+            class="printPreviewStack attachment-area-hidden"
+            attachmentpanelocation="bottom">
     <html:div id="contactsSidebar">
       <box class="sidebar-header" align="center">
         <label id="contactsTitle" value="&addressesSidebarTitle.label;"/>
         <spacer flex="1"/>
         <toolbarbutton class="close-icon"
                        oncommand="toggleContactsSidebar();"/>
       </box>
       <browser id="contactsBrowser" src="" disablehistory="true"/>
@@ -2427,16 +2420,20 @@
                         disableonsend="true"
                         oninput="msgSubjectOnInput(event);"
                         onkeypress="subjectKeyPress(event);"
                         aria-labelledby="subjectLabel"
                         style="flex: 1;"/>
           </moz-input-box>
         </hbox>
       </hbox>
+      <toolbarbutton id="attachment-indicator"
+                     class="toolbarbutton-1"
+                     oncommand="goDoCommand('cmd_toggleAttachmentPane')">
+      </toolbarbutton>
     </toolbar>
 
     <toolbox id="FormatToolbox" mode="icons">
       <toolbar id="FormatToolbar"
                class="chromeclass-toolbar themeable-brighttext"
                persist="collapsed"
                nowindowdrag="true">
 #include editFormatButtons.inc.xhtml
@@ -2496,18 +2493,18 @@
 
       <findbar id="FindToolbar" browserid="messageEditor"/>
     </html:div>
 
     <!-- NOTE: The splitter controls #attachmentBucket's size directly. -->
     <html:hr is="pane-splitter" id="attachmentSplitter"
              resize-direction="vertical"
              resize-id="attachmentBucket" />
-    <html:details id="attachmentArea">
-      <html:summary>
+    <html:details id="attachmentArea" open="">
+      <html:summary tabindex="-1">
         <!-- Hide from accessibility tree since this is only used for a brief
            - animation effect. -->
         <html:span id="newAttachmentIndicator" aria-hidden="true"></html:span>
         <html:img id="attachmentToggle"
                   src="chrome://messenger/skin/icons/new/nav-down-sm.svg"
                   alt="" />
         <html:span id="attachmentBucketCount"></html:span>
         <html:span id="attachmentBucketSize" role="note"></html:span>
diff --git a/mail/components/preferences/compose.inc.xhtml b/mail/components/preferences/compose.inc.xhtml
--- a/mail/components/preferences/compose.inc.xhtml
+++ b/mail/components/preferences/compose.inc.xhtml
@@ -282,16 +282,24 @@
     <hbox id="compositionAttachmentsCategory"
           class="subcategory"
           data-category="paneCompose">
       <html:h1 data-l10n-id="composition-attachments-header"/>
     </hbox>
 
     <html:div data-category="paneCompose">
     <html:fieldset data-category="paneCompose">
+      <hbox>
+        <vbox>
+          <checkbox id="attachmentListOnTopCompose"
+                    data-l10n-id="attachments-display-top-label"
+                    preference="mail.compose.attachments.display.top"/>
+        </vbox>
+        <spacer flex="1"/>
+      </hbox>
       <hbox align="center">
         <checkbox id="attachment_reminder_label"
                   data-l10n-id="attachment-label"
                   preference="mail.compose.attachment_reminder"/>
         <spacer flex="1"/>
         <hbox>
           <button is="highlightable-button" id="attachment_reminder_button"
                   data-l10n-id="attachment-options-label"
diff --git a/mail/components/preferences/compose.js b/mail/components/preferences/compose.js
--- a/mail/components/preferences/compose.js
+++ b/mail/components/preferences/compose.js
@@ -37,16 +37,17 @@ Preferences.addAll([
   { id: "mail.collect_email_address_outgoing", type: "bool" },
   { id: "mail.collect_addressbook", type: "string" },
   { id: "spellchecker.dictionary", type: "unichar" },
   { id: "msgcompose.default_colors", type: "bool" },
   { id: "msgcompose.font_face", type: "string" },
   { id: "msgcompose.font_size", type: "string" },
   { id: "msgcompose.text_color", type: "string" },
   { id: "msgcompose.background_color", type: "string" },
+  { id: "mail.compose.attachments.display.top", type: "bool" },
   { id: "mail.compose.attachment_reminder", type: "bool" },
   { id: "mail.compose.default_to_paragraph", type: "bool" },
   { id: "mail.compose.big_attachments.notify", type: "bool" },
   { id: "mail.compose.big_attachments.threshold_kb", type: "int" },
   { id: "mail.default_send_format", type: "int" },
   { id: "mail.compose.add_link_preview", type: "bool" },
 ]);
 
diff --git a/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd b/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd
--- a/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd
+++ b/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd
@@ -275,23 +275,16 @@
 <!ENTITY convertCloud.accesskey "C">
 <!ENTITY cancelUpload.label "Cancel Upload">
 <!ENTITY cancelUpload.accesskey "n">
 <!ENTITY convertRegularAttachment.label "Regular Attachment">
 <!ENTITY convertRegularAttachment.accesskey "A">
 <!ENTITY attachPage.label "Attach Web Page…">
 <!ENTITY attachPage.accesskey "W">
 
-<!-- Attachment Pane Header Bar Context Menu -->
-<!-- LOCALIZATION NOTE (initiallyShowAttachmentPane.label):
-     Should use the same wording as startExpandedCmd.label
-     in msgHdrViewOverlay.dtd. -->
-<!ENTITY initiallyShowAttachmentPane.label "Initially Show Attachment Pane">
-<!ENTITY initiallyShowAttachmentPane.accesskey "S">
-
 <!-- Spell checker context menu items -->
 <!ENTITY spellAddDictionaries.label "Add Dictionaries…">
 <!ENTITY spellAddDictionaries.accesskey "A">
 
 <!-- Title for the address picker panel -->
 <!ENTITY addressesSidebarTitle.label "Contacts">
 
 <!-- Identity popup customize menuitem -->
diff --git a/mail/themes/linux/mail/compose/messengercompose.css b/mail/themes/linux/mail/compose/messengercompose.css
--- a/mail/themes/linux/mail/compose/messengercompose.css
+++ b/mail/themes/linux/mail/compose/messengercompose.css
@@ -17,17 +17,17 @@
 
 #compose-toolbox {
   border-bottom: 1px solid var(--chrome-content-separator-color);
 }
 
 /* ::::: special toolbar colors ::::: */
 
 #subjectLabel {
-  margin-bottom: 0;
+  margin-top: 0;
   margin-inline-end: 6px;
 }
 
 /* ::::: autocomplete icons ::::: */
 
 .autocomplete-richlistitem[type$="-abook"] > .ac-site-icon {
   display: flex;
   margin: 1px 5px;
@@ -78,17 +78,17 @@
   margin-top: -2px;
 }
 
 #identityLabel-box {
   margin-top: 1px;
 }
 
 #msgIdentity {
-  margin-block: 2px 0;
+  margin-block: 1px;
   padding-block: 4px;
   padding-inline: 2px 20px;
 }
 
 #msgIdentity::part(label-box) {
   background: none;
   padding-inline-end: initial;
 }
diff --git a/mail/themes/osx/mail/compose/messengercompose.css b/mail/themes/osx/mail/compose/messengercompose.css
--- a/mail/themes/osx/mail/compose/messengercompose.css
+++ b/mail/themes/osx/mail/compose/messengercompose.css
@@ -66,17 +66,17 @@ toolbar[nowindowdrag="true"] {
   padding-block-start: 5px;
 }
 
 #identityLabel-box {
   margin-top: 3px;
 }
 
 #msgIdentity {
-  margin-block: 2px 0;
+  margin-block: 1px -1px;
   padding-block: 3px;
   color: inherit;
 }
 
 #msgIdentity::part(text-input) {
   color: inherit;
   padding-inline-start: 3px;
 }
@@ -107,17 +107,17 @@ toolbar[nowindowdrag="true"] {
   margin-bottom: -1px;
   margin-inline-start: -3px;
   margin-inline-end: 3px;
   padding-inline-end: 5px;
   border-inline-end: 1px solid #9b9b9b;
 }
 
 #subjectLabel {
-  margin-top: 3px;
+  margin-bottom: 3px;
   margin-inline-end: 6px;
 }
 
 .address-label-container {
   padding-top: 7px;
 }
 
 .address-container {
diff --git a/mail/themes/shared/mail/messengercompose.css b/mail/themes/shared/mail/messengercompose.css
--- a/mail/themes/shared/mail/messengercompose.css
+++ b/mail/themes/shared/mail/messengercompose.css
@@ -80,33 +80,39 @@
 
 .autocomplete-richlistitem {
   padding: var(--autocomplete-item-padding);
   border-radius: var(--autocomplete-item-radius);
 }
 
 #attachmentBucket {
   grid-area: attachment-list;
-  border-block: 1px solid var(--splitter-color); /* The same color as the splitters */
-  padding: 1px;
+  border: 1px solid transparent;
+}
+
+#attachmentBucket:focus {
+  border-color: var(--selected-item-color);
 }
 
 :root[lwt-tree] #attachmentArea > summary {
   background-color: var(--toolbar-bgcolor);
   color: var(--toolbar-color);
 }
 
 #attachmentArea > summary {
   grid-area: attachment-header;
   padding: 6px;
+  max-height: var(--attachment-summary-height);
+  border-bottom: 1px solid var(--splitter-color);
   /* Position self for the #newAttachmentIndicator. */
   position: relative;
   display: flex;
   gap: 6px;
   align-items: baseline;
+  pointer-events: none;
 }
 
 #attachmentArea > summary > * {
   flex: 0 0 auto;
 }
 
 #attachmentArea > summary:focus-visible {
   outline-style: auto;
@@ -152,16 +158,19 @@
 }
 
 #attachmentToggle {
   align-self: center;
   color: inherit;
   -moz-context-properties: stroke;
   stroke: currentColor;
   fill-opacity: 1;
+  /* If an attachment pane is visible, it is always open; it must be expanded
+   * for the on top location, and on bottom will behave likewise. */
+  display: none;
 }
 
 #attachmentArea:not([open]) #attachmentToggle {
   transform: rotate(-90deg);
 }
 
 #attachmentArea:-moz-locale-dir(rtl):not([open]) #attachmentToggle {
   transform: rotate(90deg);
@@ -172,21 +181,18 @@
   /* Required for text-overflow to do anything */
   white-space: nowrap;
   overflow: hidden;
 }
 
 #attachmentBucketSize {
   color: var(--selected-item-text-color);
   background-color: var(--selected-item-color);
-  font-size: 0.85em;
-  line-height: 1em;
-  padding: 3px 5px;
+  padding: 0 6px;
   border-radius: 10px;
-  font-weight: 500;
 }
 
 .drop-attachment-overlay {
   --overlay-color: #fff;
   --overlay-backround: rgba(0, 0, 0, 0.5);
   --drop-attachment-box-color: #222;
   --drop-attachment-box-border-color: rgba(255, 255, 255, 0.85);
   --drop-attachment-box-background-hover: rgba(255, 255, 255, 0.5);
@@ -204,19 +210,39 @@
 
 .drop-attachment-overlay {
   pointer-events: none;
   position: fixed;
   z-index: 12; /* above the attachment bucket splitter */
   background-color: var(--overlay-backround);
   color: var(--overlay-color);
   inset: 0;
-  padding: 30px;
+  padding-inline: 30px;
+  padding-top: var(--compose-toolbox-height);
+  padding-bottom: var(--status-bar-height);
   display: none;
   justify-content: space-around;
+  /* Default layout */
+  grid-template: "add-inline add-as-attachment" auto
+                 / var(--addInlineSize) var(--addAsAttachmentSize);
+  grid-gap: 20px;
+  --addInlineSize: 50%;
+  --addAsAttachmentSize: 50%;
+}
+
+#composeContentBox[attachmentpanelocation="top"] .drop-attachment-overlay:not(.add-inline-hidden) {
+  grid-gap: var(--FormatToolbox-height);
+  --addInlineSize: auto;
+  --addAsAttachmentSize: var(--MsgHeadersToolbar-height);
+}
+
+.drop-attachment-overlay.add-inline-hidden {
+  grid-gap: 0;
+  --addInlineSize: 0;
+  --addAsAttachmentSize: 100%;
 }
 
 @media (prefers-reduced-motion: no-preference) {
   @keyframes hiding-animation {
     0% { opacity: 1; }
     100% { opacity: 0; }
   }
   @keyframes showing-animation {
@@ -248,41 +274,57 @@
   }
 }
 
 .drop-attachment-overlay.hiding {
   animation: hiding-animation 120ms ease 1;
 }
 
 .drop-attachment-overlay.showing {
-  display: flex;
+  display: grid;
   animation: showing-animation 120ms ease 1;
 }
 
 .drop-attachment-overlay.show {
-  display: flex;
+  display: grid;
+}
+
+#composeContentBox[attachmentpanelocation="top"] .drop-attachment-overlay.showing,
+#composeContentBox[attachmentpanelocation="top"] .drop-attachment-overlay.show {
+  grid-template: "add-as-attachment" var(--addAsAttachmentSize)
+                 "add-inline" var(--addInlineSize)
+                 / 100%;
+  margin-top: var(--composeToolbar-height);
+}
+
+#addInline {
+  grid-area: add-inline;
+}
+
+.drop-attachment-overlay.add-inline-hidden > #addInline {
+  visibility: collapse;
+}
+
+#addAsAttachment {
+  grid-area: add-as-attachment;
 }
 
 .drop-attachment-box {
   pointer-events: auto;
   font-size: 1.4rem;
   font-weight: 600;
   color: var(--drop-attachment-box-color);
   border-radius: 15px;
   border: 4px dashed var(--drop-attachment-box-border-color);
   flex: 1;
   display: flex;
   align-items: center;
   justify-content: center;
 }
 
-.drop-attachment-box:not(.hidden) + .drop-attachment-box {
-  margin-inline-start: 30px;
-}
-
 .drop-attachment-box span {
   pointer-events: none;
   -moz-context-properties: fill;
   fill: currentColor;
   padding-inline: 25px 6px;
   border-radius: 3px;
   background-color: var(--drop-attachment-title-background);
   background-position: 6px center;
@@ -359,27 +401,23 @@
   padding-inline: 3px;
   display: grid;
   grid-template: "contacts contacts-splitter headers" minmax(auto, var(--headersSplitter-height))
                  "contacts contacts-splitter format-toolbar" min-content
                  "contacts contacts-splitter headers-splitter" min-content
                  "contacts contacts-splitter message" minmax(33%, 1fr)
                  "contacts contacts-splitter attachment-splitter" min-content
                  "contacts contacts-splitter attachment-header" min-content
-                 "contacts contacts-splitter attachment-list" var(--attachment-list-track-size)
+                 "contacts contacts-splitter attachment-list" var(--attachmentSplitter-height)
                  / minmax(auto, var(--contactsSplitter-width)) min-content minmax(auto, 1fr);
   /* If the splitter is not used, the header and attachment areas will try and
    * grow to their content size. */
   --headersSplitter-height: min-content;
   --attachmentSplitter-height: min-content;
   --contactsSplitter-width: 200px;
-  /* NOTE: We specify the sizing of the attachment list using a variable because
-   * when the attachment area is hidden or the attachment list is closed, we
-   * want to adjust the sizing so that we can ignore the splitter height. */
-  --attachment-list-track-size:  minmax(auto, var(--attachmentSplitter-height));
   /* The parent body uses the -moz-box display, which does not take into account
    * the natural minimum height this element can take due to its grid display.
    * So we need to explicitly set the minimum height so that the body's layout
    * will properly resize this element to the available space.
    * TODO: Remove these rules when the body uses a standard CSS display. */
   min-height: 0;
   flex: 1;
   overflow: clip;
@@ -412,16 +450,26 @@
 
 #contactsSplitter.splitter-collapsed {
   /* The splitter cannot be un-collapsed using a mouse drag. */
   display: none;
 }
 
 #MsgHeadersToolbar {
   grid-area: headers;
+  min-height: var(--MsgHeadersToolbar-minHeight);
+}
+
+#MsgHeadersToolbar {
+  display: grid;
+  grid-template: "from-row attachment-indicator" min-content
+                 "recipients-row attachment-indicator" minmax(0, min-content)
+                 "subject-row attachment-indicator" auto
+                 / minmax(auto, 1fr) min-content;
+
 }
 
 #FormatToolbox {
   appearance: none;
   grid-area: format-toolbar;
 }
 
 #headersSplitter {
@@ -451,45 +499,97 @@
 
 #attachmentSplitter {
   grid-area: attachment-splitter;
 }
 
 #attachmentArea {
   /* Children are grid items. */
   display: contents;
+  --attachment-summary-height: 34px;
+  --attachment-bucket-height: calc(100% - var(--attachment-summary-height));
 }
 
-/* When the attachment area is hidden, or the visibility of the attachmentBucket
- * is toggled by the summary element. */
-#composeContentBox:is(.attachment-area-hidden, .attachment-bucket-closed) {
-  /* We adjust the track sizing so it no longer takes up any grid space. */
-  --attachment-list-track-size: 0;
+#attachmentArea[open] > #attachmentBucket {
+  min-height: 30px;
 }
 
-#composeContentBox.attachment-bucket-closed #attachmentSplitter {
+#composeContentBox[attachmentpanelocation="bottom"] #attachmentSplitter {
   /* NOTE: When the bucket is closed, we do not consider it "collapsed" by the
    * splitter. It was closed by the attachmentArea's summary, not the splitter.
    * Moreover, it cannot be un-collapsed by the splitter either.
    * Instead, we want to simply stop the splitter from resizing by making it
    * non-interactive. We keep the splitter visible though as it still acts as a
    * barrier between the message body and the attachment area. */
   pointer-events: none;
 }
 
-#composeContentBox.attachment-area-hidden #attachmentSplitter {
-  /* We completely hide the splitter when the attachment area is hidden. */
+#composeContentBox[attachmentpanelocation="top"] #MsgHeadersToolbar {
+  grid-template: "from-row attachment-indicator attachment-splitter attachment-area" auto
+                 "recipients-row attachment-indicator attachment-splitter attachment-area" minmax(0, 1fr)
+                 "subject-row attachment-indicator attachment-splitter attachment-area" auto
+                 / minmax(auto, 1fr) min-content min-content minmax(auto, var(--attachmentSplitter-width));
+}
+
+#top-gradient-box {
+  grid-area: from-row;
+  height: max-content;
+}
+
+#recipientsContainer {
+  grid-area: recipients-row;
+}
+
+#subject-box {
+  grid-area: subject-row;
+  align-self: end;
+}
+
+#composeContentBox #attachment-indicator {
   display: none;
 }
 
-#composeContentBox.attachment-area-hidden #attachmentArea {
-  display: none;
+#composeContentBox.attachment-area-hidden.has-attachment #attachment-indicator {
+  display: block;
+  grid-area: attachment-indicator;
+  background-image: var(--icon-attachment);
+  background-position: center;
+  background-repeat: no-repeat;
+  background-size: 32px;
+}
+
+#composeContentBox[attachmentpanelocation="top"] #attachmentArea {
+  display: block;
+  grid-area: attachment-area;
+  margin-block-start: 1px;
+  border-bottom: 1px solid var(--splitter-color);
+  overflow-x: hidden;
+  overflow-y: auto;
 }
 
-#composeContentBox.attachment-bucket-closed #attachmentBucket {
+#composeContentBox[attachmentpanelocation="top"] #attachmentArea > summary {
+  padding-bottom: 9px;
+}
+
+#composeContentBox[attachmentpanelocation="top"] #attachmentArea #attachmentBucketCount {
+  flex: 1;
+}
+
+#composeContentBox[attachmentpanelocation="top"] #attachmentBucket {
+  height: var(--attachment-bucket-height);
+  flex-wrap: nowrap;
+}
+
+#composeContentBox[attachmentpanelocation="top"] #attachmentBucket > .attachmentItem {
+  width: -moz-available;
+}
+
+#attachmentArea.collapsed-by-splitter,
+#attachmentSplitter.splitter-collapsed,
+#attachmentSplitter.splitter-collapsed + #attachmentArea {
   display: none;
 }
 
 /* :::: primary toolbar buttons :::: */
 
 #button-send {
   list-style-image: var(--icon-sent);
 }
@@ -1085,22 +1185,16 @@ toolbarbutton.formatting-button[disabled
   color: var(--selected-item-text-color);
   background-color: var(--selected-item-color);
 }
 
 .address-pill[selected]:not(.editing) .pill-indicator {
   fill: var(--selected-item-color);
 }
 
-#MsgHeadersToolbar {
-  display: grid;
-  grid-template-rows: min-content minmax(0, min-content) min-content;
-  grid-template-columns: auto;
-}
-
 .address-identity-recipient {
   margin-inline-end: 8px;
   display: flex;
 }
 
 .recipient-button {
   white-space: nowrap;
   text-align: start;
diff --git a/mail/themes/windows/mail/compose/messengercompose.css b/mail/themes/windows/mail/compose/messengercompose.css
--- a/mail/themes/windows/mail/compose/messengercompose.css
+++ b/mail/themes/windows/mail/compose/messengercompose.css
@@ -45,17 +45,17 @@
 
 #MsgHeadersToolbar {
   color: -moz-DialogText;
   text-shadow: none;
   padding-block: 4px 2px;
 }
 
 #subjectLabel {
-  margin-bottom: 0;
+  margin-bottom: 3px;
 }
 
 @media (-moz-windows-classic) {
   :root:not(:-moz-lwtheme) .autocomplete-richlistitem {
     --arrowpanel-dimmed: Highlight;
   }
 }
 
@@ -117,16 +117,20 @@
 
 @media (prefers-contrast) {
   #msgIdentity::part(label-box) {
     background-color: transparent !important;
     color: inherit !important;
   }
 }
 
+#msgIdentity {
+  margin-block: 1px;
+}
+
 #msgIdentity::part(text-input) {
   background-color: inherit;
   color: inherit;
   margin-block: 2px;
 }
 
 .address-label-container {
   padding-top: 5px;
