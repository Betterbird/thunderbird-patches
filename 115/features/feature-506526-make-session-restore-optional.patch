# HG changeset patch
# User alta88@fixall.com
# Date 1709828380 -3600
# Parent  7a500ed423ae81de587e898a1134159afa836c83
Bug 506526 - there should be a pref to turn off session restore
Make tabs session restore optional.

Authored by Alta88 and contributed to the Betterbird Project.
See https://github.com/Betterbird/thunderbird-patches/blob/main/LICENSE for license details.
All uses require attribution to the Author.

diff --git a/mail/app/profile/all-thunderbird.js b/mail/app/profile/all-thunderbird.js
--- a/mail/app/profile/all-thunderbird.js
+++ b/mail/app/profile/all-thunderbird.js
@@ -573,8 +573,11 @@ pref("mail.tabs.alwaysShowCloseButton", 
 
 // Allow the tabs to be in the titlebar on supported systems
 pref("mail.tabs.drawInTitlebar", true);
 
+// Save and restore the tabs session on startup.
+pref("mail.tabs.restoreSession", true);
+
 // The breakpad report server to link to in about:crashes
 pref("breakpad.reportURL", "https://crash-stats.mozilla.com/report/index/");
 
 // OS Integrated Search and Indexing
diff --git a/mail/base/content/messenger.js b/mail/base/content/messenger.js
--- a/mail/base/content/messenger.js
+++ b/mail/base/content/messenger.js
@@ -734,11 +734,20 @@ function HandleAppCommandEvent(evt) {
 
 /**
  * Called by the session store manager periodically and at shutdown to get
  * the state of this window for persistence.
+ *
+ * @param {boolean} shutdown - If true, called from the unload handler and the
+ *   last 3pane window is being closed.
  */
-function getWindowStateForSessionPersistence() {
+function getWindowStateForSessionPersistence(shutdown = false) {
   let tabmail = document.getElementById("tabmail");
+  if (shutdown && !Services.prefs.getBoolPref("mail.tabs.restoreSession")) {
+    // Only restore the special firstTab, always at 0.
+    let firstTab = tabmail.tabInfo.find(t => t.first);
+    tabmail.tabInfo = firstTab ? [firstTab] : [];
+  }
+
   let tabsState = tabmail.persistTabs();
   return { type: "3pane", tabs: tabsState };
 }
 
diff --git a/mail/components/preferences/general.inc.xhtml b/mail/components/preferences/general.inc.xhtml
--- a/mail/components/preferences/general.inc.xhtml
+++ b/mail/components/preferences/general.inc.xhtml
@@ -139,8 +139,15 @@
         <spacer flex="1"/>
       </hbox>
       <hbox>
         <vbox>
+          <checkbox id="restoreTabs"
+                    data-l10n-id="restore-tabs-session-label"
+                    preference="mail.tabs.restoreSession"/>
+        </vbox>
+        <spacer flex="1"/>
+      </hbox>      <hbox>
+        <vbox>
           <checkbox id="autoHideTabbar"
                     data-l10n-id="auto-hide-tabbar-label"
                     preference="mail.tabs.autoHide"/>
           <description data-l10n-id="auto-hide-tabbar-description"
diff --git a/mail/components/preferences/general.js b/mail/components/preferences/general.js
--- a/mail/components/preferences/general.js
+++ b/mail/components/preferences/general.js
@@ -93,8 +93,9 @@ Preferences.addAll([
   { id: "searchintegration.enable", type: "bool" },
   { id: "mail.tabs.drawInTitlebar", type: "bool" },
   { id: "mail.tabs.autoHide", type: "bool" },
   { id: "mail.tabs.vertical", type: "bool" },
+  { id: "mail.tabs.restoreSession", type: "bool" },
   { id: "mailnews.attachments.display.top", type: "bool" },
 ]);
 if (AppConstants.platform == "win" || AppConstants.platform == "linux") {
   Preferences.add({ id: "mail.minimizeToTray", type: "bool" });
diff --git a/mail/locales/en-US/messenger/preferences/preferences.ftl b/mail/locales/en-US/messenger/preferences/preferences.ftl
--- a/mail/locales/en-US/messenger/preferences/preferences.ftl
+++ b/mail/locales/en-US/messenger/preferences/preferences.ftl
@@ -271,8 +271,12 @@ window-layout-legend = Window Layout
 draw-in-titlebar-label =
     .label = Hide system window titlebar
     .accesskey = H
 
+restore-tabs-session-label =
+    .label = Open previous tabs
+    .accesskey = b
+
 auto-hide-tabbar-label =
     .label = Auto hide tab bar
     .accesskey = A
 auto-hide-tabbar-description = Hide the tab bar when only a single tab is open
diff --git a/mail/modules/SessionStoreManager.jsm b/mail/modules/SessionStoreManager.jsm
--- a/mail/modules/SessionStoreManager.jsm
+++ b/mail/modules/SessionStoreManager.jsm
@@ -260,9 +260,9 @@ var SessionStoreManager = {
         // event is observed AFTER this.
         this.stopPeriodicSave();
 
         let state = this._createStateObject();
-        state.windows.push(aWindow.getWindowStateForSessionPersistence());
+        state.windows.push(aWindow.getWindowStateForSessionPersistence(true));
         this._saveStateObject(state);
 
         // XXX this is to ensure we don't clobber the saved state when we
         // observe the "quit-application-granted" event.
