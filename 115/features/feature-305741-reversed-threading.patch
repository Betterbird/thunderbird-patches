# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1722071879 -7200
# Parent  0a533ad7923452a0ef6252d39db01eca422bdab6
Feature: Reversed threading (bug 305741).

diff --git a/mail/base/content/about3Pane.js b/mail/base/content/about3Pane.js
--- a/mail/base/content/about3Pane.js
+++ b/mail/base/content/about3Pane.js
@@ -7481,18 +7481,18 @@ customElements.whenDefined("tree-view-ta
       let getServerInfo = !gViewWrapper.isSingleFolder;
       let properties = {};
       let threadLevel = {};
       let numChildren = {};
-      let hasNextSibling = {};
+      let hasNoSibling = {};
       let serverKey = {};
       let cellTexts = this.view.cellDataForColumns(
         index,
         textColumns,
         properties,
         threadLevel,
         threadedDisplay, // no need to get the following two for a non-threaded display
         numChildren,
-        hasNextSibling,
+        hasNoSibling,
         getServerInfo,
         serverKey
       );
       const propertiesSet = new Set(properties.value.split(" "));
@@ -7519,10 +7519,14 @@ customElements.whenDefined("tree-view-ta
         } else {
           elementToColor.style.backgroundColor = "";
         }
       }
+      if (gViewWrapper.reversedThreading) {
+        properties.value += " thread-reversed";
+      }
       this.classList.toggle("singleton", numChildren.value <= 1);
-      this.classList.toggle("lastchild", !hasNextSibling.value);
+      this.classList.toggle("lastchild", hasNoSibling.value == 1);
+      this.classList.toggle("firstchild", hasNoSibling.value == -1);
 
       // Collect the various strings and fluent IDs to build the full string for
       // the message row aria-label.
       let ariaLabelPromises = [];
@@ -7798,8 +7802,11 @@ customElements.whenDefined("tree-view-ta
       );
       if (threadLevel.value) {
         properties.value += " thread-children";
       }
+      if (gViewWrapper.reversedThreading) {
+        properties.value += " thread-reversed";
+      }
       const propertiesSet = new Set(properties.value.split(" "));
       const isDummyRow = propertiesSet.has("dummy");
 
       if (threadPane.fullRowColor) {
diff --git a/mail/modules/DBViewWrapper.jsm b/mail/modules/DBViewWrapper.jsm
--- a/mail/modules/DBViewWrapper.jsm
+++ b/mail/modules/DBViewWrapper.jsm
@@ -485,10 +485,22 @@ function DBViewWrapper(aListener) {
   this.search = null;
 
   this._folderLoading = false;
   this._searching = false;
+
+  this._reversedThreading = false;
 }
 DBViewWrapper.prototype = {
+  get reversedThreading() {
+    return this._reversedThreading;
+  },
+  refreshReversedThreading(sortType, sortOrder) {
+    this._reversedThreading =
+      sortType == Ci.nsMsgViewSortType.byDate &&
+      sortOrder == Ci.nsMsgViewSortOrder.descending &&
+      Services.prefs.getBoolPref("mailnews.reversed_threading", false);
+  },
+
   /* = constants explaining the nature of the underlying data = */
   /**
    * We currently don't have any underlying data.
    */
@@ -1154,8 +1166,9 @@ DBViewWrapper.prototype = {
         dbView.viewFolder = this.displayedFolder;
       }
 
       // Open the folder.
+      this.refreshReversedThreading(sortType, sortOrder);
       dbView.open(
         this._underlyingFolders[0],
         sortType,
         sortOrder,
@@ -1708,8 +1721,9 @@ DBViewWrapper.prototype = {
         let [sortType, sortOrder, sortCustomCol] = this._getSortDetails(iSort);
         if (sortCustomCol) {
           this.dbView.curCustomColumn = sortCustomCol;
         }
+        this.refreshReversedThreading(sortType, sortOrder);
         this.dbView.sort(sortType, sortOrder);
       }
       // (only generate the event since we're not in a update batch)
       this.listener.onSortChanged();
@@ -1764,8 +1778,9 @@ DBViewWrapper.prototype = {
       if (sortCustomCol) {
         this.dbView.curCustomColumn = sortCustomCol;
       }
       // apply the sort to see what happens secondary-wise
+      this.refreshReversedThreading(sortType, sortOrder);
       this.dbView.sort(sortType, sortOrder);
       // there is only a secondary sort if it's not none and not the same.
       if (
         this.dbView.secondarySortType != Ci.nsMsgViewSortType.byNone &&
diff --git a/mail/themes/shared/jar.inc.mn b/mail/themes/shared/jar.inc.mn
--- a/mail/themes/shared/jar.inc.mn
+++ b/mail/themes/shared/jar.inc.mn
@@ -215,8 +215,9 @@
   skin/classic/messenger/icons/file-item.svg                  (../shared/mail/icons/file-item.svg)
   skin/classic/messenger/icons/filter.svg                     (../shared/mail/icons/filter.svg)
   skin/classic/messenger/icons/search-row-more.svg            (../shared/mail/icons/search-row-more.svg)
   skin/classic/messenger/icons/search-row-end.svg             (../shared/mail/icons/search-row-end.svg)
+  skin/classic/messenger/icons/search-row-end-reversed.svg    (../shared/mail/icons/search-row-end-reversed.svg)
   skin/classic/messenger/icons/fingerprint.svg                (../shared/mail/icons/fingerprint.svg)
   skin/classic/messenger/icons/flag-col.svg                   (../shared/mail/icons/flag-col.svg)
   skin/classic/messenger/icons/flagged.svg                    (../shared/mail/icons/flagged.svg)
   skin/classic/messenger/icons/folder.svg                     (../shared/mail/icons/folder.svg)
diff --git a/mail/themes/shared/mail/icons/search-row-end-reversed.svg b/mail/themes/shared/mail/icons/search-row-end-reversed.svg
new file mode 100644
--- /dev/null
+++ b/mail/themes/shared/mail/icons/search-row-end-reversed.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="8" height="24" fill="context-fill" fill-opacity="context-fill-opacity" viewBox="0 0 8 24">
+  <path d="M 0,24 h 1 v -12 h 7 v -1 h -8 Z"/>
+</svg>
diff --git a/mail/themes/shared/mail/threadPane.css b/mail/themes/shared/mail/threadPane.css
--- a/mail/themes/shared/mail/threadPane.css
+++ b/mail/themes/shared/mail/threadPane.css
@@ -489,8 +489,11 @@ tr[is="thread-row"]:not(.children):not(.
 }
 tr[is="thread-row"]:not(.children):not(.singleton).lastchild .subject-line {
   background-image: url("chrome://messenger/skin/icons/search-row-end.svg");
 }
+tr[is="thread-row"]:not(.children):not(.singleton).firstchild .subject-line {
+  background-image: url("chrome://messenger/skin/icons/search-row-end-reversed.svg");
+}
 
 tr[is="thread-card"] .state {
   display: none;
 }
@@ -585,16 +588,28 @@ tr:is([is="thread-row"], [is="thread-car
   content: var(--icon-nav-down-sm);
   margin: 1px;
 }
 
+tr:is([is="thread-row"], [is="thread-card"])[data-properties~="thread-reversed"] .twisty-icon {
+  content: var(--icon-nav-up-sm);
+}
+
 tr:is([is="thread-row"], [is="thread-card"]).children.collapsed .twisty-icon {
   transform: rotate(-90deg);
 }
 
 tr:is([is="thread-row"], [is="thread-card"]).children.collapsed:dir(rtl) .twisty-icon {
   transform: rotate(90deg);
 }
 
+tr:is([is="thread-row"], [is="thread-card"])[data-properties~="thread-reversed"].children.collapsed .twisty-icon {
+  transform: rotate(90deg);
+}
+
+tr:is([is="thread-row"], [is="thread-card"])[data-properties~="thread-reversed"].children.collapsed:dir(rtl) .twisty-icon {
+  transform: rotate(-90deg);
+}
+
 @media (prefers-reduced-motion: no-preference) {
   tr:is([is="thread-row"], [is="thread-card"]) .twisty-icon {
     transition: transform 200ms ease;
   }
diff --git a/mailnews/base/public/nsIMsgDBView.idl b/mailnews/base/public/nsIMsgDBView.idl
--- a/mailnews/base/public/nsIMsgDBView.idl
+++ b/mailnews/base/public/nsIMsgDBView.idl
@@ -495,9 +495,9 @@ interface nsIMsgDBView : nsISupports
    * @param aProperties - The properties of the row.
    * @param aThreadLevel - The thread level of the row.
    * @param aGetChildrenInfo - if false, return dummy values for aNumChildren and aHasNextSibling.
    * @param aNumChildren - The number of children of the row.
-   * @param aHasNextSibling - Whether the row has a next sibling.
+   * @param aHasNoSibling - Whether the row has a next sibling: 0: Has sibling, 1: No next sibling, -1: No previous sibling (reversed threading).
    * @param aGetServerInfo - if false, return dummy value for aServerKey.
    * @param aServerKey - Key of the server belonging to the folder.
    *
    * @returns The cell text for the columns in `aColumnNames`.
@@ -507,9 +507,9 @@ interface nsIMsgDBView : nsISupports
                                     out AString aProperties,
                                     out long aThreadLevel,
                                     in boolean getChildrenInfo,
                                     out unsigned long aNumChildren,
-                                    out boolean aHasNextSibling,
+                                    out long aHasNoSibling,
                                     in boolean aGetServerInfo,
                                     out ACString aServerKey);
 };
 
diff --git a/mailnews/base/src/nsMsgDBView.cpp b/mailnews/base/src/nsMsgDBView.cpp
--- a/mailnews/base/src/nsMsgDBView.cpp
+++ b/mailnews/base/src/nsMsgDBView.cpp
@@ -1983,9 +1983,9 @@ NS_IMETHODIMP
 nsMsgDBView::CellDataForColumns(int32_t aRow,
                                 const nsTArray<nsString>& aColumnNames,
                                 nsAString& aProperties, int32_t* aThreadLevel,
                                 bool aGetChildrenInfo, uint32_t* aNumChildren,
-                                bool* aHasNextSibling, bool aGetServerInfo,
+                                int32_t* aHasNoSibling, bool aGetServerInfo,
                                 nsACString& aServerKey,
                                 nsTArray<nsString>& _retval) {
   nsresult rv;
   _retval.Clear();
@@ -2001,13 +2001,32 @@ nsMsgDBView::CellDataForColumns(int32_t 
     }
     _retval.AppendElement(text);
   }
 
-  *aHasNextSibling = false;
+  *aHasNoSibling = 0;
   *aNumChildren = 0;
   if (aGetChildrenInfo) {
-    // The following call (so far) doesn't fail.
-    HasNextSibling(aRow, aRow, aHasNextSibling);
+    if (ReversedThreading()) {
+      // Check previous sibling.
+      int32_t rowIndexLevel;
+      bool hasPreviousSibling = false;
+      GetLevel(aRow, &rowIndexLevel);
+      for (int32_t i = aRow - 1; i >= 0; i--) {
+        int32_t l;
+        GetLevel(i, &l);
+        if (l < rowIndexLevel) break;
+        if (l == rowIndexLevel) {
+          hasPreviousSibling = true;
+          break;
+        }
+      }
+      if (!hasPreviousSibling) *aHasNoSibling = -1;
+    } else {
+      // The following call (so far) doesn't fail.
+      bool hasNextSibling;
+      HasNextSibling(aRow, aRow, &hasNextSibling);
+      if (!hasNextSibling) *aHasNoSibling = 1;
+    }
 
     nsCOMPtr<nsIMsgThread> thread;
     rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));
     if (NS_SUCCEEDED(rv) && thread) {
@@ -2153,8 +2172,10 @@ nsMsgDBView::CycleCell(int32_t row, nsTr
 NS_IMETHODIMP
 nsMsgDBView::Open(nsIMsgFolder* folder, nsMsgViewSortTypeValue sortType,
                   nsMsgViewSortOrderValue sortOrder,
                   nsMsgViewFlagsTypeValue viewFlags, int32_t* pCount) {
+  mReversedThreading =
+      mozilla::Preferences::GetBool("mailnews.reversed_threading", false);
   m_viewFlags = viewFlags;
   m_sortOrder = sortOrder;
   m_sortType = sortType;
 
@@ -4700,16 +4721,28 @@ nsresult nsMsgDBView::GetThreadCount(nsM
 // index of the first message in the thread.
 int32_t nsMsgDBView::CountExpandedThread(nsMsgViewIndex index) {
   int32_t numInThread = 0;
   nsMsgViewIndex startOfThread = index;
-  while ((int32_t)startOfThread >= 0 && m_levels[startOfThread] != 0)
-    startOfThread--;
-
-  nsMsgViewIndex threadIndex = startOfThread;
-  do {
-    threadIndex++;
-    numInThread++;
-  } while (threadIndex < m_levels.Length() && m_levels[threadIndex] != 0);
+  if (ReversedThreading()) {
+    while ((uint32_t)startOfThread < m_levels.Length() &&
+           m_levels[startOfThread] != 0)
+      startOfThread++;
+
+    int32_t threadIndex = startOfThread;
+    do {
+      threadIndex--;
+      numInThread++;
+    } while (threadIndex >= 0 && m_levels[threadIndex] != 0);
+  } else {
+    while ((int32_t)startOfThread >= 0 && m_levels[startOfThread] != 0)
+      startOfThread--;
+
+    nsMsgViewIndex threadIndex = startOfThread;
+    do {
+      threadIndex++;
+      numInThread++;
+    } while (threadIndex < m_levels.Length() && m_levels[threadIndex] != 0);
+  }
 
   return numInThread;
 }
 
@@ -4891,26 +4924,49 @@ nsresult nsMsgDBView::ExpandByIndex(nsMs
   } else {
     rv = ListIdsInThread(pThread, index, &numExpanded);
   }
 
-  m_flags[index] = flags;
-  NoteChange(index, 1, nsMsgViewNotificationCode::changed);
-
-  NoteChange(index + 1, numExpanded, nsMsgViewNotificationCode::insertOrDelete);
+  if (ReversedThreading()) {
+    m_flags[index + numExpanded] = flags;
+    ClearHdrCache();
+    NoteChange(index, 1, nsMsgViewNotificationCode::changed);
+    NoteChange(index + numExpanded, 1, nsMsgViewNotificationCode::changed);
+    NoteChange(index, numExpanded, nsMsgViewNotificationCode::insertOrDelete);
+    bool container;
+    IsContainer(index + numExpanded, &container);
+    IsContainer(index, &container);
+  } else {
+    m_flags[index] = flags;
+    NoteChange(index, 1, nsMsgViewNotificationCode::changed);
+    NoteChange(index + 1, numExpanded,
+               nsMsgViewNotificationCode::insertOrDelete);
+  }
 
   if (pNumExpanded != nullptr) *pNumExpanded = numExpanded;
 
   return rv;
 }
 
 nsresult nsMsgDBView::CollapseAll() {
   if (mJSTree) mJSTree->BeginUpdateBatch();
-  for (uint32_t i = 0; i < GetSize(); i++) {
-    uint32_t numExpanded;
-    uint32_t flags = m_flags[i];
-    if (!(flags & nsMsgMessageFlags::Elided) &&
-        (flags & MSG_VIEW_FLAG_HASCHILDREN))
-      CollapseByIndex(i, &numExpanded);
+  if (ReversedThreading()) {
+    int32_t i = GetSize() - 1;
+    while (i >= 0) {
+      uint32_t numExpanded = 0;
+      uint32_t flags = m_flags[i];
+      if (!(flags & nsMsgMessageFlags::Elided) &&
+          (flags & MSG_VIEW_FLAG_HASCHILDREN))
+        CollapseByIndex(i, &numExpanded);
+      i -= numExpanded + 1;
+    }
+  } else {
+    for (uint32_t i = 0; i < GetSize(); i++) {
+      uint32_t numExpanded;
+      uint32_t flags = m_flags[i];
+      if (!(flags & nsMsgMessageFlags::Elided) &&
+          (flags & MSG_VIEW_FLAG_HASCHILDREN))
+        CollapseByIndex(i, &numExpanded);
+    }
   }
 
   if (mJSTree) mJSTree->EndUpdateBatch();
   SelectionChangedXPCOM();
@@ -4936,24 +4992,36 @@ nsresult nsMsgDBView::CollapseByIndex(ns
 
   flags |= nsMsgMessageFlags::Elided;
 
   m_flags[index] = flags;
-  NoteChange(index, 1, nsMsgViewNotificationCode::changed);
-
-  // Don't count first header in thread.
   int32_t numRemoved = -rowDelta;
-  if (index + 1 + numRemoved > m_keys.Length()) {
-    NS_ERROR("trying to remove too many rows");
-    numRemoved -= (index + 1 + numRemoved) - m_keys.Length();
-    if (numRemoved <= 0) return NS_MSG_MESSAGE_NOT_FOUND;
-  }
-
-  // Start at first id after thread.
-  RemoveRows(index + 1, numRemoved);
+
+  if (ReversedThreading()) {
+    // Remove rows above `index`.
+    if (index < (nsMsgViewIndex)numRemoved) {
+      NS_ERROR("trying to remove too many rows");
+      numRemoved = index;
+      if (numRemoved <= 0) return NS_MSG_MESSAGE_NOT_FOUND;
+    }
+    NoteChange(index, 1, nsMsgViewNotificationCode::changed);
+    RemoveRows(index - numRemoved, numRemoved);
+    NoteChange(index - numRemoved, rowDelta,
+               nsMsgViewNotificationCode::insertOrDelete);
+  } else {
+    // Remove rows below `index`.
+    // Don't count first header in thread.
+    if (index + 1 + numRemoved > m_keys.Length()) {
+      NS_ERROR("trying to remove too many rows");
+      numRemoved -= (index + 1 + numRemoved) - m_keys.Length();
+      if (numRemoved <= 0) return NS_MSG_MESSAGE_NOT_FOUND;
+    }
+    // Start at first id after thread.
+    NoteChange(index, 1, nsMsgViewNotificationCode::changed);
+    RemoveRows(index + 1, numRemoved);
+    NoteChange(index + 1, rowDelta, nsMsgViewNotificationCode::insertOrDelete);
+  }
+
   if (pNumCollapsed != nullptr) *pNumCollapsed = numRemoved;
-
-  NoteChange(index + 1, rowDelta, nsMsgViewNotificationCode::insertOrDelete);
-
   return rv;
 }
 
 nsresult nsMsgDBView::OnNewHeader(nsIMsgDBHdr* newHdr, nsMsgKey aParentKey,
@@ -5297,8 +5365,9 @@ nsMsgViewIndex nsMsgDBView::FindParentIn
 nsresult nsMsgDBView::ListIdsInThreadOrder(nsIMsgThread* threadHdr,
                                            nsMsgKey parentKey, uint32_t level,
                                            nsMsgViewIndex* viewIndex,
                                            uint32_t* pNumListed) {
+  nsMsgViewIndex viewIndexStart = *viewIndex;
   nsCOMPtr<nsIMsgEnumerator> msgEnumerator;
   nsresult rv =
       threadHdr->EnumerateMessages(parentKey, getter_AddRefs(msgEnumerator));
   NS_ENSURE_SUCCESS(rv, rv);
@@ -5350,8 +5419,28 @@ nsresult nsMsgDBView::ListIdsInThreadOrd
     rv = ListIdsInThreadOrder(threadHdr, msgKey, level + 1, viewIndex,
                               pNumListed);
     NS_ENSURE_SUCCESS(rv, rv);
   }
+
+  if (ReversedThreading() && level == 1) {
+    // Reverse everything we added, and the one before.
+    nsMsgViewIndex i = viewIndexStart - 1;
+    nsMsgViewIndex j = *viewIndex - 1;
+
+#define swap(type, var) \
+  {                     \
+    type val = var[i];  \
+    var[i] = var[j];    \
+    var[j] = val;       \
+  }
+    while (i < j) {
+      swap(nsMsgKey, m_keys);
+      swap(uint32_t, m_flags);
+      swap(uint8_t, m_levels);
+      i++;
+      j--;
+    }
+  }
   return NS_OK;
 }
 
 void nsMsgDBView::InsertEmptyRows(nsMsgViewIndex viewIndex, int32_t numRows) {
diff --git a/mailnews/base/src/nsMsgDBView.h b/mailnews/base/src/nsMsgDBView.h
--- a/mailnews/base/src/nsMsgDBView.h
+++ b/mailnews/base/src/nsMsgDBView.h
@@ -521,8 +521,17 @@ class nsMsgDBView : public nsIMsgDBView,
   void InitEntryInfoForIndex(nsMsgViewIndex i, IdKey& EntryInfo);
   void ValidateSort();
 #endif
 
+  bool mReversedThreading;
+  inline bool ReversedThreading() {
+    return mReversedThreading &&
+           m_viewFlags & nsMsgViewFlagsType::kThreadedDisplay &&
+           !(m_viewFlags & nsMsgViewFlagsType::kGroupBySort) &&
+           m_sortType == nsMsgViewSortType::byDate &&
+           m_sortOrder == nsMsgViewSortOrder::descending;
+  }
+
  protected:
   static nsresult InitDisplayFormats();
 
  private:
diff --git a/mailnews/base/src/nsMsgThreadedDBView.cpp b/mailnews/base/src/nsMsgThreadedDBView.cpp
--- a/mailnews/base/src/nsMsgThreadedDBView.cpp
+++ b/mailnews/base/src/nsMsgThreadedDBView.cpp
@@ -235,10 +235,15 @@ nsresult nsMsgThreadedDBView::SortThread
       uint32_t numExpanded;
       m_flags[j] = flags | nsMsgMessageFlags::Elided;
       ExpandByIndex(j, &numExpanded);
       j += numExpanded;
-      if (numExpanded > 0)
-        m_flags[j - numExpanded] = flags | MSG_VIEW_FLAG_HASCHILDREN;
+      if (numExpanded > 0) {
+        if (ReversedThreading()) {
+          m_flags[j] = flags | MSG_VIEW_FLAG_HASCHILDREN;
+        } else {
+          m_flags[j - numExpanded] = flags | MSG_VIEW_FLAG_HASCHILDREN;
+        }
+      }
     } else if (flags & MSG_VIEW_FLAG_ISTHREAD &&
                !(flags & MSG_VIEW_FLAG_HASCHILDREN)) {
       nsCOMPtr<nsIMsgDBHdr> msgHdr;
       nsCOMPtr<nsIMsgThread> pThread;
diff --git a/mailnews/mailnews.js b/mailnews/mailnews.js
--- a/mailnews/mailnews.js
+++ b/mailnews/mailnews.js
@@ -100,8 +100,11 @@ pref("mailnews.default_news_sort_type", 
 // threaded mode should be based on the newest message in the thread, or on
 // the thread root
 pref("mailnews.sort_threads_by_root", false);
 
+// Reversed threading when ordered by date descending.
+pref("mailnews.reversed_threading", false);
+
 // default view flags for new folders
 // both flags are int values reflecting nsMsgViewFlagsType values
 // as defined in nsIMsgDBView.idl (kNone = 0, kThreadedDisplay = 1 etc.)
 
