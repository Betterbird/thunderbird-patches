
# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1694766402 -7200
# Node ID f885fa57a27efca1ed455fa29c9522ad65d8cc84
# Parent  881219086a0e08aee6d0152ef7c683fd8541005e
Bug 1831764 - Restore invalidating the thread tree when setting the subject in PGP code. r=mkmelin


Based on https://github.com/Betterbird/thunderbird-patches/blob/main/115/bugs/1843833-fix-subject-pgp.patch

Differential Revision: https://phabricator.services.mozilla.com/D187903

diff --git a/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js b/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js
--- a/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js
+++ b/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js
@@ -752,19 +752,27 @@ Enigmail.hdrView = {
     let newSubject = subject.replace(
       new RegExp(`^(${prefixes.join(": |")}: )+`, "i"),
       ""
     );
     let hadRe = newSubject != subject;
 
     // Update the message.
     gMessage.subject = newSubject;
+    let oldFlags = gMessage.flags;
     if (hadRe) {
       gMessage.flags |= Ci.nsMsgMessageFlags.HasRe;
     }
+    // This even works if the flags haven't changed. Causes repaint in all thread trees.
+    gMessage.folder?.msgDatabase.notifyHdrChangeAll(
+      gMessage,
+      oldFlags,
+      gMessage.flags,
+      {}
+    );
   },
 
   updateHdrBox(header, value) {
     let e = document.getElementById("expanded" + header + "Box");
     if (e) {
       e.headerValue = value;
     }
   },
