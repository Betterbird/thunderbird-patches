# HG changeset patch
# User Mike Kaganski <mikekaganski@gmail.com>
# Date 1707952070 -3600
# Parent  1a5081616e81de61f694644a72949f900047eed2
Bug 557708 - Prefer DropFile* to DropImage for CF_HDROP.

diff --git a/widget/windows/nsDataObj.cpp b/widget/windows/nsDataObj.cpp
--- a/widget/windows/nsDataObj.cpp
+++ b/widget/windows/nsDataObj.cpp
@@ -1553,30 +1553,26 @@ HRESULT nsDataObj::GetText(const nsACStr
   // text/plain data)
   free(data);
 
   return S_OK;
 }
 
 //-----------------------------------------------------
 HRESULT nsDataObj::GetFile(FORMATETC& aFE, STGMEDIUM& aSTG) {
-  uint32_t dfInx = 0;
-  ULONG count;
-  FORMATETC fe;
-  m_enumFE->Reset();
-  while (NOERROR == m_enumFE->Next(1, &fe, &count) &&
-         dfInx < mDataFlavors.Length()) {
-    if (mDataFlavors[dfInx].EqualsLiteral(kNativeImageMime))
-      return DropImage(aFE, aSTG);
-    if (mDataFlavors[dfInx].EqualsLiteral(kFileMime))
-      return DropFile(aFE, aSTG);
-    if (mDataFlavors[dfInx].EqualsLiteral(kFilePromiseMime))
-      return DropTempFile(aFE, aSTG);
-    dfInx++;
+  bool bNativeImageFound = false;
+  for (const auto& flavor : mDataFlavors) {
+    if (flavor.EqualsLiteral(kFileMime)) return DropFile(aFE, aSTG);
+    if (flavor.EqualsLiteral(kFilePromiseMime)) return DropTempFile(aFE, aSTG);
+    // DropImage changes image type to BMP unconditionally, only use as fallback
+    if (!bNativeImageFound && flavor.EqualsLiteral(kNativeImageMime))
+      bNativeImageFound = true;
   }
+
+  if (bNativeImageFound) return DropImage(aFE, aSTG);
   return E_FAIL;
 }
 
 HRESULT nsDataObj::DropFile(FORMATETC& aFE, STGMEDIUM& aSTG) {
   nsresult rv;
   nsCOMPtr<nsISupports> genericDataWrapper;
 
   if (NS_FAILED(mTransferable->GetTransferData(
