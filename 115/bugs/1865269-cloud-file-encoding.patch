# HG changeset patch
# User John Bieling <john@thunderbird.net>
# Date 1701014959 -3600
# Node ID 2fcd280a8d7aee8ea7858e120608e06ef9ff9775
# Parent  57c0fd6474ec2fa32f41da17a846abd8faea3198
Bug 1865269 - Fix encoding of HTML file of cloudFile attachments. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D194617

diff --git a/mailnews/compose/src/MimeMessage.jsm b/mailnews/compose/src/MimeMessage.jsm
--- a/mailnews/compose/src/MimeMessage.jsm
+++ b/mailnews/compose/src/MimeMessage.jsm
@@ -431,17 +431,20 @@ class MimeMessage {
     let attachments = [...this._compFields.attachments];
     let cloudParts = [];
     let localParts = [];
 
     for (let attachment of attachments) {
       let part;
       if (attachment.htmlAnnotation) {
         part = new MimePart();
-        part.bodyText = attachment.htmlAnnotation;
+        // MimePart.bodyText should be binary string.
+        part.bodyText = jsmime.mimeutils.typedArrayToString(
+          new TextEncoder().encode(attachment.htmlAnnotation)
+        );
         part.setHeader("content-type", "text/html; charset=utf-8");
 
         let suffix = /\.html$/i.test(attachment.name) ? "" : ".html";
         let encodedFilename = MsgUtils.rfc2231ParamFolding(
           "filename",
           `${attachment.name}${suffix}`
         );
         part.setHeader("content-disposition", `attachment; ${encodedFilename}`);
