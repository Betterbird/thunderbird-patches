# HG changeset patch
# User Geoff Lankow <geoff@darktrojan.net>
# Date 1690652887 -7200
# Node ID b8e718c254f54643c51d44f194d8cb8634a3ce90
# Parent  59294d3abb60d8692db52a140e221ece5d12a00d
Bug 1844534 - In the folder tree, update the unread count of collapsed rows when a change occurs. r=aleca

Differential Revision: https://phabricator.services.mozilla.com/D184652

diff --git a/mail/base/content/about3Pane.js b/mail/base/content/about3Pane.js
--- a/mail/base/content/about3Pane.js
+++ b/mail/base/content/about3Pane.js
@@ -2332,17 +2332,31 @@ var folderPane = {
 
   /**
    * Called when a folder's unread count changes, to update the UI.
    *
    * @param {nsIMsgFolder} folder
    * @param {integer} newValue
    */
   changeUnreadCount(folder, newValue) {
-    this._changeRows(folder, row => (row.unreadCount = newValue));
+    this._changeRows(folder, row => {
+      // Find the nearest visible ancestor and update it.
+      let collapsedAncestor = row.parentNode.closest("li.collapsed");
+      while (collapsedAncestor) {
+        let next = collapsedAncestor.parentNode.closest("li.collapsed");
+        if (!next) {
+          collapsedAncestor.updateUnreadMessageCount();
+          break;
+        }
+        collapsedAncestor = next;
+      }
+
+      // Update the row itself.
+      row.unreadCount = newValue;
+    });
 
     if (this._modes.unread.active && !folder.server.hidden) {
       this._modes.unread.changeUnreadCount(folder, newValue);
     }
     threadPaneHeader.updateStatusBar();
   },
 
   /**
