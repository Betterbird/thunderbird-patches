# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1704572434 -3600
# Node ID 16e112833b0fe6fc73929a890c69c65d8a9897e0
# Parent  f94564bf5455e20259dd0ae6713be1c056e9ce4c
Bug 1799362 - Update details pane after removing members from a mailing list. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D196686

diff --git a/mail/components/addrbook/content/aboutAddressBook.js b/mail/components/addrbook/content/aboutAddressBook.js
--- a/mail/components/addrbook/content/aboutAddressBook.js
+++ b/mail/components/addrbook/content/aboutAddressBook.js
@@ -2450,16 +2450,17 @@ var detailsPane = {
   dirtyFields: new Set(),
 
   _notifications: [
     "addrbook-contact-created",
     "addrbook-contact-updated",
     "addrbook-contact-deleted",
     "addrbook-list-updated",
     "addrbook-list-deleted",
+    "addrbook-list-member-removed",
   ],
 
   init() {
     let booksSplitter = document.getElementById("booksSplitter");
     let booksSplitterWidth = Services.xulStore.getValue(
       cardsPane.URL,
       "booksSplitter",
       "width"
@@ -2729,40 +2730,42 @@ var detailsPane = {
         // editing interface with the changes, which is difficult, or alert
         // the user. For now, changes will be overwritten if the edit is saved.
 
         if (!this.isEditing) {
           this.displayContact(subject);
         }
         break;
       case "addrbook-contact-deleted":
+      case "addrbook-list-member-removed":
         subject.QueryInterface(Ci.nsIAbCard);
         updateAddressBookCount();
 
-        if (
-          this.currentCard?.directoryUID == data &&
-          this.currentCard.equals(subject)
-        ) {
+        let directoryUID =
+          topic == "addrbook-contact-deleted"
+            ? this.currentCard?.directoryUID
+            : cardsPane.cardsList.view.directory?.UID;
+        if (directoryUID == data && this.currentCard?.equals(subject)) {
           // The card being displayed was deleted.
           this.isEditing = false;
           this.displayCards();
 
           if (hadFocus) {
             // Ensure this happens *after* the view handles this notification.
             Services.tm.dispatchToMainThread(() => {
               if (cardsPane.cardsList.view.rowCount == 0) {
                 cardsPane.searchInput.focus();
               } else {
                 cardsPane.cardsList.table.body.focus();
               }
             });
           }
         } else if (!this.selectedCardsSection.hidden) {
           for (let li of this.selectedCardsSection.querySelectorAll("li")) {
-            if (li._card.directoryUID == data && li._card.equals(subject)) {
+            if (li._card.equals(subject)) {
               // A selected card was deleted.
               this.displayCards(cardsPane.selectedCards);
               break;
             }
           }
         }
         break;
       case "addrbook-list-updated":
