# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1694731246 -7200
# Parent  c3f4cec10e0bdbfb06ccac04a1073cb2c5d2a883
Bug 1851320 - Restore thread state after messages are loaded.

diff --git a/mail/base/content/about3Pane.js b/mail/base/content/about3Pane.js
--- a/mail/base/content/about3Pane.js
+++ b/mail/base/content/about3Pane.js
@@ -4924,22 +4924,19 @@ var threadPane = {
       }
 
       // The message for this key can't be found. Perhaps the thread it's in
       // has been collapsed? Select the root message in that case.
       try {
         let msgHdr = gFolder.GetMessageHeader(key);
         let thread = gDBView.getThreadContainingMsgHdr(msgHdr);
         let rootMsgHdr = thread.getRootHdr();
-        index = gDBView.findIndexOfMsgHdr(rootMsgHdr, false);
+        index = gDBView.findIndexOfMsgHdr(rootMsgHdr, true);
         if (index != nsMsgViewIndex_None) {
-          indices.add(index);
-          if (key == currentKey) {
-            currentIndex = index;
-          }
+          threadTree.expandRowAtIndex(index);
         }
       } catch (ex) {
         console.error(ex);
       }
     }
     threadTree.setSelectedIndices(indices.values(), !notify);
 
     if (currentIndex != nsMsgViewIndex_None) {
diff --git a/mail/base/content/mailCommon.js b/mail/base/content/mailCommon.js
--- a/mail/base/content/mailCommon.js
+++ b/mail/base/content/mailCommon.js
@@ -993,16 +993,17 @@ var dbViewWrapperListener = {
   onLoadingFolder(dbFolderInfo) {
     window.quickFilterBar?.onFolderChanged();
   },
   onDisplayingFolder() {},
   onLeavingFolder() {},
   onMessagesLoaded(all) {
     // Try to restore what was selected. Keep the saved selection (if there is
     // one) until we have all of the messages.
+    window.threadPane?.restoreThreadState();
     window.threadPane?.restoreSelection(all);
 
     if (all) {
       window.threadTree?.invalidate();
     }
     window.quickFilterBar?.onMessagesChanged();
 
     let tabmail = top.document.getElementById("tabmail");
