# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1701875494 -3600
# Node ID ea6fd54640d05a907cf17d45e82fc817a47716f5
# Parent  8827bfe0b6441b5038a24a70ec6dca2adfce6cc3
Bug 1865548 - Ensure currentIndex is set when collapsing a thread with selections. r=darktrojan

Differential Revision: https://phabricator.services.mozilla.com/D194014

diff --git a/mail/base/content/widgets/tree-view.mjs b/mail/base/content/widgets/tree-view.mjs
--- a/mail/base/content/widgets/tree-view.mjs
+++ b/mail/base/content/widgets/tree-view.mjs
@@ -1155,23 +1155,25 @@ class TreeView extends HTMLElement {
    * @param {integer} index
    */
   collapseRowAtIndex(index) {
     if (!this._view.isContainerOpen(index)) {
       return;
     }
 
     // If the selected row is going to be collapsed, move the selection.
+    // Even if the row to be collapsed is already selected, set
+    // selectIndex to ensure currentIndex also points to the correct row.
     let selectedIndex = this.selectedIndex;
-    while (selectedIndex > index) {
-      selectedIndex = this._view.getParentIndex(selectedIndex);
+    while (selectedIndex >= index) {
       if (selectedIndex == index) {
         this.selectedIndex = index;
         break;
       }
+      selectedIndex = this._view.getParentIndex(selectedIndex);
     }
 
     // Check if the view calls rowCountChanged. If it didn't, we'll have to
     // call it. This can happen if the view has no reference to the tree.
     let rowCountDidChange = false;
     let rowCountChangeListener = () => {
       rowCountDidChange = true;
     };
