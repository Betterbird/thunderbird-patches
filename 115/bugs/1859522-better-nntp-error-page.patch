# HG changeset patch
# User Magnus Melin <mkmelin+mozilla@iki.fi>
# Date 1698342730 0
# Node ID 0eb9705ba84acaa054c7998df2b797dee3283add
# Parent  fa7d45a79a462a97e9ccab7442d28a6752ba5995
Bug 1859522 - Show about:neterror page when network issues happen with nntp. r=aleca

Differential Revision: https://phabricator.services.mozilla.com/D191620

diff --git a/mailnews/news/src/NntpClient.jsm b/mailnews/news/src/NntpClient.jsm
--- a/mailnews/news/src/NntpClient.jsm
+++ b/mailnews/news/src/NntpClient.jsm
@@ -226,43 +226,55 @@ class NntpClient {
   /**
    * The error event handler.
    *
    * @param {TCPSocketErrorEvent} event - The error event.
    */
   _onError = event => {
     this._logger.error(event, event.name, event.message, event.errorCode);
     let errorName;
+    let uri;
     switch (event.errorCode) {
       case Cr.NS_ERROR_UNKNOWN_HOST:
       case Cr.NS_ERROR_UNKNOWN_PROXY_HOST:
         errorName = "unknownHostError";
+        uri = "about:neterror?e=dnsNotFound";
         break;
       case Cr.NS_ERROR_CONNECTION_REFUSED:
+        errorName = "connectionRefusedError";
+        uri = "about:neterror?e=connectionFailure";
+        break;
       case Cr.NS_ERROR_PROXY_CONNECTION_REFUSED:
         errorName = "connectionRefusedError";
+        uri = "about:neterror?e=proxyConnectFailure";
         break;
       case Cr.NS_ERROR_NET_TIMEOUT:
         errorName = "netTimeoutError";
+        uri = "about:neterror?e=netTimeout";
         break;
       case Cr.NS_ERROR_NET_RESET:
         errorName = "netResetError";
+        uri = "about:neterror?e=netReset";
         break;
       case Cr.NS_ERROR_NET_INTERRUPT:
         errorName = "netInterruptError";
+        uri = "about:neterror?e=netInterrupt";
         break;
     }
-    if (errorName) {
+    if (errorName && uri) {
       let bundle = Services.strings.createBundle(
         "chrome://messenger/locale/messenger.properties"
       );
       let errorMessage = bundle.formatStringFromName(errorName, [
         this._server.hostName,
       ]);
       MailServices.mailSession.alertUser(errorMessage, this.runningUri);
+
+      // If we were going to display an article, instead show an error page.
+      this.runningUri.seeOtherURI = uri;
     }
 
     this._msgWindow?.statusFeedback?.showStatusString("");
     this.quit(event.errorCode);
   };
 
   /**
    * The close event handler.

