# HG changeset patch
# Date 1683482585 -7200
# Parent  cedb8a2a22dc1ca425d36a55e5f8948207c3da7b

diff --git a/mail/base/content/about3Pane.js b/mail/base/content/about3Pane.js
--- a/mail/base/content/about3Pane.js
+++ b/mail/base/content/about3Pane.js
@@ -127,16 +127,24 @@ window.addEventListener("DOMContentLoade
 window.addEventListener("unload", () => {
   MailServices.mailSession.RemoveFolderListener(folderListener);
   gViewWrapper?.close();
   folderPane.uninit();
   threadPane.uninit();
 });
 
 var paneLayout = {
+  /**
+   * If a table layout should be kept regardless of the current
+   * view pane orientation.
+   *
+   * @type {boolean}
+   */
+  enforceTableLayout: false,
+
   init() {
     this.folderPaneSplitter = document.getElementById("folderPaneSplitter");
     this.messagePaneSplitter = document.getElementById("messagePaneSplitter");
 
     for (let [splitter, properties, storeID] of [
       [this.folderPaneSplitter, ["width"], "folderPaneBox"],
       [this.messagePaneSplitter, ["height", "width"], "messagepaneboxwrapper"],
     ]) {
@@ -167,16 +175,20 @@ var paneLayout = {
     });
 
     this.messagePaneSplitter.addEventListener("splitter-expanded", () => {
       // Load the selected messages.
       threadTree.dispatchEvent(new CustomEvent("select"));
       this.messagePaneSplitter.storeAttr("collapsed", false);
     });
 
+    this.enforceTableLayout =
+      Services.xulStore.getValue(XULSTORE_URL, "paneLayout", "table") ===
+      "true";
+
     XPCOMUtils.defineLazyPreferenceGetter(
       this,
       "layoutPreference",
       "mail.pane_config.dynamic",
       null,
       (name, oldValue, newValue) => this.setLayout(newValue)
     );
     this.setLayout(this.layoutPreference);
@@ -193,26 +205,47 @@ var paneLayout = {
       case 1:
         document.body.classList.add("layout-wide", "layout-table");
         this.messagePaneSplitter.resizeDirection = "vertical";
         threadTree?.setAttribute("rows", "thread-row");
         break;
       case 2:
         document.body.classList.add("layout-vertical");
         this.messagePaneSplitter.resizeDirection = "horizontal";
+        // Even in vertical view, users might want to keep a table layout.
+        if (this.enforceTableLayout) {
+          document.body.classList.add("layout-table");
+          threadTree?.setAttribute("rows", "thread-row");
+          break;
+        }
         threadTree?.setAttribute("rows", "thread-card");
         break;
       default:
         document.body.classList.add("layout-classic", "layout-table");
         this.messagePaneSplitter.resizeDirection = "vertical";
         threadTree?.setAttribute("rows", "thread-row");
         break;
     }
   },
 
+  /**
+   * Update the message list layout to enforce or ignore a table layout,
+   * regardless of the currently selected view pane orientation.
+   */
+  toggleForceTableLayout() {
+    this.enforceTableLayout = !this.enforceTableLayout;
+    Services.xulStore.setValue(
+      XULSTORE_URL,
+      "paneLayout",
+      "table",
+      this.enforceTableLayout
+    );
+    this.setLayout(this.layoutPreference);
+  },
+
   get accountCentralVisible() {
     return document.body.classList.contains("account-central");
   },
   get folderPaneVisible() {
     return !this.folderPaneSplitter.isCollapsed;
   },
   set folderPaneVisible(visible) {
     this.folderPaneSplitter.isCollapsed = !visible;
@@ -2915,17 +2948,19 @@ var threadPane = {
     this.treeTable = threadTree.table;
     this.treeTable.editable = true;
     this.treeTable.setPopupMenuTemplates([
       "threadPaneApplyColumnMenu",
       "threadPaneApplyViewMenu",
     ]);
     threadTree.setAttribute(
       "rows",
-      paneLayout.layoutPreference == 2 ? "thread-card" : "thread-row"
+      paneLayout.layoutPreference == 2 && !paneLayout.enforceTableLayout
+        ? "thread-card"
+        : "thread-row"
     );
 
     XPCOMUtils.defineLazyPreferenceGetter(
       this,
       "selectDelay",
       "mailnews.threadpane_select_delay",
       null,
       (name, oldValue, newValue) => (threadTree.dataset.selectDelay = newValue)
@@ -4762,16 +4797,19 @@ commandController.registerCallback("cmd_
   Services.prefs.setIntPref("mail.pane_config.dynamic", 0)
 );
 commandController.registerCallback("cmd_viewWideMailLayout", () =>
   Services.prefs.setIntPref("mail.pane_config.dynamic", 1)
 );
 commandController.registerCallback("cmd_viewVerticalMailLayout", () =>
   Services.prefs.setIntPref("mail.pane_config.dynamic", 2)
 );
+commandController.registerCallback("cmd_toggleForceTableLayout", () =>
+  paneLayout.toggleForceTableLayout()
+);
 commandController.registerCallback("cmd_toggleFolderPane", () => {
   paneLayout.folderPaneSplitter.toggleCollapsed();
 });
 commandController.registerCallback("cmd_toggleMessagePane", () => {
   paneLayout.messagePaneSplitter.toggleCollapsed();
 });
 
 commandController.registerCallback(
diff --git a/mail/base/content/mailWindowOverlay.js b/mail/base/content/mailWindowOverlay.js
--- a/mail/base/content/mailWindowOverlay.js
+++ b/mail/base/content/mailWindowOverlay.js
@@ -405,16 +405,28 @@ function InitViewLayoutStyleMenu(event, 
   let parent = appmenu
     ? event.target.querySelector(".panel-subview-body")
     : event.target;
 
   let layoutStyleMenuitem = parent.children[paneConfig];
   if (layoutStyleMenuitem) {
     layoutStyleMenuitem.setAttribute("checked", "true");
   }
+
+  if (
+    Services.xulStore.getValue(
+      "chrome://messenger/content/messenger.xhtml",
+      "paneLayout",
+      "table"
+    ) === "true"
+  ) {
+    parent
+      .querySelector(`[name="tablelayout"]`)
+      .setAttribute("checked", "true");
+  }
 }
 
 /**
  * Called when showing the menu_viewSortPopup menupopup, so it should always
  * be up-to-date.
  */
 function InitViewSortByMenu() {
   let tab = document.getElementById("tabmail")?.currentTabInfo;
diff --git a/mail/base/content/mainCommandSet.inc.xhtml b/mail/base/content/mainCommandSet.inc.xhtml
--- a/mail/base/content/mainCommandSet.inc.xhtml
+++ b/mail/base/content/mainCommandSet.inc.xhtml
@@ -42,16 +42,17 @@
      <command id="cmd_viewPageSource" oncommand="goDoCommand('cmd_viewPageSource')" disabled="true"/>
      <command id="cmd_setFolderCharset" oncommand="goDoCommand('cmd_setFolderCharset')" />
 
      <command id="cmd_expandAllThreads" oncommand="goDoCommand('cmd_expandAllThreads')" disabled="true"/>
      <command id="cmd_collapseAllThreads" oncommand="goDoCommand('cmd_collapseAllThreads')" disabled="true"/>
      <command id="cmd_viewClassicMailLayout" oncommand="goDoCommand('cmd_viewClassicMailLayout')" disabled="true"/>
      <command id="cmd_viewWideMailLayout" oncommand="goDoCommand('cmd_viewWideMailLayout')" disabled="true"/>
      <command id="cmd_viewVerticalMailLayout" oncommand="goDoCommand('cmd_viewVerticalMailLayout')" disabled="true"/>
+     <command id="cmd_toggleForceTableLayout" oncommand="goDoCommand('cmd_toggleForceTableLayout')" disabled="true"/>
      <command id="cmd_toggleFolderPane" oncommand="goDoCommand('cmd_toggleFolderPane')" disabled="true"/>
      <command id="cmd_toggleFolderPaneCols" oncommand="goDoCommand('cmd_toggleFolderPaneCols')" disabled="true"/>
      <command id="cmd_toggleMessagePane" oncommand="goDoCommand('cmd_toggleMessagePane')" disabled="true"/>
      <command id="cmd_viewAllMsgs" oncommand="goDoCommand('cmd_viewAllMsgs')" disabled="true"/>
      <command id="cmd_viewUnreadMsgs" oncommand="goDoCommand('cmd_viewUnreadMsgs')" disabled="true"/>
      <command id="cmd_viewThreadsWithUnread" oncommand="goDoCommand('cmd_viewThreadsWithUnread')" disabled="true"/>
      <command id="cmd_viewWatchedThreadsWithUnread" oncommand="goDoCommand('cmd_viewWatchedThreadsWithUnread')" disabled="true"/>
      <command id="cmd_viewIgnoredThreads" oncommand="goDoCommand('cmd_viewIgnoredThreads')" disabled="true"/>
diff --git a/mail/base/content/messenger-menubar.inc.xhtml b/mail/base/content/messenger-menubar.inc.xhtml
--- a/mail/base/content/messenger-menubar.inc.xhtml
+++ b/mail/base/content/messenger-menubar.inc.xhtml
@@ -364,16 +364,22 @@
       <menupopup id="view_layout_popup" onpopupshowing="InitViewLayoutStyleMenu(event)">
         <menuitem id="messagePaneClassic" type="radio" label="&messagePaneClassic.label;" name="viewlayoutgroup"
                   accesskey="&messagePaneClassic.accesskey;" command="cmd_viewClassicMailLayout"/>
         <menuitem id="messagePaneWide" type="radio" label="&messagePaneWide.label;" name="viewlayoutgroup"
                   accesskey="&messagePaneWide.accesskey;" command="cmd_viewWideMailLayout"/>
         <menuitem id="messagePaneVertical" type="radio" label="&messagePaneVertical.label;" name="viewlayoutgroup"
                   accesskey="&messagePaneVertical.accesskey;" command="cmd_viewVerticalMailLayout"/>
         <menuseparator id="viewMenuAfterPaneVerticalSeparator"/>
+        <menuitem id="messagePaneVertical"
+                  type="checkbox"
+                  name="tablelayout"
+                  data-l10n-id="menu-view-folders-force-table-layout"
+                  command="cmd_toggleForceTableLayout"/>
+        <menuseparator id="viewMenuBeforeShowFolderPaneSeparator"/>
         <menuitem id="menu_showFolderPane" type="checkbox" label="&showFolderPaneCmd.label;"
                   accesskey="&showFolderPaneCmd.accesskey;" command="cmd_toggleFolderPane"/>
         <menuitem id="menu_showFolderPaneCols" type="checkbox" label="&showFolderPaneColsCmd.label;"
                   accesskey="&showFolderPaneColsCmd.accesskey;" command="cmd_toggleFolderPaneCols"/>
         <menuitem id="menu_showMessage" type="checkbox" label="&showMessageCmd.label;" key="key_toggleMessagePane"
                   accesskey="&showMessageCmd.accesskey;" command="cmd_toggleMessagePane"/>
       </menupopup>
     </menu>
diff --git a/mail/base/test/browser/browser_cardsView.js b/mail/base/test/browser/browser_cardsView.js
--- a/mail/base/test/browser/browser_cardsView.js
+++ b/mail/base/test/browser/browser_cardsView.js
@@ -32,16 +32,21 @@ add_setup(async function() {
   testMessages = [...testFolder.messages];
 
   about3Pane.displayFolder(testFolder.URI);
   about3Pane.paneLayout.messagePaneVisible = false;
 
   registerCleanupFunction(() => {
     click_through_appmenu(
       [{ id: "appmenu_View" }, { id: "appmenu_MessagePaneLayout" }],
+      { id: "appmenu_forceTableLayout" },
+      window
+    );
+    click_through_appmenu(
+      [{ id: "appmenu_View" }, { id: "appmenu_MessagePaneLayout" }],
       { id: "appmenu_messagePaneClassic" },
       window
     );
     MailServices.accounts.removeAccount(account, false);
   });
 });
 
 add_task(async function testSwitchToVerticalView() {
@@ -97,8 +102,34 @@ add_task(async function testTagsInVertic
   let tag2 = row2.querySelector(".tag-icon");
   Assert.ok(BrowserTestUtils.is_hidden(tag2), "tag icon should be hidden");
 
   // Set the work tag.
   EventUtils.synthesizeKey("2", {});
   Assert.ok(BrowserTestUtils.is_visible(tag2), "tag icon should be visible");
   Assert.deepEqual(tag2.title, "Work", "The work tag should be set");
 });
+
+add_task(async function testRowsListInVerticalView() {
+  click_through_appmenu(
+    [{ id: "appmenu_View" }, { id: "appmenu_MessagePaneLayout" }],
+    { id: "appmenu_forceTableLayout" },
+    window
+  );
+
+  await BrowserTestUtils.waitForCondition(
+    () => threadTree.getAttribute("rows") == "thread-row",
+    "The tree view switched to a table layout"
+  );
+
+  Assert.equal(
+    threadTree.getAttribute("rows"),
+    "thread-row",
+    "tree view in table layout"
+  );
+
+  Assert.ok(
+    BrowserTestUtils.is_visible(
+      about3Pane.document.querySelector(`thead[is="tree-view-table-header"]`)
+    ),
+    "The table header should be visible"
+  );
+});
diff --git a/mail/components/customizableui/content/panelUI.inc.xhtml b/mail/components/customizableui/content/panelUI.inc.xhtml
--- a/mail/components/customizableui/content/panelUI.inc.xhtml
+++ b/mail/components/customizableui/content/panelUI.inc.xhtml
@@ -350,16 +350,23 @@
                        command="cmd_viewWideMailLayout"/>
         <toolbarbutton id="appmenu_messagePaneVertical"
                        class="subviewbutton subviewbutton-iconic"
                        type="radio"
                        label="&messagePaneVertical.label;"
                        name="viewlayoutgroup"
                        command="cmd_viewVerticalMailLayout"/>
         <toolbarseparator id="appmenu_viewMenuAfterPaneVerticalSeparator"/>
+        <toolbarbutton id="appmenu_forceTableLayout"
+                       class="subviewbutton subviewbutton-iconic"
+                       type="checkbox"
+                       name="tablelayout"
+                       data-l10n-id="appmenuitem-force-table-layout"
+                       command="cmd_toggleForceTableLayout"/>
+        <toolbarseparator id="appmenu_viewMenuBeforeShowFolderPaneSeparator"/>
         <toolbarbutton id="appmenu_showFolderPane"
                        class="subviewbutton subviewbutton-iconic"
                        type="checkbox"
                        label="&showFolderPaneCmd.label;"
                        command="cmd_toggleFolderPane"/>
         <toolbarbutton id="appmenu_showFolderPaneCols"
                        class="subviewbutton subviewbutton-iconic"
                        type="checkbox"
diff --git a/mail/components/customizableui/content/panelUI.js b/mail/components/customizableui/content/panelUI.js
--- a/mail/components/customizableui/content/panelUI.js
+++ b/mail/components/customizableui/content/panelUI.js
@@ -601,17 +601,17 @@ const PanelUI = {
   /**
    * Event handler for showing the Preferences/Layout view. Removes "checked"
    * from all layout menu items and then checks the current layout menu item.
    *
    * @param {ViewShowingEvent} event - ViewShowing event.
    */
   _onPreferencesLayoutViewShow(event) {
     event.target
-      .querySelectorAll("[name='viewlayoutgroup']")
+      .querySelectorAll("[name='viewlayoutgroup'], [name='tablelayout']")
       .forEach(item => item.removeAttribute("checked"));
 
     InitViewLayoutStyleMenu(event, true);
   },
 
   /**
    * Event listener for showing the Folders view.
    *
diff --git a/mail/locales/en-US/messenger/appmenu.ftl b/mail/locales/en-US/messenger/appmenu.ftl
--- a/mail/locales/en-US/messenger/appmenu.ftl
+++ b/mail/locales/en-US/messenger/appmenu.ftl
@@ -153,16 +153,19 @@ appmenu-uidensity-relaxed =
   .tooltiptext = Relaxed
 
 appmenuitem-font-size-enlarge =
   .tooltiptext = Increase Font Size
 
 appmenuitem-font-size-reduce =
   .tooltiptext = Reduce Font Size
 
+appmenuitem-force-table-layout =
+  .label = Message List in Table Layout
+
 # Variables:
 # $size (String) - The current font size.
 appmenuitem-font-size-reset =
   .label = { $size }px
   .tooltiptext = Reset Font Size
 
 ## Tools
 
diff --git a/mail/locales/en-US/messenger/menubar.ftl b/mail/locales/en-US/messenger/menubar.ftl
--- a/mail/locales/en-US/messenger/menubar.ftl
+++ b/mail/locales/en-US/messenger/menubar.ftl
@@ -104,16 +104,20 @@ menu-view-repair-text-encoding =
     .accesskey = c
 
 ## View / Folders
 
 menu-view-folders-toggle-header =
     .label = Folder Pane Header
     .accesskey = F
 
+menu-view-folders-force-table-layout =
+    .label = Message List in Table Layout
+    .accesskey = T
+
 ## View / Layout
 
 menu-font-size-label =
     .label = Font Size
     .accesskey = o
 
 menuitem-font-size-enlarge =
     .label = Increase Font Size
