# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1705771260 -3600
# Parent  a6054eb05e41cb597ba22014aebbf940d98dde9a
NNN7 - Fix wrong folder selection at startup.

When restoring the first tab, sometimes the top-most folder gets selected before
later the right folder is selected. Putting the "select" event dispatch on a timeout
seems to fix this issue.

diff --git a/mail/base/content/about3Pane.js b/mail/base/content/about3Pane.js
--- a/mail/base/content/about3Pane.js
+++ b/mail/base/content/about3Pane.js
@@ -124,17 +124,24 @@ window.addEventListener("DOMContentLoade
     console.warn(`Couldn't restore state: ${e.message}`, e);
   }
   delete window.openingState;
 
   // Finally, add the folderTree listener and trigger it. Earlier events
   // (triggered by `folderPane.init` and possibly `restoreState`) are ignored
   // to avoid unnecessarily loading the thread tree or Account Central.
   folderTree.addEventListener("select", folderPane);
-  folderTree.dispatchEvent(new CustomEvent("select"));
+
+  // In some cases `folderTree.selectedIndex` isn't set correctly when the event is
+  // handled, so the wrong folder is selected at first. We've seen
+  // index 0, so in a unified view, that will be the unified inbox as the top-most row.
+  // If that's grouped-by-sort, then long delays are expected.
+  // Fixing the long delays in https://bugzilla.mozilla.org/show_bug.cgi?id=1875577
+  // will paper over the issue some more.
+  window.setTimeout(() => folderTree.dispatchEvent(new CustomEvent("select")));
 
   // Attach the progress listener for the webBrowser. For the messageBrowser this
   // happens in the "aboutMessageLoaded" event from aboutMessage.js.
   // For the webBrowser, we can do it here directly.
   top.contentProgress.addProgressListenerToBrowser(webBrowser);
 
   mailContextMenu.init();
 });
