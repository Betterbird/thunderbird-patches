# HG changeset patch
# User Geoff Lankow <geoff@darktrojan.net>
# Date 1689716409 -7200
# Node ID df334c4248616fffa14cbf55779e785e6a170efe
# Parent  6b797511bb9b291982ef06fcf2d5829d14d865d7
Bug 1841208 - Test the message list is invalidated properly after message deletion. r=aleca,leftmostcat

Differential Revision: https://phabricator.services.mozilla.com/D182540

diff --git a/mail/base/content/mailCommon.js b/mail/base/content/mailCommon.js
--- a/mail/base/content/mailCommon.js
+++ b/mail/base/content/mailCommon.js
@@ -848,17 +848,27 @@ var dbViewWrapperListener = {
       dbViewWrapperListener._nextViewIndexAfterDelete = gDBView
         ? gDBView.msgToSelectAfterDelete
         : null;
     },
     summarizeSelection() {
       return true;
     },
     selectedMessageRemoved() {
-      dbViewWrapperListener.onMessagesRemoved();
+      // We need to invalidate the tree, but this method could get called
+      // multiple times, so we won't invalidate until we get to the end of the
+      // event loop.
+      if (this._timeout) {
+        return;
+      }
+      this._timeout = setTimeout(() => {
+        dbViewWrapperListener.onMessagesRemoved();
+        window.threadTree?.invalidate();
+        delete this._timeout;
+      });
     },
   },
 
   get shouldUseMailViews() {
     return false;
   },
   get shouldDeferMessageDisplayUntilAfterServerConnect() {
     return false;
