# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1703286110 -3600
# Parent  5af358dad8d9051f403de0df71894b9206054dd1
Bug 1871493 - Don't play sound on new feed message on all code paths.

diff --git a/mailnews/base/src/nsStatusBarBiffManager.cpp b/mailnews/base/src/nsStatusBarBiffManager.cpp
--- a/mailnews/base/src/nsStatusBarBiffManager.cpp
+++ b/mailnews/base/src/nsStatusBarBiffManager.cpp
@@ -175,26 +175,27 @@ nsStatusBarBiffManager::OnFolderProperty
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsStatusBarBiffManager::OnFolderIntPropertyChanged(nsIMsgFolder* folder,
                                                    const nsACString& property,
                                                    int64_t oldValue,
                                                    int64_t newValue) {
+  // Get the folder's server type. This must be retrieved before calling
+  // `PlayBiffSound()`.
+  nsCOMPtr<nsIMsgIncomingServer> server;
+  nsresult rv = folder->GetServer(getter_AddRefs(server));
+  if (NS_SUCCEEDED(rv) && server) server->GetType(mServerType);
+
   if (property.Equals(kBiffState) && mCurrentBiffState != newValue) {
     // if we got new mail, attempt to play a sound.
     // if we fail along the way, don't return.
     // we still need to update the UI.
     if (newValue == nsIMsgFolder::nsMsgBiffState_NewMail) {
-      // Get the folder's server type.
-      nsCOMPtr<nsIMsgIncomingServer> server;
-      nsresult rv = folder->GetServer(getter_AddRefs(server));
-      if (NS_SUCCEEDED(rv) && server) server->GetType(mServerType);
-
       // if we fail to play the biff sound, keep going.
       (void)PlayBiffSound(NEW_MAIL_PREF_BRANCH);
     }
     mCurrentBiffState = newValue;
 
     // don't care if notification fails
     nsCOMPtr<nsIObserverService> observerService =
         mozilla::services::GetObserverService();
