# HG changeset patch
# User Gene Smith <gds@chartertn.net>
# Date 1689971575 -7200
# Parent  77e0c87e7f552c38d1661533bb7a02e417bb9f80
Bug 1843637 - Restore calling performExpand() when expanding node in folder tree. Needed for IMAP.

diff --git a/mail/base/content/about3Pane.js b/mail/base/content/about3Pane.js
--- a/mail/base/content/about3Pane.js
+++ b/mail/base/content/about3Pane.js
@@ -2570,16 +2570,28 @@ var folderPane = {
 
   _onExpanded({ target }) {
     if (target.uri) {
       let mode = target.closest("[data-mode]").dataset.mode;
       FolderTreeProperties.setIsExpanded(target.uri, mode, true);
     }
     target.updateUnreadMessageCount();
     target.updateTotalMessageCount();
+
+    // Get server type. IMAP is the only server type that does folder discovery.
+    let folder = MailServices.folderLookup.getFolderForURL(target.uri);
+    if (folder.server.type == "imap") {
+      // Trigger folder discovery.
+      if (folder.isServer) {
+        folder.server.performExpand(top.msgWindow);
+      } else {
+        let imapFolder = folder.QueryInterface(Ci.nsIMsgImapMailFolder);
+        imapFolder.performExpand(top.msgWindow);
+      }
+    }
   },
 
   _onDragStart(event) {
     let row = event.target.closest(`li[is="folder-tree-row"]`);
     if (!row) {
       event.preventDefault();
       return;
     }
