# HG changeset patch
# User Kai Engert <kaie@kuix.de>
# Date 1707947699 -3600
# Node ID 1fa1b9bb000ba2fb73922d8671343cbf61421a0e
# Parent  cede3b577142261c3609a3628898f3d10728f4fa
Bug 1878053 - Set required content headers when creating decrypted copy of S/MIME message. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D200341

diff --git a/mail/extensions/openpgp/content/modules/persistentCrypto.jsm b/mail/extensions/openpgp/content/modules/persistentCrypto.jsm
--- a/mail/extensions/openpgp/content/modules/persistentCrypto.jsm
+++ b/mail/extensions/openpgp/content/modules/persistentCrypto.jsm
@@ -491,23 +491,28 @@ CryptMessageIntoFolder.prototype = {
     }
 
     let m = Cc["@mozilla.org/messenger/mimeheaders;1"].createInstance(
       Ci.nsIMimeHeaders
     );
     // headers are found from the beginning up to the start of the body
     m.initialize(data.substr(0, bodyIndex));
 
-    mimePart.headers._rawHeaders.set("content-type", [
-      m.extractHeader("content-type", false) || "",
-    ]);
-
-    mimePart.headers._rawHeaders.delete("content-transfer-encoding");
-    mimePart.headers._rawHeaders.delete("content-disposition");
-    mimePart.headers._rawHeaders.delete("content-description");
+    for (const hdrName of [
+      "content-type",
+      "content-transfer-encoding",
+      "content-disposition",
+      "content-description",
+    ]) {
+      mimePart.headers._rawHeaders.delete(hdrName);
+      const val = m.extractHeader(hdrName, false);
+      if (val) {
+        mimePart.headers._rawHeaders.set(hdrName, val);
+      }
+    }
 
     mimePart.subParts = [];
     mimePart.body = data.substr(bodyIndex);
 
     this.cryptoChanged = true;
   },
 
   isSMIME(mimePart) {
