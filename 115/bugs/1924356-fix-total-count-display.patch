# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1729361196 -7200
# Parent  be355775791aad74f9ba19e56b2723a0d957d460
Bug 1924356 - Make sure Total Message Count is displayed for Favorite Folders.

Bonus fix: For virtual folders, sizeOnDisk() fails.

diff --git a/mail/base/content/about3Pane.js b/mail/base/content/about3Pane.js
--- a/mail/base/content/about3Pane.js
+++ b/mail/base/content/about3Pane.js
@@ -4401,8 +4401,9 @@ class FolderTreeRow extends HTMLLIElemen
 
   set totalCount(value) {
     this.classList.toggle("total", value > 0);
     this.totalCountLabel.textContent = value;
+    this.totalCountLabel.hidden = !folderPane.isTotalMsgCountVisible();
     this.#updateAriaLabel();
   }
 
   /**
@@ -4415,8 +4416,11 @@ class FolderTreeRow extends HTMLLIElemen
   }
 
   set folderSize(value) {
     this.folderSizeLabel.textContent = value;
+    this.folderSizeLabel.hidden = !folderPane.isItemVisible(
+      "folderPaneFolderSize"
+    );
     this.#updateAriaLabel();
   }
 
   #updateAriaLabel() {
@@ -4527,9 +4531,13 @@ class FolderTreeRow extends HTMLLIElemen
     const isCollapsed = this.classList.contains("collapsed");
     this.unreadCount = folder.getNumUnread(isCollapsed);
     this.totalCount = folder.getTotalMessages(isCollapsed);
     if (folderPane.isItemVisible("folderPaneFolderSize")) {
-      this.folderSize = this.formatFolderSize(folder.sizeOnDisk);
+      if (!(folder.flags & Ci.nsMsgFolderFlags.Virtual)) {
+        this.folderSize = this.formatFolderSize(folder.sizeOnDisk);
+      } else {
+        this.folderSize = "";
+      }
     }
     this.folderSortOrder = folder.sortOrder;
     if (folder.noSelect) {
       this.classList.add("noselect-folder");
@@ -4597,14 +4605,17 @@ class FolderTreeRow extends HTMLLIElemen
     // Called recursively.
     const getChildrenSizeCount = row => {
       let sizeCount = 0;
       for (const child of row.childList.children) {
-        // If size is unknown, sizeOnDisk returns -1.
-        sizeCount +=
-          Math.max(
-            0,
-            MailServices.folderLookup.getFolderForURL(child.uri).sizeOnDisk
-          ) + getChildrenSizeCount(child);
+        const childFolder = MailServices.folderLookup.getFolderForURL(
+          child.uri
+        );
+        let folderSize = -1;
+        if (!(childFolder.flags & Ci.nsMsgFolderFlags.Virtual)) {
+          // If size is unknown, sizeOnDisk returns -1.
+          folderSize = childFolder.sizeOnDisk;
+        }
+        sizeCount += Math.max(0, folderSize) + getChildrenSizeCount(child);
       }
       return sizeCount;
     };
 
@@ -4613,9 +4624,12 @@ class FolderTreeRow extends HTMLLIElemen
       return;
     }
 
     folder = folder ?? MailServices.folderLookup.getFolderForURL(this.uri);
-    let sizeCount = folder.sizeOnDisk;
+    let sizeCount = -1;
+    if (!(folder.flags & Ci.nsMsgFolderFlags.Virtual)) {
+      sizeCount = folder.sizeOnDisk;
+    }
     if (sizeCount < 0) {
       this.folderSize = "";
       return;
     }
