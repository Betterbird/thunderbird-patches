# HG changeset patch
# User Magnus Melin <mkmelin+mozilla@iki.fi>
# Date 1709835208 -3600
# Node ID 951a02a80aa262ef67fc6de3caac29eb61479cbf
# Parent  92e4390db38a2984f12a20e3ce9ff64d7028f625
Bug 1790746 - Ensure spell checker is ready before changing dictionaries. r=freaktechnik

Inspired by https://github.com/Betterbird/thunderbird-patches/blob/main/115/bugs/1775376-fix-dict-edit-draft.patch

Differential Revision: https://phabricator.services.mozilla.com/D201995

diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -7406,11 +7406,24 @@ async function ComposeChangeLanguage(lan
     // Update the document language as well.
     document.documentElement.setAttribute("lang", languageToSet);
   }
 
+  let checker = GetCurrentEditorSpellChecker();
+
+  // Spell checker needs to be ready before we can select new dictionaries.
+  if (gSpellCheckingEnabled && checker?.spellCheckPending) {
+    await new Promise(resolve => {
+      Services.obs.addObserver(function observe(subject, topic, data) {
+        if (subject == gMsgCompose.editor) {
+          Services.obs.removeObserver(observe, topic);
+          resolve();
+        }
+      }, "inlineSpellChecker-spellCheck-ended");
+    });
+  }
+
   await gSpellChecker?.selectDictionaries(languages);
 
-  let checker = GetCurrentEditorSpellChecker();
   if (checker?.spellChecker) {
     await checker.spellChecker.setCurrentDictionaries(languages);
   }
   // Update subject spell checker languages. If for some reason the spell
@@ -7497,14 +7510,8 @@ async function updateLanguageInStatusBar
 
   if (!dictionaries) {
     dictionaries = Array.from(gActiveDictionaries);
   }
-  let listFormat = new Intl.ListFormat(undefined, {
-    type: "conjunction",
-    style: "short",
-  });
-  let languages = [];
-  let item = languageMenuList.firstElementChild;
 
   // No status display, if there is only one or no spelling dictionary available.
   if (languageMenuList.childElementCount <= 3) {
     languageStatusButton.hidden = true;
@@ -7512,8 +7519,14 @@ async function updateLanguageInStatusBar
     return;
   }
 
   languageStatusButton.hidden = false;
+  let listFormat = new Intl.ListFormat(Services.locale.appLocalesAsBCP47, {
+    type: "conjunction",
+    style: "short",
+  });
+  let languages = [];
+  let item = languageMenuList.firstElementChild;
   while (item) {
     if (item.tagName.toLowerCase() === "menuseparator") {
       break;
     }
