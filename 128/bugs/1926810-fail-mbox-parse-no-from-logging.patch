# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1731331187 -3600
# Parent  0371c35440fb95eefad96322ea788d7825c8bd42
Bug 1926810 - Continuation: Log mbox errors to console.

diff --git a/mailnews/base/src/MboxMsgInputStream.h b/mailnews/base/src/MboxMsgInputStream.h
--- a/mailnews/base/src/MboxMsgInputStream.h
+++ b/mailnews/base/src/MboxMsgInputStream.h
@@ -88,8 +88,10 @@ class MboxMsgInputStream : public nsIInp
    * If the "From " line contained a timestamp, it can be accessed here.
    * Otherwise 0 will be returned.
    */
   PRTime EnvDate();
+  
+  nsresult MboxStatus() { return mStatus; }
 
  protected:
   virtual ~MboxMsgInputStream();
 
diff --git a/mailnews/local/src/nsMsgBrkMBoxStore.cpp b/mailnews/local/src/nsMsgBrkMBoxStore.cpp
--- a/mailnews/local/src/nsMsgBrkMBoxStore.cpp
+++ b/mailnews/local/src/nsMsgBrkMBoxStore.cpp
@@ -42,8 +42,12 @@
 #include "prprf.h"
 #include <cstdlib>  // for std::abs(int/long)
 #include <cmath>    // for std::abs(float/double)
 
+/* for logging to Error Console */
+#include "nsIScriptError.h"
+#include "nsPrintfCString.h"
+
 mozilla::LazyLogModule gMboxLog("mbox");
 using mozilla::LogLevel;
 
 /**
@@ -1351,8 +1355,18 @@ nsMsgBrkMBoxStore::GetMsgInputStream(nsI
   NS_ENSURE_SUCCESS(rv, rv);
   // Stream to return a single message, hiding all "From "-separator guff.
   RefPtr<MboxMsgInputStream> msgStream =
       new MboxMsgInputStream(rawMboxStream, aMaxAllowedSize);
+  if (msgStream->MboxStatus() == NS_MSG_ERROR_MBOX_MALFORMED) {
+    nsCString fileName(mboxFile->HumanReadablePath());
+    nsCString msg;
+    msg = nsPrintfCString("Mbox parsing error at offset %" PRIi64 " (0x%" PRIx64
+                          ") on %s",
+                          offset, offset, fileName.get());
+    MsgLogToConsole4(NS_ConvertUTF8toUTF16(msg),
+                     NS_LITERAL_STRING_FROM_CSTRING(__FILE__), __LINE__,
+                     nsIScriptError::errorFlag);
+  }
   msgStream.forget(aResult);
   return NS_OK;
 }
 
