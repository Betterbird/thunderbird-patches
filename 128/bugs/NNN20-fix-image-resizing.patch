# HG changeset patch
# User alta88@fixall.com
# Date 1731152550 -3600
# Parent  0137d2c97efd3c21c37752ea718e0778045aeb8e
NNN20 - Fix image resizing regressions.

diff --git a/mail/base/content/aboutMessage.js b/mail/base/content/aboutMessage.js
--- a/mail/base/content/aboutMessage.js
+++ b/mail/base/content/aboutMessage.js
@@ -50,28 +50,25 @@ function messagePaneOnResize() {
   if (doc?.URL.startsWith("http") || !doc?.images) {
     return;
   }
 
-  const availableWidth = Math.max(
-    document.body.scrollWidth,
-    window.visualViewport.width
-  );
-
   for (const img of doc.querySelectorAll(
     "img:is([shrinktofit],[overflowing])"
   )) {
-    if (!img.complete || img.closest("[href]")) {
+    if (!img.complete) {
       continue;
     }
+
+    const isOverflowing =
+      doc.body.clientWidth < img.naturalWidth &&
+      img.naturalWidth > img.clientWidth;
+
     if (img.hasAttribute("shrinktofit")) {
       // Determine if the image could be enlarged.
-      img.toggleAttribute("overflowing", img.naturalWidth > img.clientWidth);
-    } else if (
-      img.hasAttribute("overflowing") &&
-      img.clientWidth < availableWidth
-    ) {
-      // Handle zoomed images that are no longer overflowing after a resize.
-      img.removeAttribute("overflowing");
+      img.toggleAttribute("overflowing", isOverflowing);
+    } else {
+      // Handle zoomed images that may no longer be overflowing after a resize.
+      img.toggleAttribute("overflowing", isOverflowing);
       img.setAttribute("shrinktofit", "true");
     }
   }
 }
diff --git a/mail/base/content/msgHdrView.js b/mail/base/content/msgHdrView.js
--- a/mail/base/content/msgHdrView.js
+++ b/mail/base/content/msgHdrView.js
@@ -4346,20 +4346,25 @@ function OnMsgParsed(aUrl) {
         img.addEventListener("load", resolve, { once: true });
       });
     }
     await stylesReadyPromise;
-    if (img.naturalWidth > img.clientWidth) {
-      img.setAttribute("overflowing", "true");
-    }
+
+    // An image is overflowing iff its naturalWidth is larger than the
+    // messagepane viewport AND its naturalWidth (unconstrained) is greater
+    // than its displayed width. The naturalWidth should always be available
+    // due to await for the load to complete. Also in messagePaneOnResize().
+    const isOverflowing =
+      doc.body.clientWidth < img.naturalWidth &&
+      img.naturalWidth > img.clientWidth;
+
+    img.toggleAttribute("overflowing", isOverflowing);
   };
 
   // Scale any overflowing images, exclude http content.
   const imgs = doc && !doc.URL.startsWith("http") ? doc.images : [];
   for (const img of imgs) {
-    // No zooming for children of clickable links.
-    if (img.closest("[href]")) {
-      continue;
-    }
+    // Any overflowing image must be click zoomable. An overflowing link image
+    // will have the url displayed on hover and can be opened via contextmenu.
     applyOverflowingToImg(img);
   }
 }
 
diff --git a/mail/themes/shared/mail/messageBody.css b/mail/themes/shared/mail/messageBody.css
--- a/mail/themes/shared/mail/messageBody.css
+++ b/mail/themes/shared/mail/messageBody.css
@@ -90,24 +90,24 @@ mailattachcount {
 
 /* ::::: images ::::: */
 
 img {
+  width: auto !important;
+  /* Always keep the aspect ratio. */
+  height: auto !important;
+
   &[shrinktofit] {
+    /* Fit the viewport .*/
     max-width: 100% !important;
 
     &[overflowing] {
       cursor: zoom-in;
-      /* If we detect we're shrinking the image, force it to keep its aspect
-       * ratio, since it possibly had hard-coded sizings. */
-      height: auto !important;
     }
   }
 
   &[overflowing]:not([shrinktofit]) {
     cursor: zoom-out;
     /* Unbound the sizing of the image so it is displayed at full size. */
-    height: auto !important;
-    width: auto !important;
     max-width: none !important;
   }
 }
 
