# HG changeset patch
# User alta88@fixall.com
# Date 1709828372 -3600
# Parent  5e82cd588124b70aa747c76411a14b7eb79656f9
Feature: Add Wide Thread and Stacked layout views to 3pane.

Wide thread layout: thread tree across the top, and folder tree and message browser on the bottom.
Stacked layout: folder tree and thread tree on the left, and message browser on the right.

Authored by Alta88 and contributed to the Betterbird Project.
See https://github.com/Betterbird/thunderbird-patches/blob/main/LICENSE for license details.
All uses require attribution to the Author.

diff --git a/mail/base/content/about3Pane.js b/mail/base/content/about3Pane.js
--- a/mail/base/content/about3Pane.js
+++ b/mail/base/content/about3Pane.js
@@ -167,9 +167,9 @@ var paneLayout = {
     this.folderPaneSplitter = document.getElementById("folderPaneSplitter");
     this.messagePaneSplitter = document.getElementById("messagePaneSplitter");
 
     for (const [splitter, properties, storeID] of [
-      [this.folderPaneSplitter, ["width"], "folderPaneBox"],
+      [this.folderPaneSplitter, ["height", "width"], "folderPaneBox"],
       [this.messagePaneSplitter, ["height", "width"], "messagepaneboxwrapper"],
     ]) {
       for (const property of properties) {
         const value = XULStoreUtils.getValue("messenger", storeID, property);
@@ -215,28 +215,49 @@ var paneLayout = {
       XULStoreUtils.getValue("messenger", "threadPane", "view")
     );
   },
 
+  LAYOUTS: ["standard", "wide", "vertical", "widethread", "stacked"],
+
+  CONFIG_MAP: {
+    standard: {
+      className: "layout-classic",
+      folderPaneSplitterDir: "horizontal",
+      messagePaneSplitterDir: "vertical",
+    },
+    wide: {
+      className: "layout-wide",
+      folderPaneSplitterDir: "horizontal",
+      messagePaneSplitterDir: "vertical",
+    },
+    vertical: {
+      className: "layout-vertical",
+      folderPaneSplitterDir: "horizontal",
+      messagePaneSplitterDir: "horizontal",
+    },
+    widethread: {
+      className: "layout-widethread",
+      folderPaneSplitterDir: "horizontal",
+      messagePaneSplitterDir: "vertical",
+    },
+    stacked: {
+      className: "layout-stacked",
+      folderPaneSplitterDir: "vertical",
+      messagePaneSplitterDir: "horizontal",
+    },
+  },
+
   setLayout(preference) {
-    document.body.classList.remove(
-      "layout-classic",
-      "layout-vertical",
-      "layout-wide"
-    );
-    switch (preference) {
-      case 1:
-        document.body.classList.add("layout-wide");
-        this.messagePaneSplitter.resizeDirection = "vertical";
-        break;
-      case 2:
-        document.body.classList.add("layout-vertical");
-        this.messagePaneSplitter.resizeDirection = "horizontal";
-        break;
-      default:
-        document.body.classList.add("layout-classic");
-        this.messagePaneSplitter.resizeDirection = "vertical";
-        break;
-    }
+    this.LAYOUTS.forEach(layout => {
+      document.body.classList.remove(this.CONFIG_MAP[layout].className);
+    });
+
+    let layoutConfig = this.CONFIG_MAP[this.LAYOUTS[preference]];
+    document.body.classList.add(layoutConfig.className);
+    this.folderPaneSplitter.resizeDirection =
+      layoutConfig.folderPaneSplitterDir;
+    this.messagePaneSplitter.resizeDirection =
+      layoutConfig.messagePaneSplitterDir;
   },
 
   get accountCentralVisible() {
     return document.body.classList.contains("account-central");
@@ -2530,12 +2551,17 @@ var folderPane = {
           gFolder.URI
         )}`
       );
       document.body.classList.add("account-central");
+      paneLayout.folderPaneSplitter.resizeDirection = "horizontal";
       accountCentralBrowser.hidden = false;
     } else {
       document.title = `${gFolder.name} - ${gFolder.server.prettyName}`;
       document.body.classList.remove("account-central");
+      let layoutConfig =
+        paneLayout.CONFIG_MAP[paneLayout.LAYOUTS[paneLayout.layoutPreference]];
+      paneLayout.folderPaneSplitter.resizeDirection =
+        layoutConfig.folderPaneSplitterDir;
       accountCentralBrowser.hidden = true;
 
       quickFilterBar.activeElement = null;
       threadPane.restoreColumns();
@@ -6133,8 +6159,14 @@ commandController.registerCallback("cmd_
 );
 commandController.registerCallback("cmd_viewVerticalMailLayout", () =>
   Services.prefs.setIntPref("mail.pane_config.dynamic", 2)
 );
+commandController.registerCallback("cmd_viewWideThreadMailLayout", () =>
+  Services.prefs.setIntPref("mail.pane_config.dynamic", 3)
+);
+commandController.registerCallback("cmd_viewStackedMailLayout", () =>
+  Services.prefs.setIntPref("mail.pane_config.dynamic", 4)
+);
 commandController.registerCallback(
   "cmd_toggleThreadPaneHeader",
   () => threadPaneHeader.toggleThreadPaneHeader(),
   () => gFolder && !gFolder.isServer
diff --git a/mail/base/content/mainCommandSet.inc.xhtml b/mail/base/content/mainCommandSet.inc.xhtml
--- a/mail/base/content/mainCommandSet.inc.xhtml
+++ b/mail/base/content/mainCommandSet.inc.xhtml
@@ -46,8 +46,10 @@
      <command id="cmd_collapseAllThreads" oncommand="goDoCommand('cmd_collapseAllThreads')" disabled="true"/>
      <command id="cmd_viewClassicMailLayout" oncommand="goDoCommand('cmd_viewClassicMailLayout')" disabled="true"/>
      <command id="cmd_viewWideMailLayout" oncommand="goDoCommand('cmd_viewWideMailLayout')" disabled="true"/>
      <command id="cmd_viewVerticalMailLayout" oncommand="goDoCommand('cmd_viewVerticalMailLayout')" disabled="true"/>
+     <command id="cmd_viewWideThreadMailLayout" oncommand="goDoCommand('cmd_viewWideThreadMailLayout')" disabled="true"/>
+     <command id="cmd_viewStackedMailLayout" oncommand="goDoCommand('cmd_viewStackedMailLayout')" disabled="true"/>
      <command id="cmd_toggleFolderPane" oncommand="goDoCommand('cmd_toggleFolderPane')" disabled="true"/>
      <command id="cmd_toggleThreadPaneHeader" oncommand="goDoCommand('cmd_toggleThreadPaneHeader')" disabled="true"/>
      <command id="cmd_toggleMessagePane" oncommand="goDoCommand('cmd_toggleMessagePane')" disabled="true"/>
      <command id="cmd_viewAllMsgs" oncommand="goDoCommand('cmd_viewAllMsgs')" disabled="true"/>
diff --git a/mail/base/content/messenger-menubar.inc.xhtml b/mail/base/content/messenger-menubar.inc.xhtml
--- a/mail/base/content/messenger-menubar.inc.xhtml
+++ b/mail/base/content/messenger-menubar.inc.xhtml
@@ -366,8 +366,18 @@
         <menuitem id="messagePaneWide" type="radio" label="&messagePaneWide.label;" name="viewlayoutgroup"
                   accesskey="&messagePaneWide.accesskey;" command="cmd_viewWideMailLayout"/>
         <menuitem id="messagePaneVertical" type="radio" label="&messagePaneVertical.label;" name="viewlayoutgroup"
                   accesskey="&messagePaneVertical.accesskey;" command="cmd_viewVerticalMailLayout"/>
+        <menuitem id="messagePaneWideThread"
+                  type="radio"
+                  data-l10n-id="menu-view-layout-widethread"
+                  name="viewlayoutgroup"
+                  command="cmd_viewWideThreadMailLayout"/>
+        <menuitem id="messagePaneStacked"
+                  type="radio"
+                  data-l10n-id="menu-view-layout-stacked"
+                  name="viewlayoutgroup"
+                  command="cmd_viewStackedMailLayout"/>
         <menuseparator id="viewMenuAfterPaneVerticalSeparator"/>
         <menuitem id="multilineAllFolders"
                   type="checkbox"
                   data-l10n-id="menu-multi-line-all-folders"
diff --git a/mail/components/customizableui/content/panelUI.inc.xhtml b/mail/components/customizableui/content/panelUI.inc.xhtml
--- a/mail/components/customizableui/content/panelUI.inc.xhtml
+++ b/mail/components/customizableui/content/panelUI.inc.xhtml
@@ -353,8 +353,20 @@
                        type="radio"
                        label="&messagePaneVertical.label;"
                        name="viewlayoutgroup"
                        command="cmd_viewVerticalMailLayout"/>
+        <toolbarbutton id="appmenu_messagePaneWideThread"
+                       class="subviewbutton subviewbutton-iconic"
+                       type="radio"
+                       data-l10n-id="menu-view-layout-widethread"
+                       name="viewlayoutgroup"
+                       command="cmd_viewWideThreadMailLayout"/>
+        <toolbarbutton id="appmenu_messagePaneStacked"
+                       class="subviewbutton subviewbutton-iconic"
+                       type="radio"
+                       data-l10n-id="menu-view-layout-stacked"
+                       name="viewlayoutgroup"
+                       command="cmd_viewStackedMailLayout"/>
         <toolbarseparator id="appmenu_viewMenuAfterPaneVerticalSeparator"/>
         <toolbarbutton id="appmenu_multilineAllFolders"
                        class="subviewbutton subviewbutton-iconic"
                        type="checkbox"
diff --git a/mail/components/extensions/parent/ext-mailTabs.js b/mail/components/extensions/parent/ext-mailTabs.js
--- a/mail/components/extensions/parent/ext-mailTabs.js
+++ b/mail/components/extensions/parent/ext-mailTabs.js
@@ -28,9 +28,9 @@ XPCOMUtils.defineLazyPreferenceGetter(
   "mail.pane_config.dynamic",
   0
 );
 
-const LAYOUTS = ["standard", "wide", "vertical"];
+const LAYOUTS = ["standard", "wide", "vertical", "widethread", "stacked"];
 // From nsIMsgDBView.idl
 const SORT_TYPE_MAP = new Map(
   Object.keys(Ci.nsMsgViewSortType).map(key => {
     // Change "byFoo" to "foo".
diff --git a/mail/components/extensions/schemas/mailTabs.json b/mail/components/extensions/schemas/mailTabs.json
--- a/mail/components/extensions/schemas/mailTabs.json
+++ b/mail/components/extensions/schemas/mailTabs.json
@@ -54,9 +54,9 @@
             "enum": ["ungrouped", "groupedByThread", "groupedBySortType"]
           },
           "layout": {
             "type": "string",
-            "enum": ["standard", "wide", "vertical"]
+            "enum": ["standard", "wide", "vertical", "widethread", "stacked"]
           },
           "folderPaneVisible": {
             "type": "boolean",
             "optional": true
diff --git a/mail/locales/en-US/messenger/menubar.ftl b/mail/locales/en-US/messenger/menubar.ftl
--- a/mail/locales/en-US/messenger/menubar.ftl
+++ b/mail/locales/en-US/messenger/menubar.ftl
@@ -116,8 +116,16 @@ menu-multi-line-all-folders =
     .label = Multi-line View On All Folders
 
 ## View / Layout
 
+menu-view-layout-widethread =
+    .label = Wide Thread View
+    .accesskey = T
+
+menu-view-layout-stacked =
+    .label = Stacked View
+    .accesskey = S
+
 menu-view-toggle-thread-pane-header =
     .label = Message List Header
     .accesskey = H
 
diff --git a/mail/themes/shared/mail/about3Pane.css b/mail/themes/shared/mail/about3Pane.css
--- a/mail/themes/shared/mail/about3Pane.css
+++ b/mail/themes/shared/mail/about3Pane.css
@@ -94,8 +94,9 @@ body {
   text-shadow: none;
 
   display: grid;
   --folderPaneSplitter-width: 18em;
+  --folderPaneSplitter-height: 18em;
   --messagePaneSplitter-width: 54em;
   --messagePaneSplitter-height: 36em;
 
   /* Classic layout: folder tree on the left, thread tree and message browser on the right. */
@@ -119,8 +120,24 @@ body {
                    "message message message" minmax(auto, var(--messagePaneSplitter-height))
                    / minmax(auto, var(--folderPaneSplitter-width)) min-content minmax(auto, 1fr);
   }
 
+  /* Wide thread layout: thread tree across the top, and folder tree and message browser on the bottom. */
+  &.layout-widethread {
+    grid-template: "threads threads threads" minmax(auto, 1fr)
+                   "messagePaneSplitter messagePaneSplitter messagePaneSplitter" min-content
+                   "folders folderPaneSplitter message" minmax(auto, var(--messagePaneSplitter-height))
+                   / minmax(auto, var(--folderPaneSplitter-width)) min-content minmax(auto, 1fr);
+  }
+
+  /* Stacked layout: folder tree and thread tree on the left, and message browser on the right. */
+  &.layout-stacked {
+    grid-template: "folders messagePaneSplitter message" minmax(auto, var(--folderPaneSplitter-height))
+                   "folderPaneSplitter messagePaneSplitter message" min-content
+                   "threads messagePaneSplitter message" minmax(auto, 1fr)
+                   / minmax(auto, 1fr) min-content minmax( var(--messagePaneSplitter-width), 1fr);
+  }
+
   /* If Account Central is shown, it overrides the layout setting. */
   &.account-central {
     grid-template: "folders folderPaneSplitter account-central" auto
                    / minmax(auto, var(--folderPaneSplitter-width)) min-content minmax(auto, 1fr);
