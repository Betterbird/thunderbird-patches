# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1722294074 -7200
# Parent  e20f94f2f414fa831af882072b9143ac11fae10b
Feature: Reversed threading (bug 305741). Additional changes.

diff --git a/mailnews/base/src/nsMsgDBView.cpp b/mailnews/base/src/nsMsgDBView.cpp
--- a/mailnews/base/src/nsMsgDBView.cpp
+++ b/mailnews/base/src/nsMsgDBView.cpp
@@ -5322,11 +5322,16 @@ bool nsMsgDBView::WantsThisThread(nsIMsg
 
 nsMsgViewIndex nsMsgDBView::FindParentInThread(
     nsMsgKey parentKey, nsMsgViewIndex startOfThreadViewIndex) {
   nsCOMPtr<nsIMsgDBHdr> msgHdr;
+  bool reversed = ReversedThreading();
   while (parentKey != nsMsgKey_None) {
-    nsMsgViewIndex parentIndex =
-        m_keys.IndexOf(parentKey, startOfThreadViewIndex);
+    nsMsgViewIndex parentIndex;
+    if (reversed) {
+      parentIndex = m_keys.LastIndexOf(parentKey, startOfThreadViewIndex);
+    } else {
+      parentIndex = m_keys.IndexOf(parentKey, startOfThreadViewIndex);
+    }
     if (parentIndex != nsMsgViewIndex_None) return parentIndex;
 
     if (NS_FAILED(m_db->GetMsgHdrForKey(parentKey, getter_AddRefs(msgHdr))))
       break;
diff --git a/mailnews/base/src/nsMsgThreadedDBView.cpp b/mailnews/base/src/nsMsgThreadedDBView.cpp
--- a/mailnews/base/src/nsMsgThreadedDBView.cpp
+++ b/mailnews/base/src/nsMsgThreadedDBView.cpp
@@ -647,13 +647,23 @@ nsMsgThreadedDBView::OnParentChanged(nsM
 }
 
 nsMsgViewIndex nsMsgThreadedDBView::GetInsertInfoForNewHdr(
     nsIMsgDBHdr* newHdr, nsMsgViewIndex parentIndex, int32_t targetLevel) {
-  uint32_t viewSize = GetSize();
-  while (++parentIndex < viewSize) {
-    // Loop until we find a message at a level less than or equal to the
-    // parent level
-    if (m_levels[parentIndex] < targetLevel) break;
+  if (ReversedThreading()) {
+    int32_t pi = parentIndex;
+    while (--pi >= 0) {
+      // Loop until we find a message at a level less than or equal to the
+      // parent level
+      if (m_levels[pi] < targetLevel) break;
+    }
+    parentIndex = pi + 1;
+  } else {
+    uint32_t viewSize = GetSize();
+    while (++parentIndex < viewSize) {
+      // Loop until we find a message at a level less than or equal to the
+      // parent level
+      if (m_levels[parentIndex] < targetLevel) break;
+    }
   }
 
   return parentIndex;
 }
