# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1722516176 -7200
# Parent  cb4a6593cacaa063514b276767ab30a4507eaa6e
Feature: Reversed threading (bug 305741). Additional changes.

diff --git a/mailnews/base/src/nsMsgDBView.cpp b/mailnews/base/src/nsMsgDBView.cpp
--- a/mailnews/base/src/nsMsgDBView.cpp
+++ b/mailnews/base/src/nsMsgDBView.cpp
@@ -5136,8 +5136,12 @@ nsMsgViewIndex nsMsgDBView::GetIndexForT
       while (lowIndex < GetSize() && m_levels[lowIndex]) lowIndex++;
     }
   }
 
+  if (ReversedThreading()) {
+    // If the row at `highIndex` is expanded, reduce to its topmost child.
+    while (highIndex > 0 && m_levels[highIndex -1]) highIndex--;
+  }
   return highIndex;
 }
 
 nsMsgViewIndex nsMsgDBView::GetInsertIndexHelper(
@@ -5322,11 +5326,16 @@ bool nsMsgDBView::WantsThisThread(nsIMsg
 
 nsMsgViewIndex nsMsgDBView::FindParentInThread(
     nsMsgKey parentKey, nsMsgViewIndex startOfThreadViewIndex) {
   nsCOMPtr<nsIMsgDBHdr> msgHdr;
+  bool reversed = ReversedThreading();
   while (parentKey != nsMsgKey_None) {
-    nsMsgViewIndex parentIndex =
-        m_keys.IndexOf(parentKey, startOfThreadViewIndex);
+    nsMsgViewIndex parentIndex;
+    if (reversed) {
+      parentIndex = m_keys.LastIndexOf(parentKey, startOfThreadViewIndex);
+    } else {
+      parentIndex = m_keys.IndexOf(parentKey, startOfThreadViewIndex);
+    }
     if (parentIndex != nsMsgViewIndex_None) return parentIndex;
 
     if (NS_FAILED(m_db->GetMsgHdrForKey(parentKey, getter_AddRefs(msgHdr))))
       break;
@@ -5711,8 +5720,13 @@ nsMsgViewIndex nsMsgDBView::GetThreadRoo
       while (lowIndex < GetSize() && m_levels[lowIndex]) lowIndex++;
     }
   }
 
+  if (ReversedThreading()) {
+    // If the row at `highIndex` is expanded, reduce to its topmost child.
+    while (highIndex > 0 && m_levels[highIndex -1]) highIndex--;
+  }
+
   nsCOMPtr<nsIMsgDBHdr> resultHdr;
   GetMsgHdrForViewIndex(highIndex, getter_AddRefs(resultHdr));
 
   if (resultHdr != msgHdr) {
diff --git a/mailnews/base/src/nsMsgQuickSearchDBView.cpp b/mailnews/base/src/nsMsgQuickSearchDBView.cpp
--- a/mailnews/base/src/nsMsgQuickSearchDBView.cpp
+++ b/mailnews/base/src/nsMsgQuickSearchDBView.cpp
@@ -515,10 +515,15 @@ nsresult nsMsgQuickSearchDBView::SortThr
         nsMsgViewIndex rootIndex = startOfThreadViewIndex - 1;
         uint32_t numListed = 0;
         ListIdsInThreadOrder(threadHdr, rootKey, 1, &startOfThreadViewIndex,
                              &numListed);
-        if (numListed > 0)
-          m_flags[rootIndex] = rootFlags | MSG_VIEW_FLAG_HASCHILDREN;
+        if (numListed > 0) {
+          if (ReversedThreading()) {
+            m_flags[rootIndex + numListed] = rootFlags | MSG_VIEW_FLAG_HASCHILDREN;
+          } else {
+            m_flags[rootIndex] = rootFlags | MSG_VIEW_FLAG_HASCHILDREN;
+          }
+        }
       }
     }
   }
 
@@ -615,8 +620,9 @@ nsresult nsMsgQuickSearchDBView::ListIds
 nsresult nsMsgQuickSearchDBView::ListIdsInThreadOrder(
     nsIMsgThread* threadHdr, nsMsgKey parentKey, uint32_t level,
     uint32_t callLevel, nsMsgKey keyToSkip, nsMsgViewIndex* viewIndex,
     uint32_t* pNumListed) {
+  nsMsgViewIndex viewIndexStart = *viewIndex;
   nsCOMPtr<nsIMsgEnumerator> msgEnumerator;
   nsresult rv =
       threadHdr->EnumerateMessages(parentKey, getter_AddRefs(msgEnumerator));
   NS_ENSURE_SUCCESS(rv, rv);
@@ -658,8 +664,28 @@ nsresult nsMsgQuickSearchDBView::ListIds
     rv = ListIdsInThreadOrder(threadHdr, msgKey, childLevel, callLevel + 1,
                               keyToSkip, viewIndex, pNumListed);
     NS_ENSURE_SUCCESS(rv, rv);
   }
+
+  if (ReversedThreading() && level == 1) {
+    // Reverse everything we added, and the one before.
+    nsMsgViewIndex i = viewIndexStart - 1;
+    nsMsgViewIndex j = *viewIndex - 1;
+
+#define swap(type, var) \
+  {                     \
+    type val = var[i];  \
+    var[i] = var[j];    \
+    var[j] = val;       \
+  }
+    while (i < j) {
+      swap(nsMsgKey, m_keys);
+      swap(uint32_t, m_flags);
+      swap(uint8_t, m_levels);
+      i++;
+      j--;
+    }
+  }
   return rv;
 }
 
 nsresult nsMsgQuickSearchDBView::ListIdsInThreadOrder(nsIMsgThread* threadHdr,
diff --git a/mailnews/base/src/nsMsgSearchDBView.cpp b/mailnews/base/src/nsMsgSearchDBView.cpp
--- a/mailnews/base/src/nsMsgSearchDBView.cpp
+++ b/mailnews/base/src/nsMsgSearchDBView.cpp
@@ -462,39 +462,69 @@ nsresult nsMsgSearchDBView::AddHdrFromFo
           // Since we know posInThread, we just want to insert the new hdr
           // at threadIndex + posInThread, and then rebuild the view until we
           // get to a sibling of the new hdr.
           uint8_t newMsgLevel = viewThread->ChildLevelAt(posInThread);
-          InsertMsgHdrAt(threadIndex + posInThread, msgHdr, msgKey, msgFlags,
-                         newMsgLevel);
+          if (ReversedThreading()) {
+            InsertMsgHdrAt(threadIndex - posInThread + 1, msgHdr, msgKey, msgFlags,
+                           newMsgLevel);
 
-          NoteChange(threadIndex + posInThread, 1,
-                     nsMsgViewNotificationCode::insertOrDelete);
-          for (nsMsgViewIndex viewIndex = threadIndex + ++posInThread;
-               posInThread < viewThread->MsgCount() &&
-               viewThread->ChildLevelAt(posInThread) > newMsgLevel;
-               viewIndex++) {
-            m_levels[viewIndex] = viewThread->ChildLevelAt(posInThread++);
+            NoteChange(threadIndex - posInThread + 1, 1,
+                       nsMsgViewNotificationCode::insertOrDelete);
+            for (int32_t viewIndex = threadIndex - ++posInThread + 1;
+                 viewIndex >= 0 && posInThread < viewThread->MsgCount() &&
+                 viewThread->ChildLevelAt(posInThread) > newMsgLevel;
+                 viewIndex--) {
+              m_levels[viewIndex] = viewThread->ChildLevelAt(posInThread++);
+            }
+            // We inserted before `threadIndex`, so this is now one further down.
+            threadIndex++;
+          } else {
+            InsertMsgHdrAt(threadIndex + posInThread, msgHdr, msgKey, msgFlags,
+                           newMsgLevel);
+
+            NoteChange(threadIndex + posInThread, 1,
+                       nsMsgViewNotificationCode::insertOrDelete);
+            for (nsMsgViewIndex viewIndex = threadIndex + ++posInThread;
+                 posInThread < viewThread->MsgCount() &&
+                 viewThread->ChildLevelAt(posInThread) > newMsgLevel;
+                 viewIndex++) {
+              m_levels[viewIndex] = viewThread->ChildLevelAt(posInThread++);
+            }
           }
-
         } else {
           // The new header is the root, so we need to adjust all the children.
           InsertMsgHdrAt(threadIndex, msgHdr, msgKey, msgFlags, 0);
           OrExtraFlag(threadIndex,
                       MSG_VIEW_FLAG_HASCHILDREN | MSG_VIEW_FLAG_ISTHREAD);
 
           NoteChange(threadIndex, 1, nsMsgViewNotificationCode::insertOrDelete);
-          nsMsgViewIndex i;
-          for (i = threadIndex + 1;
-               i < m_keys.Length() && (i == threadIndex + 1 || m_levels[i]);
-               i++)
-            m_levels[i] = m_levels[i] + 1;
-          // Turn off thread flags on old root.
-          AndExtraFlag(threadIndex + 1,
-                       ~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided |
-                         MSG_VIEW_FLAG_HASCHILDREN));
+          if (ReversedThreading()) {
+            int32_t i;
+            for (i = threadIndex - 1;
+                 i >=0 && ((nsMsgViewIndex)i == threadIndex - 1 || m_levels[i]);
+                 i--)
+              m_levels[i] = m_levels[i] + 1;
+            // Turn off thread flags on old root.
+            AndExtraFlag(threadIndex - 1,
+                         ~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided |
+                           MSG_VIEW_FLAG_HASCHILDREN));
 
-          NoteChange(threadIndex + 1, i - threadIndex + 1,
-                     nsMsgViewNotificationCode::changed);
+            NoteChange(threadIndex - 1, i - (threadIndex - 1),
+                       nsMsgViewNotificationCode::changed);
+          } else {
+            nsMsgViewIndex i;
+            for (i = threadIndex + 1;
+                 i < m_keys.Length() && (i == threadIndex + 1 || m_levels[i]);
+                 i++)
+              m_levels[i] = m_levels[i] + 1;
+            // Turn off thread flags on old root.
+            AndExtraFlag(threadIndex + 1,
+                         ~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided |
+                           MSG_VIEW_FLAG_HASCHILDREN));
+
+            NoteChange(threadIndex + 1, i - threadIndex + 1,
+                       nsMsgViewNotificationCode::changed);
+          }
         }
       } else if (!parent) {
         // New parent came into collapsed thread.
         nsCOMPtr<nsIMsgFolder> msgFolder;
@@ -564,18 +594,32 @@ void nsMsgSearchDBView::MoveThreadAt(nsM
     threadKeys.SetCapacity(childCount);
     threadFlags.SetCapacity(childCount);
     threadLevels.SetCapacity(childCount);
     threadFolders.SetCapacity(childCount);
-    for (nsMsgViewIndex index = threadIndex + 1;
-         index < (nsMsgViewIndex)GetSize() && m_levels[index]; index++) {
-      threadKeys.AppendElement(m_keys[index]);
-      threadFlags.AppendElement(m_flags[index]);
-      threadLevels.AppendElement(m_levels[index]);
-      threadFolders.AppendObject(m_folders[index]);
+    if (ReversedThreading()) {
+      for (nsMsgViewIndex index = threadIndex - childCount;
+           index < threadIndex; index++) {
+        threadKeys.AppendElement(m_keys[index]);
+        threadFlags.AppendElement(m_flags[index]);
+        threadLevels.AppendElement(m_levels[index]);
+        threadFolders.AppendObject(m_folders[index]);
+      }
+    } else {
+      for (nsMsgViewIndex index = threadIndex + 1;
+           index < (nsMsgViewIndex)GetSize() && m_levels[index]; index++) {
+        threadKeys.AppendElement(m_keys[index]);
+        threadFlags.AppendElement(m_flags[index]);
+        threadLevels.AppendElement(m_levels[index]);
+        threadFolders.AppendObject(m_folders[index]);
+      }
     }
 
     uint32_t collapseCount;
     CollapseByIndex(threadIndex, &collapseCount);
+    if (ReversedThreading()) {
+      // Thread parent has moved down due to child removal.
+      threadIndex -= childCount;
+    }
   }
 
   nsMsgDBView::RemoveByIndex(threadIndex);
   m_folders.RemoveObjectAt(threadIndex);
@@ -591,24 +635,45 @@ void nsMsgSearchDBView::MoveThreadAt(nsM
   threadHdr->GetFlags(&msgFlags);
   InsertMsgHdrAt(newIndex, threadHdr, msgKey, msgFlags, 0);
 
   if (threadIsExpanded) {
-    m_keys.InsertElementsAt(newIndex + 1, threadKeys);
-    m_flags.InsertElementsAt(newIndex + 1, threadFlags);
-    m_levels.InsertElementsAt(newIndex + 1, threadLevels);
-    m_folders.InsertObjectsAt(threadFolders, newIndex + 1);
+    if (ReversedThreading()) {
+      m_keys.InsertElementsAt(newIndex, threadKeys);
+      m_flags.InsertElementsAt(newIndex, threadFlags);
+      m_levels.InsertElementsAt(newIndex, threadLevels);
+      m_folders.InsertObjectsAt(threadFolders, newIndex);
+    } else {
+      m_keys.InsertElementsAt(newIndex + 1, threadKeys);
+      m_flags.InsertElementsAt(newIndex + 1, threadFlags);
+      m_levels.InsertElementsAt(newIndex + 1, threadLevels);
+      m_folders.InsertObjectsAt(threadFolders, newIndex + 1);
+    }
   }
 
-  m_flags[newIndex] = saveFlags;
+  if (ReversedThreading()) {
+    // Thread parent has moved up due to child insertion.
+    threadIndex += childCount;
+  }
+
+  if (ReversedThreading()) {
+    m_flags[newIndex + childCount] = saveFlags;
+  } else {
+    m_flags[newIndex] = saveFlags;
+  }
   // Unfreeze selection.
   if (hasSelection) RestoreSelection(preservedKey, preservedSelection);
 
   if (!updatesSuppressed) SetSuppressChangeNotifications(false);
 
   nsMsgViewIndex lowIndex = threadIndex < newIndex ? threadIndex : newIndex;
   nsMsgViewIndex highIndex = lowIndex == threadIndex ? newIndex : threadIndex;
-  NoteChange(lowIndex, highIndex - lowIndex + childCount + 1,
-             nsMsgViewNotificationCode::changed);
+  if (ReversedThreading()) {
+    NoteChange(lowIndex - childCount, highIndex - lowIndex + childCount + 1,
+               nsMsgViewNotificationCode::changed);
+  } else {
+    NoteChange(lowIndex, highIndex - lowIndex + childCount + 1,
+               nsMsgViewNotificationCode::changed);
+  }
 }
 
 nsresult nsMsgSearchDBView::GetMessageEnumerator(
     nsIMsgEnumerator** enumerator) {
@@ -817,18 +882,32 @@ nsresult nsMsgSearchDBView::RemoveByInde
       }
 
       // Bump up the level of all the descendants of the message
       // that was removed, if the thread was expanded.
-      uint8_t removedLevel = m_levels[index];
-      nsMsgViewIndex i = index + 1;
-      if (i < m_levels.Length() && m_levels[i] > removedLevel) {
-        // Promote the child of the removed message.
-        uint8_t promotedLevel = m_levels[i];
-        m_levels[i] = promotedLevel - 1;
-        i++;
-        // Now promote all the children of the promoted message.
-        for (; i < m_levels.Length() && m_levels[i] > promotedLevel; i++)
-          m_levels[i] = m_levels[i] - 1;
+      if (ReversedThreading()) {
+        uint8_t removedLevel = m_levels[index];
+        int32_t i = index - 1;
+        if (i >=0 && m_levels[i] > removedLevel) {
+          // Promote the child of the removed message.
+          uint8_t promotedLevel = m_levels[i];
+          m_levels[i] = promotedLevel - 1;
+          i--;
+          // Now promote all the children of the promoted message.
+          for (; i >= 0 && m_levels[i] > promotedLevel; i--)
+            m_levels[i] = m_levels[i] - 1;
+        }
+      } else {
+        uint8_t removedLevel = m_levels[index];
+        nsMsgViewIndex i = index + 1;
+        if (i < m_levels.Length() && m_levels[i] > removedLevel) {
+          // Promote the child of the removed message.
+          uint8_t promotedLevel = m_levels[i];
+          m_levels[i] = promotedLevel - 1;
+          i++;
+          // Now promote all the children of the promoted message.
+          for (; i < m_levels.Length() && m_levels[i] > promotedLevel; i++)
+            m_levels[i] = m_levels[i] - 1;
+        }
       }
     }
   }
 
diff --git a/mailnews/base/src/nsMsgThreadedDBView.cpp b/mailnews/base/src/nsMsgThreadedDBView.cpp
--- a/mailnews/base/src/nsMsgThreadedDBView.cpp
+++ b/mailnews/base/src/nsMsgThreadedDBView.cpp
@@ -565,8 +565,13 @@ nsresult nsMsgThreadedDBView::OnNewHeade
       // NoteChange() will call RowCountChanged() which will call our
       // GetRowCount().
       NoteChange(insertIndex, 1, nsMsgViewNotificationCode::insertOrDelete);
 
+      if (ReversedThreading()) {
+        // We inserted before `threadIndex`, so this is now one further down.
+        threadIndex++;
+      }
+
       if (aParentKey == nsMsgKey_None) {
         // this header is the new king! try collapsing the existing thread,
         // removing it, installing this header as king, and expanding it.
         CollapseByIndex(threadIndex, nullptr);
@@ -647,13 +652,23 @@ nsMsgThreadedDBView::OnParentChanged(nsM
 }
 
 nsMsgViewIndex nsMsgThreadedDBView::GetInsertInfoForNewHdr(
     nsIMsgDBHdr* newHdr, nsMsgViewIndex parentIndex, int32_t targetLevel) {
-  uint32_t viewSize = GetSize();
-  while (++parentIndex < viewSize) {
-    // Loop until we find a message at a level less than or equal to the
-    // parent level
-    if (m_levels[parentIndex] < targetLevel) break;
+  if (ReversedThreading()) {
+    int32_t pi = parentIndex;
+    while (--pi >= 0) {
+      // Loop until we find a message at a level less than or equal to the
+      // parent level
+      if (m_levels[pi] < targetLevel) break;
+    }
+    parentIndex = pi + 1;
+  } else {
+    uint32_t viewSize = GetSize();
+    while (++parentIndex < viewSize) {
+      // Loop until we find a message at a level less than or equal to the
+      // parent level
+      if (m_levels[parentIndex] < targetLevel) break;
+    }
   }
 
   return parentIndex;
 }
@@ -702,17 +717,30 @@ void nsMsgThreadedDBView::MoveThreadAt(n
   if (threadIsExpanded) {
     threadKeys.SetCapacity(childCount);
     threadFlags.SetCapacity(childCount);
     threadLevels.SetCapacity(childCount);
-    for (nsMsgViewIndex index = threadIndex + 1;
-         index < GetSize() && m_levels[index]; index++) {
-      threadKeys.AppendElement(m_keys[index]);
-      threadFlags.AppendElement(m_flags[index]);
-      threadLevels.AppendElement(m_levels[index]);
+    if (ReversedThreading()) {
+      for (nsMsgViewIndex index = threadIndex - childCount;
+           index < threadIndex; index++) {
+        threadKeys.AppendElement(m_keys[index]);
+        threadFlags.AppendElement(m_flags[index]);
+        threadLevels.AppendElement(m_levels[index]);
+      }
+    } else {
+      for (nsMsgViewIndex index = threadIndex + 1;
+           index < GetSize() && m_levels[index]; index++) {
+        threadKeys.AppendElement(m_keys[index]);
+        threadFlags.AppendElement(m_flags[index]);
+        threadLevels.AppendElement(m_levels[index]);
+      }
     }
 
     uint32_t collapseCount;
     CollapseByIndex(threadIndex, &collapseCount);
+    if (ReversedThreading()) {
+      // Thread parent has moved down due to child removal.
+      threadIndex -= childCount;
+    }
   }
 
   nsMsgDBView::RemoveByIndex(threadIndex);
   nsMsgViewIndex newIndex = nsMsgViewIndex_None;
@@ -722,29 +750,49 @@ void nsMsgThreadedDBView::MoveThreadAt(n
   // is going to require some refactoring.
   if (newIndex == nsMsgViewIndex_None) newIndex = FindHdr(threadHdr);
 
   if (threadIsExpanded) {
-    m_keys.InsertElementsAt(newIndex + 1, threadKeys);
-    m_flags.InsertElementsAt(newIndex + 1, threadFlags);
-    m_levels.InsertElementsAt(newIndex + 1, threadLevels);
+    if (ReversedThreading()) {
+      m_keys.InsertElementsAt(newIndex, threadKeys);
+      m_flags.InsertElementsAt(newIndex, threadFlags);
+      m_levels.InsertElementsAt(newIndex, threadLevels);
+    } else {
+      m_keys.InsertElementsAt(newIndex + 1, threadKeys);
+      m_flags.InsertElementsAt(newIndex + 1, threadFlags);
+      m_levels.InsertElementsAt(newIndex + 1, threadLevels);
+    }
+  }
+
+  if (ReversedThreading()) {
+    // Thread parent has moved up due to child insertion.
+    threadIndex += childCount;
   }
 
   if (newIndex == nsMsgViewIndex_None) {
     NS_WARNING("newIndex=-1 in MoveThreadAt");
     newIndex = 0;
   }
 
-  m_flags[newIndex] = saveFlags;
+  if (ReversedThreading()) {
+    m_flags[newIndex + childCount] = saveFlags;
+  } else {
+    m_flags[newIndex] = saveFlags;
+  }
   // Unfreeze selection.
   if (hasSelection) RestoreSelection(preservedKey, preservedSelection);
 
   if (!changesDisabled) SetSuppressChangeNotifications(false);
 
   nsMsgViewIndex lowIndex = threadIndex < newIndex ? threadIndex : newIndex;
   nsMsgViewIndex highIndex = lowIndex == threadIndex ? newIndex : threadIndex;
 
-  NoteChange(lowIndex, highIndex - lowIndex + childCount + 1,
-             nsMsgViewNotificationCode::changed);
+  if (ReversedThreading()) {
+    NoteChange(lowIndex - childCount, highIndex - lowIndex + childCount + 1,
+               nsMsgViewNotificationCode::changed);
+  } else {
+    NoteChange(lowIndex, highIndex - lowIndex + childCount + 1,
+               nsMsgViewNotificationCode::changed);
+  }
 }
 
 nsresult nsMsgThreadedDBView::AddMsgToThreadNotInView(nsIMsgThread* threadHdr,
                                                       nsIMsgDBHdr* msgHdr,
