
# HG changeset patch
# User Ping Chen <remotenonsense@gmail.com>
# Date 1660675102 -7200
# Node ID f63073efa5130cf9b601d52e3a8fd1ddd43bb8de
# Parent  d7a2d9d5898dc5102854840db4473c977953620b
Bug 1782471 - Fix saving attachment and copying message in nntp-js. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D153435

diff --git a/mailnews/news/src/NntpMessageService.jsm b/mailnews/news/src/NntpMessageService.jsm
--- a/mailnews/news/src/NntpMessageService.jsm
+++ b/mailnews/news/src/NntpMessageService.jsm
@@ -13,22 +13,27 @@ XPCOMUtils.defineLazyModuleGetters(this,
   MailServices: "resource:///modules/MailServices.jsm",
   NntpChannel: "resource:///modules/NntpChannel.jsm",
   NntpUtils: "resource:///modules/NntpUtils.jsm",
 });
 
 /**
  * A message service for news-message://, mainly used for displaying messages.
  * @implements {nsIMsgMessageService}
+ * @implements {nsIMsgMessageFetchPartService}
  */
 class BaseMessageService {
-  QueryInterface = ChromeUtils.generateQI(["nsIMsgMessageService"]);
+  QueryInterface = ChromeUtils.generateQI([
+    "nsIMsgMessageService",
+    "nsIMsgMessageFetchPartService",
+  ]);
 
   _logger = NntpUtils.logger;
 
+  /** @see nsIMsgMessageService */
   DisplayMessage(
     messageURI,
     displayConsumer,
     msgWindow,
     urlListener,
     autodetectCharset,
     outURL
   ) {
@@ -96,16 +101,35 @@ class BaseMessageService {
     } else {
       throw Components.Exception(
         "displayConsumer should be instance of nsIDocShell",
         Cr.NS_ERROR_ILLEGAL_VALUE
       );
     }
   }
 
+  CopyMessage(
+    messageUri,
+    copyListener,
+    moveMessage,
+    urlListener,
+    msgWindow,
+    outUrl
+  ) {
+    this._logger.debug("CopyMessage", messageUri);
+    this.DisplayMessage(
+      messageUri,
+      copyListener,
+      msgWindow,
+      urlListener,
+      false,
+      outUrl
+    );
+  }
+
   SaveMessageToDisk(
     messageUri,
     file,
     addDummyEnvelope,
     urlListener,
     outUrl,
     canonicalLineEnding,
     msgWindow
@@ -211,16 +235,28 @@ class BaseMessageService {
     let url = new URL(`${host}/${encodeURIComponent(messageId)}`);
     url.searchParams.set("group", folder.name);
     url.searchParams.set("key", key);
     if (!url.port) {
       url.port = folder.server.port;
     }
     return url.toString();
   }
+
+  /** @see nsIMsgMessageFetchPartService */
+  fetchMimePart(uri, messageUri, displayConsumer, msgWindow, urlListener) {
+    this._logger.debug("fetchMimePart", uri.spec);
+    this.DisplayMessage(
+      uri.spec,
+      displayConsumer,
+      msgWindow,
+      urlListener,
+      false
+    );
+  }
 }
 
 /**
  * A message service for news-message://, mainly for displaying messages.
  */
 class NntpMessageService extends BaseMessageService {}
 
 NntpMessageService.prototype.classID = Components.ID(
