
# HG changeset patch
# User Ping Chen <remotenonsense@gmail.com>
# Date 1660739766 -7200
# Node ID cd45136da351509707e38f22d2bc14fc726f9667
# Parent  1077fb9c781e73b0a894d0ed43b1187f92f9be32
Bug 1783508 - Notify activity manager when STAT returns 0 message in Pop3Client. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D154321

diff --git a/mailnews/local/src/Pop3Client.jsm b/mailnews/local/src/Pop3Client.jsm
--- a/mailnews/local/src/Pop3Client.jsm
+++ b/mailnews/local/src/Pop3Client.jsm
@@ -6,16 +6,19 @@ const EXPORTED_SYMBOLS = ["Pop3Client"];
 
 var { setTimeout } = ChromeUtils.import("resource://gre/modules/Timer.jsm");
 var { AppConstants } = ChromeUtils.import(
   "resource://gre/modules/AppConstants.jsm"
 );
 var { CommonUtils } = ChromeUtils.import("resource://services-common/utils.js");
 var { Services } = ChromeUtils.import("resource://gre/modules/Services.jsm");
 var { LineReader } = ChromeUtils.import("resource:///modules/LineReader.jsm");
+var { MailServices } = ChromeUtils.import(
+  "resource:///modules/MailServices.jsm"
+);
 var { MailCryptoUtils } = ChromeUtils.import(
   "resource:///modules/MailCryptoUtils.jsm"
 );
 var { Pop3Authenticator } = ChromeUtils.import(
   "resource:///modules/MailAuthenticator.jsm"
 );
 
 /**
@@ -877,16 +880,17 @@ class Pop3Client {
 
     let numberOfMessages = Number.parseInt(res.statusText);
     if (!numberOfMessages) {
       if (this._uidlMap.size) {
         this._uidlMap.clear();
         this._uidlMapChanged = true;
       }
       // Finish if there is no message.
+      MailServices.pop3.notifyDownloadCompleted(this._sink.folder, 0);
       this._actionDone();
       return;
     }
     if (!this._downloadMail && !this._server.leaveMessagesOnServer) {
       // We are not downloading new mails, so finish now.
       this._sink.setBiffStateAndUpdateFE(
         Ci.nsIMsgFolder.nsMsgBiffState_NewMail,
         numberOfMessages,
