# vim: se ft=diff :
# HG changeset patch
# User Gene Smith <gds@chartertn.net>
# Date 1652122737 14400
Bug 1759883 - Subscribe/unsubscribe to oauth2 imap folders requires restart. r=benc

diff --git a/mailnews/imap/src/nsImapIncomingServer.cpp b/mailnews/imap/src/nsImapIncomingServer.cpp
--- a/mailnews/imap/src/nsImapIncomingServer.cpp
+++ b/mailnews/imap/src/nsImapIncomingServer.cpp
@@ -863,17 +863,22 @@ NS_IMETHODIMP nsImapIncomingServer::Rese
 
 NS_IMETHODIMP
 nsImapIncomingServer::PerformExpand(nsIMsgWindow* aMsgWindow) {
   nsString password;
   nsresult rv;
   rv = GetPassword(password);
   NS_ENSURE_SUCCESS(rv, rv);
 
-  if (password.IsEmpty()) return NS_OK;
+  if (password.IsEmpty()) {
+    // Check if this is due to oauth2 showing empty password. If so, keep going.
+    int32_t authMethod = 0;
+    GetAuthMethod(&authMethod);
+    if (authMethod != nsMsgAuthMethod::OAuth2) return NS_OK;
+  }
 
   rv = ResetFoldersToUnverified(nullptr);
 
   nsCOMPtr<nsIMsgFolder> rootMsgFolder;
   rv = GetRootFolder(getter_AddRefs(rootMsgFolder));
   NS_ENSURE_SUCCESS(rv, rv);
 
   if (!rootMsgFolder) return NS_ERROR_FAILURE;
