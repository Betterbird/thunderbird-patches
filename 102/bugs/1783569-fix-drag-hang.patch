# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Parent  7697bfb2d2cf3247e3482c148f71250f086cf067
Bug 1783569 - Fix hang when dragging news article from synchronised folder to desktop.

diff --git a/mailnews/news/src/NntpChannel.jsm b/mailnews/news/src/NntpChannel.jsm
--- a/mailnews/news/src/NntpChannel.jsm
+++ b/mailnews/news/src/NntpChannel.jsm
@@ -255,36 +255,38 @@ class NntpChannel {
   /**
    * Retrieve the article from the server.
    */
   _readFromServer() {
     let pipe = Cc["@mozilla.org/pipe;1"].createInstance(Ci.nsIPipe);
     pipe.init(true, true, 0, 0);
     let inputStream = pipe.inputStream;
     let outputStream = pipe.outputStream;
+    // Remove any "?filename=" or "&filename=" query.
+    let articleNumber = this._articleNumber.replace(/[&\?].*/, "");
     if (this._newsFolder) {
       this._newsFolder.saveArticleOffline = this._newsFolder.shouldStoreMsgOffline(
-        this._articleNumber
+        articleNumber
       );
     }
 
     this._server.wrappedJSObject.withClient(client => {
       client.runningUri = this.URI.QueryInterface(Ci.nsIMsgMailNewsUrl);
       this._listener.onStartRequest(this);
       client.onOpen = () => {
         let msgWindow;
         try {
           msgWindow = this.URI.msgWindow;
         } catch (e) {}
         if (this._messageId) {
           client.getArticleByMessageId(this._messageId, msgWindow);
         } else {
           client.getArticleByArticleNumber(
             this._groupName,
-            this._articleNumber,
+            articleNumber,
             msgWindow
           );
         }
       };
 
       client.onData = data => {
         outputStream.write(data, data.length);
         this._listener.onDataAvailable(this, inputStream, 0, data.length);
