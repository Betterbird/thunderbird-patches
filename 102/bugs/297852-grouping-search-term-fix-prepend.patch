# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Parent  7b0787ed8b3022fcb20aedf011b4eed911520224
Bug 297852 - Allow grouping in search term UI: Fix issue when prepending term at top level.

diff --git a/mailnews/search/content/searchTerm.js b/mailnews/search/content/searchTerm.js
--- a/mailnews/search/content/searchTerm.js
+++ b/mailnews/search/content/searchTerm.js
@@ -599,30 +599,29 @@ function onMore(event) {
           break;
         }
       }
       loopIdx--;
     }
     try {
       // This will fail if no next term.
       let nextTermIdx = termIdxFromRichlistIdx(richlistIdx + 1);
-      if (
-        nextTermIdx == termIdx + 1 &&
-        gSearchTerms[nextTermIdx].obj.beginsGrouping
-      ) {
-        if (gSearchTerms[nextTermIdx].level < gSearchTerms[termIdx].level) {
-          gSearchTerms[termIdx].obj.beginsGrouping += gSearchTerms[nextTermIdx].obj.beginsGrouping;
+      if (nextTermIdx == termIdx + 1) {
+        if (gSearchTerms[nextTermIdx].obj.beginsGrouping) {
+          if (gSearchTerms[nextTermIdx].level < gSearchTerms[termIdx].level) {
+            gSearchTerms[termIdx].obj.beginsGrouping += gSearchTerms[nextTermIdx].obj.beginsGrouping;
+          }
+          gSearchTerms[nextTermIdx].obj.beginsGrouping = 0;
+          if (verbose) {
+            console.log(
+              `searchTerm: onMore begin moved ${nextTermIdx} to ${termIdx}`
+            );
+          }
         }
-        gSearchTerms[nextTermIdx].obj.beginsGrouping = 0;
-        if (verbose) {
-          console.log(
-            `searchTerm: onMore begin moved ${nextTermIdx} to ${termIdx}`
-          );
-        }
-        // Apply correct and/Or to the next term.
+        // Apply correct and/or to the next term.
         gSearchTerms[nextTermIdx].obj.booleanAnd = groupAndOr;
         if (verbose) {
           console.log(
             `searchTerm: onMore ${termIdx} (next) set to ${
               gSearchTerms[nextTermIdx].obj.booleanAnd ? "and" : "or"
             }`
           );
         }
