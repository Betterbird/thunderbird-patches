
# HG changeset patch
# User Kai Engert <kaie@kuix.de>
# Date 1656749168 -7200
# Node ID c4b6a72d280beef3daa6fec1b66ed1cd962c53b2
# Parent  0ab32c8a8cfee599bba3961aab6f8c3a44601871
Bug 1774991 - While still loading composer, don't broadcast encryption change events. r=darktrojan

Differential Revision: https://phabricator.services.mozilla.com/D149833

diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -114,16 +114,17 @@ var gAutoSaving;
 var gCurrentIdentity;
 var defaultSaveOperation;
 var gSendOperationInProgress;
 var gSaveOperationInProgress;
 var gCloseWindowAfterSave;
 var gSavedSendNowKey;
 var gContextMenu;
 var gLastFocusElement = null;
+var gLoadingComplete = false;
 
 var gAttachmentBucket;
 var gAttachmentCounter;
 var gRecentFiles;
 /**
  * typedef {Object} FocusArea
  * @property {Element} root - The root of a given area of the UI.
  * @property {moveFocusWithin} focus - A method to move the focus within the
@@ -3167,16 +3168,17 @@ function ComposeFieldsReady() {
     } catch (e) {
       dump("### textEditor.wrapWidth exception text: " + e + " - failed\n");
     }
   }
 
   CompFields2Recipients(gMsgCompose.compFields);
   SetComposeWindowTitle();
   updateEditableFields(false);
+  gLoadingComplete = true;
 }
 
 // checks if the passed in string is a mailto url, if it is, generates nsIMsgComposeParams
 // for the url and returns them.
 function handleMailtoArgs(mailtoUrl) {
   // see if the string is a mailto url....do this by checking the first 7 characters of the string
   if (mailtoUrl.toLowerCase().startsWith("mailto:")) {
     // if it is a mailto url, turn the mailto url into a MsgComposeParams object....
@@ -11199,19 +11201,24 @@ function setSendEncryptedAndSigned(encry
 
   if (!gSendEncrypted) {
     clearRecipientsWithKeyIssues();
   }
 
   showSendEncryptedAndSigned();
 
   updateEncryptedSubject();
-  window.dispatchEvent(
-    new CustomEvent("sendencryptedchange", { detail: { encrypted } })
-  );
+
+  // Don't broadcast change events while we're still loading,
+  // this can have side effects like bug 1774991.
+  if (gLoadingComplete) {
+    window.dispatchEvent(
+      new CustomEvent("sendencryptedchange", { detail: { encrypted } })
+    );
+  }
 }
 
 /**
  * Listen to the click events on the compose window.
  *
  * @param {Event} event - The DOM Event
  */
 function composeWindowOnClick(event) {
