# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1660472755 -7200
# Parent  4db51d62a0ba64ecff33e4c5714bdf0507a784fe
Bug 1775376 - Delay setting of dictionaries when composition is restored from draft.

diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -10755,17 +10755,38 @@ function InitEditor() {
     gMsgCompose.compFields.contentLanguage
   ) {
     draftLanguages = gMsgCompose.compFields.contentLanguage
       .split(",")
       .map(lang => lang.trim());
   }
 
   let dictionaries = getValidSpellcheckerDictionaries(draftLanguages);
-  ComposeChangeLanguage(dictionaries).catch(console.error);
+  // Setting dictionaries programatically is troublesome, looks
+  // like the windows needs a breather before it can accept them.
+  // 0 doesn't work, 100 ms also works, but 200 ms is safer but doesn't
+  // always work, let's try 300 ms.
+  // Somehow it work better without timeout for replies. Go figure!
+  switch (gComposeType) {
+    case Ci.nsIMsgCompType.Reply:
+    case Ci.nsIMsgCompType.ReplyAll:
+    case Ci.nsIMsgCompType.ReplyToSender:
+    case Ci.nsIMsgCompType.ReplyToGroup:
+    case Ci.nsIMsgCompType.ReplyToSenderAndGroup:
+    case Ci.nsIMsgCompType.ReplyWithTemplate:
+    case Ci.nsIMsgCompType.ReplyToList:
+      ComposeChangeLanguage(dictionaries).catch(console.error);
+      break;
+
+    default:
+      setTimeout(
+        () => ComposeChangeLanguage(dictionaries).catch(console.error),
+        300
+      );
+  }
 }
 
 function setFontSize(event) {
   // Increase Font Menuitem and Decrease Font Menuitem from the main menu
   // will call this function because of oncommand attribute on the menupopup
   // and fontSize will be null for such function calls.
   let fontSize = event.target.value;
   if (fontSize) {
