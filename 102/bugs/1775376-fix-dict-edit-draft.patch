# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1662405786 -7200
# Parent  63dd0ac4c02309afbf3f6261aef65a45e82b4a59
Bug 1775376 - Delay setting of dictionaries when composition is restored from draft.

diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -10787,17 +10787,39 @@ function InitEditor() {
     gMsgCompose.compFields.contentLanguage
   ) {
     draftLanguages = gMsgCompose.compFields.contentLanguage
       .split(",")
       .map(lang => lang.trim());
   }
 
   let dictionaries = getValidSpellcheckerDictionaries(draftLanguages);
-  ComposeChangeLanguage(dictionaries).catch(console.error);
+  // Setting dictionaries programatically is troublesome, looks
+  // like the windows needs a breather before it can accept them.
+  // 0 doesn't work, 100 ms also works, but 200 ms is safer but doesn't
+  // always work, let's try 300 ms. Replies take especially long.
+  let delay;
+  switch (gComposeType) {
+    case Ci.nsIMsgCompType.Reply:
+    case Ci.nsIMsgCompType.ReplyAll:
+    case Ci.nsIMsgCompType.ReplyToSender:
+    case Ci.nsIMsgCompType.ReplyToGroup:
+    case Ci.nsIMsgCompType.ReplyToSenderAndGroup:
+    case Ci.nsIMsgCompType.ReplyWithTemplate:
+    case Ci.nsIMsgCompType.ReplyToList:
+      delay = 500;
+      break;
+
+    default:
+      delay = 300;
+  }
+  setTimeout(
+    () => ComposeChangeLanguage(dictionaries).catch(console.error),
+    delay
+  );
 }
 
 function setFontSize(event) {
   // Increase Font Menuitem and Decrease Font Menuitem from the main menu
   // will call this function because of oncommand attribute on the menupopup
   // and fontSize will be null for such function calls.
   let fontSize = event.target.value;
   if (fontSize) {
