# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1688025052 -7200
# Parent  2d4670803d7d53cd565135a29a94734a3d10da12
Bug 580252 - Introduce pref gloda.list.immediate to open Gloda result list immediately.

diff --git a/mail/app/profile/all-thunderbird.js b/mail/app/profile/all-thunderbird.js
--- a/mail/app/profile/all-thunderbird.js
+++ b/mail/app/profile/all-thunderbird.js
@@ -631,16 +631,20 @@ pref("media.autoplay.enabled", false);
 pref("gloda.facetview.hidetimeline", true);
 
 // Behavior of sort-by setting in search results:
 // 0 - default to "relevance", and don't remember user setting when it is changed (== old behavior)
 // 1 - default to "date", but don't remember user setting when it is changed
 // 2 - default to "relevance", but remember user preference when it is changed
 // 3 - default to "date", but remember user preference when it is changed
 pref("gloda.facetview.sortby", 2);
+// 0 - Open facet view
+// 1 - Open facet view and list view
+// 2 - Open list view only (closing facet view)
+pref("gloda.list.immediate", 0);
 
 // Enable gloda by default!
 pref("mailnews.database.global.indexer.enabled", true);
 // Limit the number of gloda message results
 pref("mailnews.database.global.search.msg.limit", 1000);
 
 // Serif fonts look dated.  Switching those language families to sans-serif
 // where we think it makes sense.  Worth investigating for other font families
diff --git a/mail/base/content/glodaFacetTab.js b/mail/base/content/glodaFacetTab.js
--- a/mail/base/content/glodaFacetTab.js
+++ b/mail/base/content/glodaFacetTab.js
@@ -82,16 +82,31 @@ var glodaFacetTabType = {
         "chrome://messenger/content/glodaFacetView.xhtml"
       );
 
       // Wire up the search input icon click event
       let searchInput = aTab.panel.querySelector(".remote-gloda-search");
       searchInput.focus();
     }
 
+    let listImmediate = Services.prefs.getIntPref("gloda.list.immediate", 0);
+    if (listImmediate > 0) {
+      aTab.iframe.contentWindow.addEventListener("DOMContentLoaded", async () => {
+        let win = aTab.iframe.contentDocument.getElementById("browser").contentWindow;
+        let count = 0;
+        while (count++ < 20 && !win.FacetContext) {
+          await new Promise(r => top.window.setTimeout(r, 100));
+        }
+        win.FacetContext.showActiveSetInTab();
+        if (listImmediate > 1) {
+          let tabmail = top.window.document.getElementById("tabmail");
+          tabmail.closeTab(aTab);
+        }
+      }, { once: true });
+    }
     aTab.iframe.contentWindow.addEventListener("load", xulLoadHandler, {
       capture: false,
       once: true,
     });
     aTab.iframe.setAttribute(
       "src",
       "chrome://messenger/content/glodaFacetViewWrapper.xhtml"
     );
