# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1673537952 -3600
# Parent  8c5e05413a2add616f1ef1e5ccd1465649654c86
Feature: Linux systray.

diff --git a/mail/branding/betterbird/newmail22.png b/mail/branding/betterbird/newmail22.png
new file mode 100644
index 0000000000000000000000000000000000000000..2aa8dd360048befcbac031c31b37471ff5cd7de8
GIT binary patch
literal 1657
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
DM4t_U

diff --git a/mail/branding/branding-common.mozbuild b/mail/branding/branding-common.mozbuild
--- a/mail/branding/branding-common.mozbuild
+++ b/mail/branding/branding-common.mozbuild
@@ -29,10 +29,11 @@ def ThunderbirdBranding():
             "default128.png",
             "default16.png",
             "default22.png",
             "default24.png",
             "default256.png",
             "default32.png",
             "default48.png",
             "default64.png",
+            "newmail22.png",
             "TB-symbolic.svg",
         ]
diff --git a/mail/components/preferences/general.inc.xhtml b/mail/components/preferences/general.inc.xhtml
--- a/mail/components/preferences/general.inc.xhtml
+++ b/mail/components/preferences/general.inc.xhtml
@@ -391,34 +391,32 @@
           class="subcategory"
           data-category="paneGeneral">
       <html:h1 data-l10n-id="general-incoming-mail-header"/>
     </hbox>
 
     <html:div data-category="paneGeneral">
     <html:fieldset data-category="paneGeneral">
       <html:legend data-l10n-id="new-message-arrival"></html:legend>
-#if defined(XP_MACOSX) || defined(XP_WIN)
       <hbox align="center">
         <description flex="1" data-l10n-id="change-dock-icon"/>
         <hbox>
           <button is="highlightable-button" id="dockOptions"
                   oncommand="gGeneralPane.configureDockOptions();"
                   data-l10n-id="app-icon-options"
                   search-l10n-ids="
                     dock-options-window-dialog.title,
                     bounce-system-dock-icon.label,
                     dock-icon-legend,
                     dock-icon-show-label.value,
                     count-unread-messages-radio.label,
                     count-new-messages-radio.label,
                     notification-settings-info2"/>
         </hbox>
       </hbox>
-#endif
 #ifdef XP_MACOSX
       <description class="bold" data-l10n-id="notification-settings2"/>
 #else
       <hbox align="center">
         <checkbox id="newMailNotificationAlert"
                   data-l10n-id="animated-alert-label"
                   preference="mail.biff.show_alert"/>
         <spacer flex="1"/>
@@ -436,17 +434,17 @@
                     open-time-label-after.value"/>
         </hbox>
       </hbox>
       <hbox align="center" class="indent">
         <checkbox id="useSystemNotificationAlert"
                   data-l10n-id="biff-use-system-alert"
                   preference="mail.biff.use_system_alert"/>
       </hbox>
-#ifdef XP_WIN
+#if defined(XP_WIN) || defined(XP_UNIX)
       <vbox>
         <checkbox id="newMailNotificationTrayIcon"
                   preference="mail.biff.show_tray_icon"
                   data-l10n-id="tray-icon-unread-label"/>
         <description class="indent tip-caption"
                      flex="1"
                      data-l10n-id="tray-icon-unread-description"/>
       </vbox>
diff --git a/mail/components/preferences/jar.mn b/mail/components/preferences/jar.mn
--- a/mail/components/preferences/jar.mn
+++ b/mail/components/preferences/jar.mn
@@ -2,20 +2,18 @@
 # License, v. 2.0. If a copy of the MPL was not distributed with this
 # file, You can obtain one at http://mozilla.org/MPL/2.0/.
 
 messenger.jar:
 *   content/messenger/preferences/preferences.xhtml
     content/messenger/preferences/preferences.js
     content/messenger/preferences/preferencesTab.js
     content/messenger/preferences/general.js
-#if defined(XP_MACOSX) || defined(XP_WIN)
     content/messenger/preferences/dockoptions.js
 *   content/messenger/preferences/dockoptions.xhtml
-#endif
     content/messenger/preferences/chat.js
     content/messenger/preferences/messagestyle.js
     content/messenger/preferences/messengerLanguages.js
     content/messenger/preferences/messengerLanguages.xhtml
     content/messenger/preferences/colors.js
 *   content/messenger/preferences/colors.xhtml
     content/messenger/preferences/compose.js
     content/messenger/preferences/extensionControlled.js
diff --git a/mailnews/base/src/MailNotificationManager.jsm b/mailnews/base/src/MailNotificationManager.jsm
--- a/mailnews/base/src/MailNotificationManager.jsm
+++ b/mailnews/base/src/MailNotificationManager.jsm
@@ -51,24 +51,22 @@ class MailNotificationManager {
     this._bundle = Services.strings.createBundle(
       "chrome://messenger/locale/messenger.properties"
     );
     MailServices.mailSession.AddFolderListener(
       this,
       Ci.nsIFolderListener.intPropertyChanged
     );
 
-    if (["macosx", "win"].includes(AppConstants.platform)) {
-      // We don't have indicator for unread count on Linux yet.
-      Cc["@mozilla.org/newMailNotificationService;1"]
-        .getService(Ci.mozINewMailNotificationService)
-        .addListener(this, Ci.mozINewMailNotificationService.count);
-      Services.obs.addObserver(this, "unread-im-count-changed");
-      Services.obs.addObserver(this, "profile-before-change");
-    }
+    // We have an indicator for unread count on all platforms now.
+    Cc["@mozilla.org/newMailNotificationService;1"]
+      .getService(Ci.mozINewMailNotificationService)
+      .addListener(this, Ci.mozINewMailNotificationService.count);
+    Services.obs.addObserver(this, "unread-im-count-changed");
+    Services.obs.addObserver(this, "profile-before-change");
 
     if (AppConstants.platform == "macosx") {
       Services.obs.addObserver(this, "new-directed-incoming-message");
     }
     if (AppConstants.platform == "win") {
       Services.obs.addObserver(this, "profile-after-change");
       Services.obs.addObserver(this, "windows-refresh-badge-tray");
       Services.prefs.addObserver("mail.biff.show_badge", this);
@@ -442,25 +440,27 @@ class MailNotificationManager {
     }
     this._updatingUnreadCount = true;
 
     this._logger.debug(
       `Update unreadMailCount=${this._unreadMailCount}, unreadChatCount=${this._unreadChatCount}`
     );
     let count = this._unreadMailCount + this._unreadChatCount;
     let tooltip = "";
-    if (AppConstants.platform == "win") {
+    if (AppConstants.platform == "win" || AppConstants.platform == "linux") {
       if (count > 0) {
         tooltip = await l10n.formatValue("unread-messages-os-tooltip", {
           count,
         });
         if (this._unreadMailExtra) {
           tooltip += this._unreadMailExtra;
         }
       }
+    }
+    if (AppConstants.platform == "win") {
       if (Services.prefs.getBoolPref("mail.biff.show_badge", true)) {
         await WinUnreadBadge.updateUnreadCount(count, tooltip);
       } else {
         await WinUnreadBadge.updateUnreadCount(0, "");
       }
     }
     this._osIntegration?.updateUnreadCount(count, tooltip);
 
diff --git a/mailnews/base/src/components.conf b/mailnews/base/src/components.conf
--- a/mailnews/base/src/components.conf
+++ b/mailnews/base/src/components.conf
@@ -72,8 +72,19 @@ if buildconfig.substs['OS_ARCH'] == 'WIN
     Classes += [
         {
             'cid': '{a74dd1d6-2ec4-4985-98f3-f69e18d20811}',
             'contract_ids': ['@mozilla.org/messenger/osintegration;1'],
             'type': 'nsMessengerWinIntegration',
             'headers': ['/comm/mailnews/base/src/nsMessengerWinIntegration.h'],
         },
     ]
+
+# GUID from https://www.guidgenerator.com/online-guid-generator.aspx
+if buildconfig.substs["OS_ARCH"] == "Linux":
+    Classes += [
+        {
+            "cid": "{dec76c7d-3c55-4656-a622-21ae5f6a3efb}",
+            "contract_ids": ["@mozilla.org/messenger/osintegration;1"],
+            "type": "nsMessengerUnixIntegration",
+            "headers": ["/comm/mailnews/base/src/nsMessengerUnixIntegration.h"],
+        },
+    ]
diff --git a/mailnews/base/src/moz.build b/mailnews/base/src/moz.build
--- a/mailnews/base/src/moz.build
+++ b/mailnews/base/src/moz.build
@@ -93,16 +93,17 @@ SOURCES += [
 
 if CONFIG["OS_ARCH"] == "WINNT":
     SOURCES += [
         "nsMessengerWinIntegration.cpp",
         # This file cannot be built in unified mode because of name clashes with Windows headers.
         "nsUserInfoWin.cpp",
     ]
 elif CONFIG["MOZ_WIDGET_TOOLKIT"] == "gtk":
+    CXXFLAGS += CONFIG['MOZ_GTK3_CFLAGS']
     SOURCES += [
         "nsMessengerUnixIntegration.cpp",
         "nsUserInfoUnix.cpp",
     ]
 elif CONFIG["MOZ_WIDGET_TOOLKIT"] == "cocoa":
     SOURCES += [
         "nsMessengerOSXIntegration.mm",
         "nsUserInfoMac.mm",
diff --git a/mailnews/base/src/nsMessengerUnixIntegration.cpp b/mailnews/base/src/nsMessengerUnixIntegration.cpp
--- a/mailnews/base/src/nsMessengerUnixIntegration.cpp
+++ b/mailnews/base/src/nsMessengerUnixIntegration.cpp
@@ -1,24 +1,70 @@
 /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 #include "nsMessengerUnixIntegration.h"
 #include "nsString.h"
+#include "../../../third_party/appindicator/app-indicator.h"
+#include "mozilla/Preferences.h"
 
 /**
  * This is only a placeholder for now, register it in components.conf later if
  * needed.
  */
 nsMessengerUnixIntegration::nsMessengerUnixIntegration() {}
 
 NS_IMPL_ISUPPORTS(nsMessengerUnixIntegration, nsIMessengerOSIntegration)
 
 NS_IMETHODIMP
 nsMessengerUnixIntegration::UpdateUnreadCount(uint32_t unreadCount,
                                               const nsAString& unreadTooltip) {
+  if (!mozilla::Preferences::GetBool("mail.biff.show_tray_icon", false)) return NS_OK;
+
+  static AppIndicator *ci = NULL;
+  static char icon_path0[PATH_MAX + 100];
+  static char icon_pathN[PATH_MAX + 100];
+
+  if (!ci) {
+    // Find icon absolute path.
+    size_t len = readlink("/proc/self/exe", icon_path0, PATH_MAX);
+    char* q = icon_path0 + len - 1;
+    while (*q != '/') q--;
+    *q = 0;
+    strcpy(icon_pathN, icon_path0);
+    strcat(icon_path0, "/chrome/icons/default/default22.png");
+    strcat(icon_pathN, "/chrome/icons/default/newmail22.png");
+
+    ci = app_indicator_new("Betterbird-systray-icon",
+                           unreadCount > 0 ? icon_pathN : icon_path0,
+                           APP_INDICATOR_CATEGORY_APPLICATION_STATUS);
+  }
+
+  if (unreadCount > 0) {
+    const nsCString& tooltip = NS_ConvertUTF16toUTF8(unreadTooltip);
+    // Set both title and tooltip. It appears that some platforms do
+    // one but not the other.
+    app_indicator_set_title(ci, tooltip.get());
+    app_indicator_set_tooltip_full(ci,
+      NULL /* icon */, tooltip.get() /* title */, NULL /* body */
+    );
+    app_indicator_set_icon_full(ci, icon_pathN, "Betterbird");
+    app_indicator_set_status(ci, APP_INDICATOR_STATUS_ACTIVE);
+  } else {
+    if (mozilla::Preferences::GetBool("mail.biff.show_tray_icon_always", false)) {
+      app_indicator_set_title(ci, "Betterbird");
+      app_indicator_set_tooltip_full(ci,
+        NULL /* icon */, "Betterbird" /* title */, NULL /* body */
+      );
+      app_indicator_set_icon_full(ci, icon_path0, "Betterbird");
+      app_indicator_set_status(ci, APP_INDICATOR_STATUS_ACTIVE);
+    } else {
+      app_indicator_set_status(ci, APP_INDICATOR_STATUS_PASSIVE);
+    }
+  }
+
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsMessengerUnixIntegration::OnExit() { return NS_OK; }
diff --git a/mailnews/mailnews.js b/mailnews/mailnews.js
--- a/mailnews/mailnews.js
+++ b/mailnews/mailnews.js
@@ -868,16 +868,18 @@ pref("mail.biff.show_alert", true);
 #ifdef XP_WIN
 pref("mail.biff.show_badge", true);
 pref("mail.biff.show_tray_icon", true);
 pref("mail.biff.show_tray_icon_always", false);
 pref("mail.biff.use_system_alert", false);
 #elifdef XP_MACOSX
 pref("mail.biff.animate_dock_icon", false);
 #elifdef XP_UNIX
+pref("mail.biff.show_tray_icon", true);
+pref("mail.biff.show_tray_icon_always", false);
 pref("mail.biff.use_system_alert", true);
 #endif
 
 // add jitter to biff interval
 pref("mail.biff.add_interval_jitter", true);
 
 #ifdef MOZ_SUITE
 // if true, check for new mail even when opening non-mail windows
@@ -888,16 +890,20 @@ pref("mail.biff.on_new_window", true);
 // If true, the number shown in the badge will be the the number of "new"
 // messages, as per the classic Thunderbird definition. Defaults to false, which
 // notifies about the number of unread messages.
 pref("mail.biff.use_new_count_in_badge", false);
 #endif
 #ifdef XP_WIN
 pref("mail.biff.use_new_count_in_badge", true);
 #endif
+#ifdef XP_UNIX
+// "badge" means "systray icon".
+pref("mail.biff.use_new_count_in_badge", true);
+#endif
 
 pref("mail.biff.show_for_server", true);
 
 // For feed account serverType=rss sound on biff; if true, mail.biff.play_sound.* settings are used.
 pref("mail.feed.play_sound", false);
 
 // Content disposition for attachments (except binary files and vcards).
 //   0= Content-Disposition: inline
