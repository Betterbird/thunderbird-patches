# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1643141900 -3600
# Parent  d817f2c93a55d29eaa401077763bfe3b94cbbd8f
Bug 799040 - If ignored thread received new message, don't increase unread count.

diff --git a/mailnews/db/msgdb/src/nsMsgThread.cpp b/mailnews/db/msgdb/src/nsMsgThread.cpp
--- a/mailnews/db/msgdb/src/nsMsgThread.cpp
+++ b/mailnews/db/msgdb/src/nsMsgThread.cpp
@@ -353,18 +353,22 @@ NS_IMETHODIMP nsMsgThread::AddChild(nsIM
   if (!hdrMoved && moveIndex > 0) {
     mdb_pos outPos;
     m_mdbTable->MoveRow(m_mdbDB->GetEnv(), hdrRow, -1, moveIndex, &outPos);
   }
 
   // do this after we've put the new hdr in the thread
   bool isKilled;
   child->GetIsKilled(&isKilled);
-  if ((m_flags & nsMsgMessageFlags::Ignored || isKilled) && m_mdbDB)
+  if ((m_flags & nsMsgMessageFlags::Ignored || isKilled) && m_mdbDB) {
     m_mdbDB->MarkHdrRead(child, true, nullptr);
+    // If we don't count down the unread child count, the thread will
+    // carry an invisible unread child forever.
+    ChangeUnreadChildCount(-1);
+  }
 #ifdef DEBUG_David_Bienvenu
   nsMsgKey msgHdrThreadKey;
   child->GetThreadId(&msgHdrThreadKey);
   NS_ASSERTION(msgHdrThreadKey == m_threadKey,
                "adding msg to thread it doesn't belong to");
 #endif
   return rv;
 }
