# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1625697429 -7200
# Parent  e2659a0896ee8841c145ff410a384b417c9d7d0c
Bug 1663859 - Move all IMAP URI creation onto the main thread (analysis by Mark Banner).

diff --git a/mailnews/base/src/nsNewMailnewsURI.cpp b/mailnews/base/src/nsNewMailnewsURI.cpp
--- a/mailnews/base/src/nsNewMailnewsURI.cpp
+++ b/mailnews/base/src/nsNewMailnewsURI.cpp
@@ -42,17 +42,29 @@ nsresult NS_NewMailnewsURI(nsIURI** aURI
     if (NS_FAILED(rv)) return rv;
   }
 
   if (scheme.EqualsLiteral("mailbox") ||
       scheme.EqualsLiteral("mailbox-message")) {
     return nsMailboxService::NewURI(aSpec, aCharset, aBaseURI, aURI);
   }
   if (scheme.EqualsLiteral("imap") || scheme.EqualsLiteral("imap-message")) {
-    return nsImapService::NewURI(aSpec, aCharset, aBaseURI, aURI);
+    auto NewURI =
+        [&aSpec, &aCharset, &aBaseURI, aURI, &rv ]() -> auto {
+        rv = nsImapService::NewURI(aSpec, aCharset, aBaseURI, aURI);
+    };
+    if (NS_IsMainThread()) {
+      return nsImapService::NewURI(aSpec, aCharset, aBaseURI, aURI);
+    } else {
+      // Creating IMAP URIs off the main tread can lead to crashes.
+      // Seems to happen when viewing PDFs.
+      nsCOMPtr<nsIRunnable> task = NS_NewRunnableFunction("NewURI", NewURI);
+      mozilla::SyncRunnable::DispatchToThread(
+          mozilla::GetMainThreadEventTarget(), task);
+    }
   }
   if (scheme.EqualsLiteral("smtp") || scheme.EqualsLiteral("smtps")) {
     return nsSmtpService::NewSmtpURI(aSpec, aCharset, aBaseURI, aURI);
   }
   if (scheme.EqualsLiteral("mailto")) {
     return nsSmtpService::NewMailtoURI(aSpec, aCharset, aBaseURI, aURI);
   }
   if (scheme.EqualsLiteral("pop") || scheme.EqualsLiteral("pop3")) {
