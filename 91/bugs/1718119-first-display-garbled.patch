# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1625642716 -7200
# Parent  6f5ee6d24b49c07765d9f991f83e69193c64378a
Bug 1718119 - Hacky patch to fix the 'garbled on first display' issue.

diff --git a/mailnews/base/src/nsMsgProtocol.cpp b/mailnews/base/src/nsMsgProtocol.cpp
--- a/mailnews/base/src/nsMsgProtocol.cpp
+++ b/mailnews/base/src/nsMsgProtocol.cpp
@@ -593,18 +593,25 @@ NS_IMETHODIMP nsMsgProtocol::SetContentT
   nsAutoCString charset;
   nsresult rv =
       NS_ParseResponseContentType(aContentType, mContentType, charset);
   if (NS_FAILED(rv) || mContentType.IsEmpty())
     mContentType.AssignLiteral(UNKNOWN_CONTENT_TYPE);
   return rv;
 }
 
+static bool firstCall = true;
 NS_IMETHODIMP nsMsgProtocol::GetContentCharset(nsACString& aContentCharset) {
-  aContentCharset.Assign(mCharset);
+  if (firstCall) {
+    // Hacky approach for https://bugzilla.mozilla.org/show_bug.cgi?id=1718119.
+    firstCall = false;
+    aContentCharset.Assign("UTF-8"_ns);
+  } else {
+    aContentCharset.Assign(mCharset);
+  }
   return NS_OK;
 }
 
 NS_IMETHODIMP nsMsgProtocol::SetContentCharset(
     const nsACString& aContentCharset) {
   mCharset.Assign(aContentCharset);
   return NS_OK;
 }
diff --git a/mailnews/imap/src/nsImapProtocol.cpp b/mailnews/imap/src/nsImapProtocol.cpp
--- a/mailnews/imap/src/nsImapProtocol.cpp
+++ b/mailnews/imap/src/nsImapProtocol.cpp
@@ -9699,19 +9699,26 @@ NS_IMETHODIMP nsImapMockChannel::SetCont
   nsAutoCString charset;
   nsresult rv =
       NS_ParseResponseContentType(aContentType, mContentType, charset);
   if (NS_FAILED(rv) || mContentType.IsEmpty())
     mContentType.AssignLiteral(UNKNOWN_CONTENT_TYPE);
   return rv;
 }
 
+static bool firstCall = true;
 NS_IMETHODIMP nsImapMockChannel::GetContentCharset(
     nsACString& aContentCharset) {
-  aContentCharset.Assign(mCharset);
+  if (firstCall) {
+    // Hacky approach for https://bugzilla.mozilla.org/show_bug.cgi?id=1718119.
+    firstCall = false;
+    aContentCharset.Assign("UTF-8"_ns);
+  } else {
+    aContentCharset.Assign(mCharset);
+  }
   return NS_OK;
 }
 
 NS_IMETHODIMP nsImapMockChannel::SetContentCharset(
     const nsACString& aContentCharset) {
   mCharset.Assign(aContentCharset);
   return NS_OK;
 }
diff --git a/mailnews/news/src/nsNntpMockChannel.cpp b/mailnews/news/src/nsNntpMockChannel.cpp
--- a/mailnews/news/src/nsNntpMockChannel.cpp
+++ b/mailnews/news/src/nsNntpMockChannel.cpp
@@ -195,19 +195,27 @@ NS_IMETHODIMP nsNntpMockChannel::GetCont
 
 NS_IMETHODIMP nsNntpMockChannel::SetContentType(
     const nsACString& aContentType) {
   FORWARD_CALL(SetContentType, aContentType)
   return NS_ParseResponseContentType(aContentType, m_contentType,
                                      m_contentCharset);
 }
 
+static bool firstCall = true;
 NS_IMETHODIMP nsNntpMockChannel::GetContentCharset(nsACString& aCharset) {
-  FORWARD_CALL(GetContentCharset, aCharset)
-  aCharset = m_contentCharset;
+  if (firstCall) {
+    // Hacky approach for https://bugzilla.mozilla.org/show_bug.cgi?id=1718119.
+    firstCall = false;
+    FORWARD_CALL(GetContentCharset, aCharset)
+    aCharset.Assign("UTF-8"_ns);
+  } else {
+    FORWARD_CALL(GetContentCharset, aCharset)
+    aCharset = m_contentCharset;
+  }
   return NS_OK;
 }
 
 NS_IMETHODIMP nsNntpMockChannel::SetContentCharset(const nsACString& aCharset) {
   FORWARD_CALL(SetContentCharset, aCharset)
   m_contentCharset = aCharset;
   return NS_OK;
 }
