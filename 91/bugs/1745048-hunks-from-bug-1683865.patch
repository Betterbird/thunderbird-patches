# HG changeset patch
# User Henry Wilkes <henry@thunderbird.net>
# Date 1639000538 -3600
# Node ID 2f83b271cc3bd2a04937d3a061cdea4333081d73
# Parent  dd4354c5ef86e4337209359c3857e10936a6cc9e
Bug 1683865 - Replace xul:image usage in about:downloads. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D121724

diff --git a/calendar/base/content/item-editing/calendar-item-iframe.js b/calendar/base/content/item-editing/calendar-item-iframe.js
--- a/calendar/base/content/item-editing/calendar-item-iframe.js
+++ b/calendar/base/content/item-editing/calendar-item-iframe.js
@@ -2290,16 +2290,18 @@ function addAttachment(attachment, cloud
   }
 
   // We currently only support uri attachments
   if (attachment.uri) {
     let documentLink = document.getElementById("attachment-link");
     let listItem = document.createXULElement("richlistitem");
     let image = document.createElement("img");
     image.setAttribute("alt", "");
+    // Allow the moz-icon src to be invalid.
+    image.classList.add("invisible-on-broken");
     listItem.appendChild(image);
     let label = document.createXULElement("label");
     label.setAttribute("value", makePrettyName(attachment.uri));
     label.setAttribute("crop", "end");
     listItem.appendChild(label);
     listItem.setAttribute("tooltiptext", attachment.uri.spec);
     if (cloudFileAccount) {
       if (attachment.uri.schemeIs("file")) {
diff --git a/calendar/base/content/widgets/calendar-item-summary.js b/calendar/base/content/widgets/calendar-item-summary.js
--- a/calendar/base/content/widgets/calendar-item-summary.js
+++ b/calendar/base/content/widgets/calendar-item-summary.js
@@ -116,17 +116,17 @@
             </html:th>
             <html:td>
               <vbox class="item-attachment-cell">
                 <!-- attachment box template -->
                 <hbox class="attachment-template"
                       hidden="true"
                       align="center"
                       disable-on-readonly="true">
-                  <html:img class="attachment-icon"
+                  <html:img class="attachment-icon invisible-on-broken"
                             alt="" />
                   <label class="text-link item-attachment-cell-label"
                          crop="end"
                          flex="1" />
                 </hbox>
               </vbox>
             </html:td>
           </html:tr>
diff --git a/mail/base/content/widgets/mailWidgets.js b/mail/base/content/widgets/mailWidgets.js
--- a/mail/base/content/widgets/mailWidgets.js
+++ b/mail/base/content/widgets/mailWidgets.js
@@ -1627,19 +1627,18 @@
         );
         event.target.dispatchEvent(evt);
       });
 
       let iconContainer = this.ownerDocument.createXULElement("hbox");
       iconContainer.setAttribute("align", "center");
       let icon = this.ownerDocument.createElement("img");
       icon.setAttribute("alt", "");
-      icon.classList.add("attachmentcell-icon");
-      // Hide if invalid.
-      icon.addEventListener("error", () => icon.classList.add("invalid-src"));
+      // Allow the src to be invalid.
+      icon.classList.add("attachmentcell-icon", "invisible-on-broken");
       iconContainer.appendChild(icon);
 
       let textContainer = this.ownerDocument.createXULElement("hbox");
       textContainer.setAttribute("flex", "1");
       textContainer.classList.add("attachmentcell-text");
       let textName = this.ownerDocument.createXULElement("hbox");
       textName.setAttribute("flex", "1");
       textName.classList.add("attachmentcell-nameselection");
@@ -1689,25 +1688,16 @@
     /**
      * Set the attachment icon source.
      *
      * @param {MozRichlistitem} item - The attachment item to set the icon of.
      * @param {string|null} src - The src to set.
      */
     setAttachmentIconSrc(item, src) {
       let icon = item.querySelector(".attachmentcell-icon");
-      if (!src) {
-        icon.classList.add("invalid-src");
-        icon.removeAttribute("src");
-        return;
-      }
-      icon.classList.remove("invalid-src");
-      // NOTE: Setting the same value for "src" should still trigger the
-      // reloading of the image, and re-add the invalid-src class if the same
-      // error occurs.
       icon.setAttribute("src", src);
     }
 
     /**
      * Refresh the attachment icon using the attachment details.
      *
      * @param {MozRichlistitem} item - The attachment item to refresh the icon
      *   for.
diff --git a/mail/components/downloads/content/aboutDownloads.js b/mail/components/downloads/content/aboutDownloads.js
--- a/mail/components/downloads/content/aboutDownloads.js
+++ b/mail/components/downloads/content/aboutDownloads.js
@@ -245,19 +245,20 @@ DownloadItem.prototype = {
     return this._element;
   },
 
   createXULElement() {
     let element = document.createXULElement("richlistitem");
     element.classList.add("download");
     element.setAttribute("align", "center");
 
-    let image = document.createXULElement("image");
-    image.setAttribute("validate", "always");
-    image.classList.add("fileTypeIcon");
+    let image = document.createElement("img");
+    image.setAttribute("alt", "");
+    // Allow the given src to be invalid.
+    image.classList.add("fileTypeIcon", "invisible-on-broken");
 
     let vbox = document.createXULElement("vbox");
     vbox.setAttribute("pack", "center");
     vbox.setAttribute("flex", "1");
 
     let hbox = document.createXULElement("hbox");
     let hbox2 = document.createXULElement("hbox");
 
diff --git a/mail/components/downloads/content/aboutDownloads.xhtml b/mail/components/downloads/content/aboutDownloads.xhtml
--- a/mail/components/downloads/content/aboutDownloads.xhtml
+++ b/mail/components/downloads/content/aboutDownloads.xhtml
@@ -18,17 +18,17 @@
       xmlns:html="http://www.w3.org/1999/xhtml"
       scrolling="false"
       lightweightthemes="true">
 <head>
   <title>&aboutDownloads.title;</title>
   <script defer="defer" src="chrome://global/content/globalOverlay.js"></script>
   <script defer="defer" src="chrome://global/content/editMenuOverlay.js"></script>
   <script defer="defer" src="chrome://messenger/content/downloads/aboutDownloads.js"></script>
-  <meta http-equiv="Content-Security-Policy" content="default-src chrome:; object-src 'none'; script-src chrome: 'unsafe-inline'" />
+  <meta http-equiv="Content-Security-Policy" content="default-src chrome:; img-src chrome: moz-icon:; object-src 'none'; script-src chrome: 'unsafe-inline'" />
   <link rel="shortcut icon" href="chrome://messenger/skin/downloads/download.svg" />
 </head>
 <html:body xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
   <commandset id="msgDownloadCommands"
               commandupdater="true"
               events="focus,select,contextmenu">
     <command id="msgDownloadsCmd_open"
              oncommand="goDoCommand('msgDownloadsCmd_open')"/>
diff --git a/mail/themes/shared/mail/aboutDownloads.css b/mail/themes/shared/mail/aboutDownloads.css
--- a/mail/themes/shared/mail/aboutDownloads.css
+++ b/mail/themes/shared/mail/aboutDownloads.css
@@ -70,20 +70,19 @@ body {
 }
 
 #searchBox {
   width: 22em;
   margin-inline-end: 0;
 }
 
 .fileTypeIcon {
-  margin-inline-start: 8px;
-  margin-inline-end: 8px;
+  margin-inline: 8px;
   /* explicitly size the icon, so size doesn't vary on hidpi systems */
-  max-height: 32px;
+  height: 32px;
   width: 32px;
 }
 
 .sender,
 .fileName {
   margin-block: 3px;
   font-weight: 600;
 }
diff --git a/mail/themes/shared/mail/attachmentList.css b/mail/themes/shared/mail/attachmentList.css
--- a/mail/themes/shared/mail/attachmentList.css
+++ b/mail/themes/shared/mail/attachmentList.css
@@ -156,20 +156,16 @@
 
 .attachmentcell-icon {
   margin: 1px;
   width: 16px;
   height: 16px;
   min-width: 16px;
 }
 
-.attachmentcell-icon.invalid-src {
-  visibility: hidden;
-}
-
 .attachmentcell-name,
 .attachmentcell-size {
   padding-top: 1px;
 }
 
 .attachmentcell-size {
   opacity: 0.6;
 }
diff --git a/mail/themes/shared/mail/messenger.css b/mail/themes/shared/mail/messenger.css
--- a/mail/themes/shared/mail/messenger.css
+++ b/mail/themes/shared/mail/messenger.css
@@ -626,16 +626,20 @@ button[type="menu-button"] > .button-box
 
 button > .button-box > dropmarker {
   appearance: none;
   list-style-image: url(chrome://global/skin/icons/arrow-down-12.svg);
   -moz-context-properties: fill;
   fill: currentColor;
 }
 
+img.invisible-on-broken:-moz-broken {
+  visibility: hidden;
+}
+
 .popup-notification-button {
   height: auto;
   border-style: none;
   border-radius: 0;
 }
 
 #notification-popup-box > image.notification-anchor-icon {
   width: 16px;
