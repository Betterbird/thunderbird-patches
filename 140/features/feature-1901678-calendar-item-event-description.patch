# HG changeset patch
# User David Orban <mozilla@floruit.be>
# Date 1765556814 -3600
# Parent  cc012843a7d52c95192f4f4af974a91fe4535c25
Bug 1901678 - Use event description as email body. Introduces pref calendar.itip.eventDescriptionAsEmailBody.

Based on https://phabricator.services.mozilla.com/D231007 without the UI parts.
Text content slightly adjusted to maintain original text.

diff --git a/calendar/base/calendar.js b/calendar/base/calendar.js
--- a/calendar/base/calendar.js
+++ b/calendar/base/calendar.js
@@ -95,8 +95,11 @@ pref("calendar.itip.imipDetailsOpen", tr
 
 // Temporary pref for using the new invitation display instead of the old one.
 pref("calendar.itip.newInvitationDisplay", false);
 
+// Uses the event description as the email body.
+pref("calendar.itip.eventDescriptionAsEmailBody", false);
+
 // whether CalDAV (experimental) scheduling is enabled or not.
 pref("calendar.caldav.sched.enabled", false);
 
 // 0=Sunday, 1=Monday, 2=Tuesday, etc.  One day we might want to move this to
diff --git a/calendar/itip/CalItipEmailTransport.sys.mjs b/calendar/itip/CalItipEmailTransport.sys.mjs
--- a/calendar/itip/CalItipEmailTransport.sys.mjs
+++ b/calendar/itip/CalItipEmailTransport.sys.mjs
@@ -312,9 +312,28 @@ export class CalItipEmailTransport {
         "--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\r\n" +
         "Content-type: text/plain; charset=UTF-8\r\n" +
         "Content-transfer-encoding: 8BIT\r\n" +
         "\r\n" +
-        cal.invitation.encodeUTF8(aBody) +
+        cal.invitation.encodeUTF8(aBody);
+      if (
+        Services.prefs.getBoolPref("calendar.itip.eventDescriptionAsEmailBody", false) &&
+        itemList.length == 1
+      ) {
+        // In the text/plain part, add the textual description.
+        mailText +=
+          "\r\n------------------------------------------------------------------------\r\n" +
+          cal.invitation.encodeUTF8(itemList[0].descriptionText) +
+          // Then add a text/html part.
+          "\r\n\r\n\r\n" +
+          "--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\r\n" +
+          "Content-type: text/html; charset=UTF-8\r\n" +
+          "Content-transfer-encoding: 8BIT\r\n" +
+          "\r\n" +
+          cal.invitation.encodeUTF8(aBody).replace(/<(.*)>/, "<a href='mailto:$1'>&lt;$1&gt;</a>") +
+          "\r\n<hr>\r\n" +
+          cal.invitation.encodeUTF8(itemList[0].descriptionHTML);
+      }
+      mailText +=
         "\r\n\r\n\r\n" +
         "--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\r\n" +
         "Content-type: text/calendar; method=" +
         aItipItem.responseMethod +
