# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1759167899 -7200
# Parent  76634e7da4fc6a0cc05c2f0ec710633a528b69d4
Bug 1831713 - 'Junk' button does not change to 'Not Junk' button in supernova's unified toolbar.

diff --git a/mail/components/unifiedtoolbar/content/items/junk-button.mjs b/mail/components/unifiedtoolbar/content/items/junk-button.mjs
new file mode 100644
--- /dev/null
+++ b/mail/components/unifiedtoolbar/content/items/junk-button.mjs
@@ -0,0 +1,60 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */
+
+import { MailTabButton } from "chrome://messenger/content/unifiedtoolbar/mail-tab-button.mjs";
+
+/* globals getEnabledControllerForCommand, goDoCommand */
+
+/**
+ * Unified toolbar button that marks the selected message as junk or not junk.
+ */
+class JunkButton extends MailTabButton {
+  observedAboutMessageEvents = ["load", "MsgLoaded"];
+  /**
+   * Handle the context changing, updating the disabled state for the button
+   * etc.
+   */
+  onCommandContextChange() {
+    try {
+      const message = document.getElementById("tabmail").currentTabInfo.message;
+      const isJunk =
+        message.getStringProperty("junkscore") ==
+        Ci.nsIJunkMailPlugin.IS_SPAM_SCORE;
+
+      this.setAttribute(
+        "label-id",
+        `toolbar-${isJunk ? "not-" : ""}junk-label`
+      );
+      document.l10n.setAttributes(this, `toolbar-${isJunk ? "not-" : ""}junk`);
+      this.disabled =
+        !message ||
+        !getEnabledControllerForCommand(
+          isJunk ? "cmd_markAsJunk" : "cmd_markAsNotJunk"
+        );
+      this.dataset.isJunk = isJunk;
+    } catch {
+      this.disabled = true;
+    }
+  }
+
+  /**
+   * Runs the correspondent command when the user clicks on the unified 'Junk'
+   * or 'Not Junk' button.
+   *
+   * @param {Event} event
+   */
+  handleClick(event) {
+    goDoCommand(
+      event.target.dataset.isJunk == "false"
+        ? "cmd_markAsJunk"
+        : "cmd_markAsNotJunk"
+    );
+    this.onCommandContextChange();
+    event.preventDefault();
+    event.stopPropagation();
+  }
+}
+customElements.define("junk-button", JunkButton, {
+  extends: "button",
+});
diff --git a/mail/components/unifiedtoolbar/content/unifiedToolbarCustomizableItems.inc.xhtml b/mail/components/unifiedtoolbar/content/unifiedToolbarCustomizableItems.inc.xhtml
--- a/mail/components/unifiedtoolbar/content/unifiedToolbarCustomizableItems.inc.xhtml
+++ b/mail/components/unifiedtoolbar/content/unifiedToolbarCustomizableItems.inc.xhtml
@@ -148,10 +148,9 @@
 </html:template>
 
 <html:template id="junkTemplate"
                xmlns="http://www.w3.org/1999/xhtml">
-  <button is="mail-tab-button"
-          command="cmd_markAsJunk"
+  <button is="junk-button"
           label-id="toolbar-junk-label"
           data-l10n-id="toolbar-junk"></button>
 </html:template>
 
diff --git a/mail/components/unifiedtoolbar/jar.mn b/mail/components/unifiedtoolbar/jar.mn
--- a/mail/components/unifiedtoolbar/jar.mn
+++ b/mail/components/unifiedtoolbar/jar.mn
@@ -13,8 +13,9 @@ messenger.jar:
     content/messenger/unifiedtoolbar/delete-button.mjs                 (content/items/delete-button.mjs)
     content/messenger/unifiedtoolbar/folder-location-button.mjs        (content/items/folder-location-button.mjs)
     content/messenger/unifiedtoolbar/get-messages-button.mjs           (content/items/get-messages-button.mjs)
     content/messenger/unifiedtoolbar/global-search-bar.mjs             (content/items/global-search-bar.mjs)
+    content/messenger/unifiedtoolbar/junk-button.mjs                   (content/items/junk-button.mjs)
     content/messenger/unifiedtoolbar/mail-go-button.mjs                (content/items/mail-go-button.mjs)
     content/messenger/unifiedtoolbar/quick-filter-bar-toggle.mjs       (content/items/quick-filter-bar-toggle.mjs)
     content/messenger/unifiedtoolbar/space-button.mjs                  (content/items/space-button.mjs)
     content/messenger/unifiedtoolbar/view-picker-button.mjs            (content/items/view-picker-button.mjs)
diff --git a/mail/components/unifiedtoolbar/modules/CustomizableItemsDetails.mjs b/mail/components/unifiedtoolbar/modules/CustomizableItemsDetails.mjs
--- a/mail/components/unifiedtoolbar/modules/CustomizableItemsDetails.mjs
+++ b/mail/components/unifiedtoolbar/modules/CustomizableItemsDetails.mjs
@@ -247,9 +247,9 @@ export default [
     labelId: "toolbar-junk",
     spaces: ["mail"],
     templateId: "junkTemplate",
     requiredModules: [
-      "chrome://messenger/content/unifiedtoolbar/mail-tab-button.mjs",
+      "chrome://messenger/content/unifiedtoolbar/junk-button.mjs",
     ],
   },
   {
     id: "delete",
diff --git a/mail/locales/en-US/messenger/unifiedToolbarItems.ftl b/mail/locales/en-US/messenger/unifiedToolbarItems.ftl
--- a/mail/locales/en-US/messenger/unifiedToolbarItems.ftl
+++ b/mail/locales/en-US/messenger/unifiedToolbarItems.ftl
@@ -92,8 +92,13 @@ toolbar-junk-label = Junk
 
 toolbar-junk =
     .title = Mark the selected messages as junk
 
+toolbar-not-junk-label = { toolbar-not-junk-button.label }
+
+toolbar-not-junk =
+    .title = { toolbar-not-junk-button.tooltiptext }
+
 toolbar-delete-label = Delete
 
 toolbar-delete-title =
     .title = Delete the selected messages
