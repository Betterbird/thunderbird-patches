# HG changeset patch
# User Kai Engert <kaie@kuix.de>
# Date 1769175331 -3600
# Parent  5f4c010e0f3077bcca86a2e59ff1554bae0e8c8f
Bug 1967121 - Introduce a pref to allow loading of untested GPGME versions. r=mkmelin

diff --git a/mail/extensions/am-e2e/prefs/e2e-prefs.js b/mail/extensions/am-e2e/prefs/e2e-prefs.js
--- a/mail/extensions/am-e2e/prefs/e2e-prefs.js
+++ b/mail/extensions/am-e2e/prefs/e2e-prefs.js
@@ -27,8 +27,15 @@ pref("openpgp.loglevel", "Warn");
 // If true, we allow the use of GnuPG for OpenPGP secret key operations
 pref("mail.openpgp.allow_external_gnupg", false);
 // If allow_external_gnupg is true: Optionally use a different gpg executable
 pref("mail.openpgp.alternative_gpg_path", "");
+
+// If allow_external_gnupg is true, you may use this pref to allow
+// loading of an GPGME version that is untested (officially unsupported)
+// by the current software release. Example value: "45"
+// Set it to the empty string to load only expected library versions.
+pref("mail.openpgp.load_untested_gpgme_version", "");
+
 // The hexadecimal OpenPGP key ID used for an identity.
 pref("mail.identity.default.openpgp_key_id", "");
 // If true, then openpgp_key_id is managed externally by GnuPG
 pref("mail.identity.default.is_gnupg_key_id", false);
diff --git a/mail/extensions/openpgp/content/modules/GPGMELib.sys.mjs b/mail/extensions/openpgp/content/modules/GPGMELib.sys.mjs
--- a/mail/extensions/openpgp/content/modules/GPGMELib.sys.mjs
+++ b/mail/extensions/openpgp/content/modules/GPGMELib.sys.mjs
@@ -60,10 +60,33 @@ function tryLoadGPGME(name, suffix) {
 }
 
 function loadExternalGPGMELib() {
   if (!libgpgme) {
+    let optionalGPGMEVersion = Services.prefs.getStringPref(
+      "mail.openpgp.load_untested_gpgme_version"
+    );
+
+    // Only allow characters expected in version numbers,
+    // which will disallow things like path separators.
+    if (optionalGPGMEVersion && !/^[A-Za-z0-9]+$/.test(optionalGPGMEVersion)) {
+      log.debug(`Ignoring invalid value in load_untested_gpgme_version`);
+      optionalGPGMEVersion = "";
+    }
+
     if (Services.appinfo.OS === "WINNT") {
-      tryLoadGPGME("libgpgme6-11", "");
+      if (optionalGPGMEVersion) {
+        if (!libgpgme) {
+          tryLoadGPGME("libgpgme-" + optionalGPGMEVersion, "");
+        }
+
+        if (!libgpgme) {
+          tryLoadGPGME("gpgme-" + optionalGPGMEVersion, "");
+        }
+      }
+
+      if (!libgpgme) {
+        tryLoadGPGME("libgpgme6-11", "");
+      }
 
       if (!libgpgme) {
         tryLoadGPGME("libgpgme-11", "");
       }
@@ -72,8 +95,18 @@ function loadExternalGPGMELib() {
         tryLoadGPGME("gpgme-11", "");
       }
     }
 
+    if (optionalGPGMEVersion) {
+      if (!libgpgme) {
+        tryLoadGPGME("gpgme", "." + optionalGPGMEVersion);
+      }
+
+      if (!libgpgme) {
+        tryLoadGPGME("gpgme." + optionalGPGMEVersion, "");
+      }
+    }
+
     if (!libgpgme) {
       tryLoadGPGME("gpgme", "");
     }
 
