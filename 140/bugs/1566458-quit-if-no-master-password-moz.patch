# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1757632300 -7200
# Parent  3b5364ce921c2701a42286720ce946f08f42a815
Bug 1566458 - Quit application if master password isn't entered.

Inspired by https://phabricator.services.mozilla.com/D166645

diff --git a/toolkit/xre/nsXREDirProvider.cpp b/toolkit/xre/nsXREDirProvider.cpp
--- a/toolkit/xre/nsXREDirProvider.cpp
+++ b/toolkit/xre/nsXREDirProvider.cpp
@@ -620,9 +620,17 @@ nsXREDirProvider::DoStartup() {
           do_GetService("@mozilla.org/security/pk11tokendb;1");
       if (db) {
         nsCOMPtr<nsIPK11Token> token;
         if (NS_SUCCEEDED(db->GetInternalKeyToken(getter_AddRefs(token)))) {
-          mozilla::Unused << token->Login(false);
+          bool needsLogin = false;
+          mozilla::Unused << token->NeedsLogin(&needsLogin);
+          if (needsLogin) {
+            mozilla::Unused << token->Login(false);
+            bool isLoggedIn = false;
+            if (NS_FAILED(token->IsLoggedIn(&isLoggedIn)) || !isLoggedIn) {
+              exit(1);
+            }
+          }
         }
       } else {
         NS_WARNING("Failed to get nsIPK11TokenDB service.");
       }
