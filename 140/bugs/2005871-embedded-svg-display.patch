# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1765654729 -3600
# Parent  c6d41da969c33fd6d99cc95d12ee2dd547fa317b
Bug 2005871 - Fix display of embedded SVG images.

diff --git a/mailnews/mime/src/mimei.cpp b/mailnews/mime/src/mimei.cpp
--- a/mailnews/mime/src/mimei.cpp
+++ b/mailnews/mime/src/mimei.cpp
@@ -795,8 +795,9 @@ MimeObject* mime_create(const char* cont
   MimeObjectClass* clazz = 0;
   char* content_disposition = 0;
   MimeObject* obj = 0;
   char* override_content_type = 0;
+  bool isInline = false;
 
   /* We've had issues where the incoming content_type is invalid, of a format:
      content_type="=?windows-1252?q?application/pdf" (bug 659355)
      We decided to fix that by simply trimming the stuff before the ?
@@ -883,11 +884,12 @@ MimeObject* mime_create(const char* cont
           hdrs ? MimeHeaders_get(hdrs, HEADER_CONTENT_DISPOSITION, true, false)
                : 0;
   }
 
-  if (!content_disposition || !PL_strcasecmp(content_disposition, "inline"))
-    ; /* Use the class we've got. */
-  else {
+  if (!content_disposition || !PL_strcasecmp(content_disposition, "inline")) {
+    // Use the class we've got.
+    isInline = true;
+  } else {
     // override messages that have content disposition set to "attachment"
     // even though we probably should show them inline.
     if ((clazz != (MimeObjectClass*)&mimeMessageClass) &&
         (clazz != (MimeObjectClass*)&mimeInlineImageClass) &&
@@ -948,8 +950,11 @@ MimeObject* mime_create(const char* cont
     else if (opts && opts->part_to_load &&
              mime_subclass_p(clazz, (MimeObjectClass*)&mimeMessageClass))
       /* Descend into messages only if we're looking for a specific sub-part. */
       ;
+    else if (isInline && clazz == (MimeObjectClass*)&mimeInlineImageClass)
+      // Don't allow images to be treated as external objects.
+      ;
     else {
       /* Anything else, and display it as a link (and cause subsequent
          text parts to also be displayed as links.) */
       clazz = (MimeObjectClass*)&mimeExternalObjectClass;
