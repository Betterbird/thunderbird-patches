
# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1766342739 -3600
# Node ID 49a8cff5206a9f130364f79440271cac38ea8c1c
# Parent  3ee71444d398b0d3fc5dd42a04e77a18c8195fd7
Bug 1835556 - Fix moving Maildir-based virtual folders. r=BenC

Differential Revision: https://phabricator.services.mozilla.com/D275356

diff --git a/mailnews/local/src/nsMsgBrkMBoxStore.cpp b/mailnews/local/src/nsMsgBrkMBoxStore.cpp
--- a/mailnews/local/src/nsMsgBrkMBoxStore.cpp
+++ b/mailnews/local/src/nsMsgBrkMBoxStore.cpp
@@ -61,8 +61,12 @@ NS_IMETHODIMP nsMsgBrkMBoxStore::Discove
 
   bool exists;
   path->Exists(&exists);
   if (!exists) {
+    // Apparently, this code is only used to create a real folder alongside
+    // the .msf file for a virtual folder. Although the empty folder seems
+    // useless, trying to move the virtual folder later on will fail without
+    // it.
     rv = path->Create(nsIFile::DIRECTORY_TYPE, 0755);
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
diff --git a/mailnews/local/src/nsMsgMaildirStore.cpp b/mailnews/local/src/nsMsgMaildirStore.cpp
--- a/mailnews/local/src/nsMsgMaildirStore.cpp
+++ b/mailnews/local/src/nsMsgMaildirStore.cpp
@@ -643,14 +643,16 @@ NS_IMETHODIMP nsMsgMaildirStore::CopyFol
   aDstFolder->GetIsServer(&isServer);
   rv = CreateDirectoryForFolder(newPath, isServer);
   NS_ENSURE_SUCCESS(rv, rv);
 
-  nsCOMPtr<nsIFile> origPath;
-  rv = oldPath->Clone(getter_AddRefs(origPath));
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  rv = oldPath->CopyTo(newPath, safeFolderName16);
-  NS_ENSURE_SUCCESS(rv, rv);  // will fail if a file by that name exists
+  // Only copy existing Maildir folders. There is no actual folder present for
+  // a saved search (virtual folder).
+  bool exists;
+  oldPath->Exists(&exists);
+  if (exists) {
+    rv = oldPath->CopyTo(newPath, safeFolderName16);
+    NS_ENSURE_SUCCESS(rv, rv);  // Will fail if a file by that name exists.
+  }
 
   // Copy to dir can fail if file does not exist. If copy fails, we test
   // if the file exists or not, if it does not that's ok, we continue
   // without copying it. If it fails and file exist and is not zero sized
@@ -663,10 +665,11 @@ NS_IMETHODIMP nsMsgMaildirStore::CopyFol
     bool exists;
     int64_t fileSize;
     summaryFile->Exists(&exists);
     summaryFile->GetFileSize(&fileSize);
-    if (exists && fileSize > 0)
+    if (exists && fileSize > 0) {
       NS_ENSURE_SUCCESS(rv, rv);  // Yes, it should have worked!
+    }
     // else case is file is zero sized, no need to copy it,
     // not an error
     // else case is file does not exist - not an error
   }
