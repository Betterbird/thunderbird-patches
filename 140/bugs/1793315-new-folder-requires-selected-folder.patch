# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1766335606 -3600
# Node ID a24305279e525336a7fd8c4346488bb0bff5cdca
# Parent  b1e4b9169c38d1aaa78b0a16cc7b3a68da77b489
Bug 1793315 - Have 'New Folder' dialog require a selected folder. r=mkmelin

When called on folders that don't allow the creation of subfolders, the dialog
appears with the folder seletion widget labeled 'Choose Folderâ€¦". However,
the dialog could still be accepted without the user doing so. In the case of
the unified inbox, this would lead to folder on the file system that was not
reflected in the GUI.

Additionally, the check for an already existing subfolder with the entered name
wasn't performed directly after selecting a different parent folder.

Differential Revision: https://phabricator.services.mozilla.com/D276311

diff --git a/mailnews/base/content/newFolderDialog.js b/mailnews/base/content/newFolderDialog.js
--- a/mailnews/base/content/newFolderDialog.js
+++ b/mailnews/base/content/newFolderDialog.js
@@ -24,18 +24,11 @@ function onLoad() {
   dialog.okCallback = windowArgs.okCallback;
 
   // pre select the folderPicker, based on what they selected in the folder pane
   dialog.folder = windowArgs.folder;
-  try {
-    document
-      .getElementById("MsgNewFolderPopup")
-      .selectFolder(windowArgs.folder);
-  } catch (ex) {
-    // selected a child folder
-    document
-      .getElementById("msgNewFolderPicker")
-      .setAttribute("label", windowArgs.folder.prettyName);
-  }
+  dialog.folderSelected = document
+    .getElementById("MsgNewFolderPopup")
+    .selectFolder(windowArgs.folder);
 
   // can folders contain both folders and messages?
   if (windowArgs.dualUseFolders) {
     dialog.folderType = FOLDERS | MESSAGES;
@@ -48,15 +41,10 @@ function onLoad() {
     document.getElementById("folderGroup").selectedItem.doCommand();
   }
 
   // Handle enabling/disabling of the OK button.
-  dialog.nameField.addEventListener("input", event => {
-    const childName = event.target.value;
-    // Disable if no value set, or if child folder with that name alredy exists.
-    document.querySelector("dialog").getButton("accept").disabled =
-      !childName || dialog.folder.getChildNamed(childName);
-  });
-  document.querySelector("dialog").getButton("accept").disabled = true;
+  dialog.nameField.addEventListener("input", doEnabling);
+  doEnabling();
 
   UIFontSize.registerWindow(window);
 }
 
@@ -64,8 +52,10 @@ function onFolderSelect(event) {
   dialog.folder = event.target._folder;
   document
     .getElementById("msgNewFolderPicker")
     .setAttribute("label", dialog.folder.prettyName);
+  dialog.folderSelected = true;
+  doEnabling();
 }
 
 function onOK() {
   const name = dialog.nameField.value;
@@ -83,4 +73,14 @@ function onFoldersOnly() {
 
 function onMessagesOnly() {
   dialog.folderType = MESSAGES;
 }
+
+function doEnabling() {
+  const childName = dialog.nameField.value;
+  // Disable if no value set, no folder selected, or if child folder with that
+  // name already exists.
+  document.querySelector("dialog").getButton("accept").disabled =
+    !childName ||
+    !dialog.folderSelected ||
+    dialog.folder.getChildNamed(childName);
+}
