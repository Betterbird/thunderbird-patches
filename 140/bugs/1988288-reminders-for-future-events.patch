# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1757784055 -7200
# Parent  caa71455009bbc8b7707a0549af361d551db0eda
Bug 1988288 - Always show missed reminders for future events.

diff --git a/calendar/base/src/CalAlarmService.sys.mjs b/calendar/base/src/CalAlarmService.sys.mjs
--- a/calendar/base/src/CalAlarmService.sys.mjs
+++ b/calendar/base/src/CalAlarmService.sys.mjs
@@ -485,23 +485,32 @@ CalAlarmService.prototype = {
           // action required.
           continue;
         }
 
-        let ongoingEvent = false;
-        const tz = alarmDate.timezone.isFloating ? cal.dtz.floating : cal.dtz.UTC;
-        const itemStart = aItem[cal.dtz.startDateProp(aItem)].getInTimezone(tz);
-        const itemEnd = aItem[cal.dtz.endDateProp(aItem)].getInTimezone(tz);
-        if (itemStart && itemEnd) {
-          // Ensure isDate false so we get hour/minute/second for all-day events.
-          itemStart.isDate = false;
-          itemEnd.isDate = false;
-          ongoingEvent = now.compare(itemStart) >= 0 && now.compare(itemEnd) <= 0;
+        let showAlarm = showMissed;
+        if (!showAlarm) {
+          // Check for future event, incl. ongoing ones, anything where
+          // start or end are in the future. Tasks may not have both dates set.
+          const tz = alarmDate.timezone.isFloating ? cal.dtz.floating : cal.dtz.UTC;
+          const itemStart = aItem[cal.dtz.startDateProp(aItem)].getInTimezone(tz);
+          const itemEnd = aItem[cal.dtz.endDateProp(aItem)].getInTimezone(tz);
+          // Optimise a bit. The end date is more likely to determine the future event.
+          if (itemEnd) {
+            itemEnd.isDate = false;
+            if (itemEnd.compare(now) >= 0) {
+              showAlarm = true;
+            }
+          }
+          if (!showAlarm && itemStart) {
+            itemStart.isDate = false;
+            if (itemStart.compare(now) >= 0) {
+              showAlarm = true;
+            }
+          }
         }
 
-        if (showMissed || ongoingEvent) {
+        if (showAlarm) {
           // The alarm was not snoozed or dismissed, fire it now.
-          // Or if the event is ongoing but we haven't fired. Especially important
-          // for all-day events where alarm would have set off at midnight.
           this.alarmFired(aItem, alarm);
         }
       }
     }
