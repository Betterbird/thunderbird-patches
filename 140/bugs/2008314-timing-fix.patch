# HG changeset patch
# User Yury Ivanovich <Yury.Ivanovich@linuxmail.org>
# Date 1767654282 -3600
# Parent  5612017fb036e6f1a4bb3c30b32dfea9c6c8bcbb
Bug 2008314 - Fix timing in 'after send' filters.

Differential Revision: https://phabricator.services.mozilla.com/D277943

diff --git a/mailnews/imap/src/nsImapMailFolder.cpp b/mailnews/imap/src/nsImapMailFolder.cpp
--- a/mailnews/imap/src/nsImapMailFolder.cpp
+++ b/mailnews/imap/src/nsImapMailFolder.cpp
@@ -70,8 +70,9 @@
 #include "nsReadableUtils.h"
 #include "UrlListener.h"
 #include "nsIObserverService.h"
 #include "nsIPropertyBag2.h"
+#include "nsIThread.h"
 
 #define NS_PARSEMAILMSGSTATE_CID              \
   {/* 2B79AC51-1459-11d3-8097-006008128C4E */ \
    0x2b79ac51,                                \
@@ -5167,8 +5168,14 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR
                     txnMgr->DoTransaction(txn);
                   }
                 }
                 (void)OnCopyCompleted(m_copyState->m_srcSupport, aExitCode);
+                // Clear event queue, that is, execute "after send" filters,
+                // before calling `UpdateFolderWithListener()`.
+                nsCOMPtr<nsIThread> thread(do_GetCurrentThread());
+                while (NS_ProcessNextEvent(thread)) {
+                  // Do nothing, just process all the pending events.
+                }
                 UpdateFolderWithListener(msgWindow, m_urlListener);
               }
             } else {
               // clear the copyState if copy has failed
