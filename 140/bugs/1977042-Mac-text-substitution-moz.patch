# HG changeset patch
# User Makoto Kato <m_kato@ga2.so-net.ne.jp>
# Date 1757702121 -7200
# Parent  d1ebbb27ad61d1da5997f45405cfe2fdac741472
Bug 1977042 - Text substitution isn't processed at Thunderbird compose window.

From https://phabricator.services.mozilla.com/D263834 as of 24 Sep. 2025

diff --git a/widget/cocoa/TextInputHandler.h b/widget/cocoa/TextInputHandler.h
--- a/widget/cocoa/TextInputHandler.h
+++ b/widget/cocoa/TextInputHandler.h
@@ -1070,10 +1070,11 @@
   // Used by text substitution.
   nsString mOriginalTextForTextSubstitution;
   NSTextCheckingResult* mCandidatedTextSubstitutionResult;
   bool mProcessTextSubstitution;
   bool mBlockDismissTextSubstitutionPanel = false;
+  bool mPendingDismissTextSubstitution = false;
 
   IMEInputHandler(nsCocoaWindow* aWidget, NSView<mozView>* aNativeView);
   virtual ~IMEInputHandler();
 
   void ResetTimer();
diff --git a/widget/cocoa/TextInputHandler.mm b/widget/cocoa/TextInputHandler.mm
--- a/widget/cocoa/TextInputHandler.mm
+++ b/widget/cocoa/TextInputHandler.mm
@@ -2603,23 +2603,29 @@
   nsEventStatus status = nsEventStatus_eIgnore;
   bool keyPressDispatched = [&]() {
     // If text content is chrome process, OnTextChange etc will be dispatched
     // synchronously. We don't want to dismiss text substitution panel at this
     // point.
+    mPendingDismissTextSubstitution = false;
     AutoRestore<bool> block(mBlockDismissTextSubstitutionPanel);
     mBlockDismissTextSubstitutionPanel = true;
 
     return mDispatcher->MaybeDispatchKeypressEvents(keypressEvent, status,
                                                     currentKeyEvent);
   }();
   bool keyPressHandled = (status == nsEventStatus_eConsumeNoDefault);
 
-  // WebKit and text editor dismisses autocorrect panel by space, then process
-  // autocorrect.
-  if (keypressEvent.mKeyCode == NS_VK_SPACE && keyPressDispatched) {
-    mProcessTextSubstitution = true;
-    DismissTextSubstitutionPanel();
+  if (keyPressDispatched) {
+    // WebKit and text editor dismisses autocorrect panel by space, then process
+    // autocorrect.
+    const bool isSpaceKeyPress = (keypressEvent.mKeyCode == NS_VK_SPACE);
+    // If not space key, we don't process text substitution.
+    mProcessTextSubstitution = isSpaceKeyPress;
+
+    if (isSpaceKeyPress || mPendingDismissTextSubstitution) {
+      DismissTextSubstitutionPanel();
+    }
   }
 
   // Note: mWidget might have become null here. Don't count on it from here on.
 
   if (currentKeyEvent) {
@@ -3115,10 +3121,11 @@
     nsEventStatus status = nsEventStatus_eIgnore;
     // If text content is chrome process, OnTextChange etc will be dispatched
     // synchronously. We don't want to dismiss text substitution panel at this
     // point.
     {
+      mPendingDismissTextSubstitution = false;
       AutoRestore<bool> block(mBlockDismissTextSubstitutionPanel);
       mBlockDismissTextSubstitutionPanel = true;
 
       currentKeyEvent->mKeyPressDispatched =
           mDispatcher->MaybeDispatchKeypressEvents(keypressEvent, status,
@@ -3131,14 +3138,21 @@
         ("%p   TextInputHandler::DoCommandBySelector, keypress event "
          "dispatched, Destroyed()=%s, keypressHandled=%s",
          this, TrueOrFalse(Destroyed()),
          TrueOrFalse(currentKeyEvent->mKeyPressHandled)));
 
-    // WebKit and text editor dismisses autocorrect panel by enter, then process
-    // autocorrect.
-    mProcessTextSubstitution = (keypressEvent.mKeyCode == NS_VK_RETURN);
-    DismissTextSubstitutionPanel();
+    if (currentKeyEvent->mKeyPressDispatched) {
+      // WebKit and text editor dismisses autocorrect panel by enter, then
+      // process autocorrect.
+      const bool isEnterKeyPress = (keypressEvent.mKeyCode == NS_VK_RETURN);
+      // If not enterkey key, we don't process text substitution.
+      mProcessTextSubstitution = isEnterKeyPress;
+
+      if (isEnterKeyPress || mPendingDismissTextSubstitution) {
+        DismissTextSubstitutionPanel();
+      }
+    }
 
     // This command is now dispatched with keypress event.
     // So, this shouldn't be handled by nobody anymore.
     return true;
   }
@@ -5077,10 +5091,12 @@
       NewRunnableMethod<uint32_t>(
           "IMEInputHandler::OnTextSubstitution", this,
           &IMEInputHandler::OnTextSubstitution,
           aIMENotification.mTextChangeData.mAddedEndOffset),
       100, EventQueuePriority::Idle);
+
+  mPendingDismissTextSubstitution = true;
 }
 
 void IMEInputHandler::OnTextSubstitution(uint32_t aStartOffset) {
   NS_OBJC_BEGIN_TRY_IGNORE_BLOCK;
 

