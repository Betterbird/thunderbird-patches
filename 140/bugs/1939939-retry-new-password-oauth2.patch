# HG changeset patch
# User Geoff Lankow <geoff@darktrojan.net>
# Date 1763658098 -3600
# Node ID d4fabe6df868a86478076a803aa399137eb4511e
# Parent  3ef4db13c9d36e3a01533c0003e600ff059e6a65
Bug 1939939 - Make the Retry and Enter New Password buttons do something for OAuth2. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D271914

diff --git a/mailnews/base/src/MailAuthenticator.sys.mjs b/mailnews/base/src/MailAuthenticator.sys.mjs
--- a/mailnews/base/src/MailAuthenticator.sys.mjs
+++ b/mailnews/base/src/MailAuthenticator.sys.mjs
@@ -2,10 +2,10 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 import { MailCryptoUtils } from "resource:///modules/MailCryptoUtils.sys.mjs";
-
 import { MailStringUtils } from "resource:///modules/MailStringUtils.sys.mjs";
+import { OAuth2Module } from "resource:///modules/OAuth2Module.sys.mjs";
 
 /**
  * A base class for interfaces when authenticating a mail connection.
  */
@@ -275,13 +275,19 @@ export class SmtpAuthenticator extends M
     // before base64 encoded.
     return btoa("\0" + this.username + "\0" + this.getByteStringPassword());
   }
 
+  getOAuthModule() {
+    const oauth2Module = new OAuth2Module();
+    if (!oauth2Module.initFromOutgoing(this._server)) {
+      return null;
+    }
+    return oauth2Module;
+  }
+
   async getOAuthToken() {
-    const oauth2Module = Cc["@mozilla.org/mail/oauth2-module;1"].createInstance(
-      Ci.msgIOAuth2Module
-    );
-    if (!oauth2Module.initFromOutgoing(this._server)) {
+    const oauth2Module = this.getOAuthModule();
+    if (!oauth2Module) {
       return Promise.reject(
         `initFromOutgoing failed, hostname: ${this.hostname}`
       );
     }
diff --git a/mailnews/base/src/OAuth2Module.sys.mjs b/mailnews/base/src/OAuth2Module.sys.mjs
--- a/mailnews/base/src/OAuth2Module.sys.mjs
+++ b/mailnews/base/src/OAuth2Module.sys.mjs
@@ -109,8 +109,15 @@ OAuth2Module.prototype = {
 
     return true;
   },
 
+  /**
+   * Get a refresh token that matches this object from the login manager, if
+   * one exists. May set `this._scope` if the scope of the token is wider than
+   * `this._requiredScopes`.
+   *
+   * @returns {string} - A refresh token, or an empty string.
+   */
   getRefreshToken() {
     for (const login of Services.logins.findLogins(
       this._loginOrigin,
       null,
@@ -126,8 +133,14 @@ OAuth2Module.prototype = {
       }
     }
     return "";
   },
+  /**
+   * Set the refresh token in the login manager, modifying any existing logins
+   * that this token supersedes, or adding a new login if none exists.
+   *
+   * @param {string} token
+   */
   async setRefreshToken(token) {
     const scope = this._oauth.scope ?? this._scope;
     const grantedScopes = scopeSet(scope);
 
@@ -140,9 +153,9 @@ OAuth2Module.prototype = {
       }
 
       const loginScopes = scopeSet(login.httpRealm);
       if (grantedScopes.isSupersetOf(loginScopes)) {
-        if (grantedScopes.size == loginScopes.size) {
+        if (grantedScopes.size == loginScopes.size && token) {
           // The scope matches, just update the token...
           if (login.password != token) {
             // ... but only if it actually changed.
             log.debug(
@@ -177,8 +190,44 @@ OAuth2Module.prototype = {
       login.init(this._loginOrigin, null, scope, this._username, token, "", "");
       await Services.logins.addLoginAsync(login);
     }
   },
+  /**
+   * Clear the access token in memory, so that the next attempt to access it
+   * must query the server.
+   */
+  clearAccessToken() {
+    this._oauth.accessToken = null;
+  },
+  /**
+   * Clear the refresh and access tokens in memory, and the refresh token from
+   * the login manager, so the the next attempt to use this object must
+   * re-authenticate.
+   */
+  clearTokens() {
+    this._oauth.refreshToken = null;
+    this._oauth.accessToken = null;
+
+    const scope = this._oauth.scope ?? this._scope;
+    const grantedScopes = scopeSet(scope);
+
+    // Update any existing logins matching this origin, username, and scope.
+    const logins = Services.logins.findLogins(this._loginOrigin, null, "");
+    for (const login of logins) {
+      if (login.username != this._username) {
+        continue;
+      }
+
+      const loginScopes = scopeSet(login.httpRealm);
+      if (grantedScopes.isSupersetOf(loginScopes)) {
+        // We've got a new token for this scope, remove the existing one.
+        log.debug(
+          `Removing obsolete token for ${this._loginOrigin} with scope "${login.httpRealm}"`
+        );
+        Services.logins.removeLogin(login);
+      }
+    }
+  },
 
   connect(withUI, listener) {
     this._fetchAccessToken(listener, withUI, true);
   },
diff --git a/mailnews/compose/src/SmtpClient.sys.mjs b/mailnews/compose/src/SmtpClient.sys.mjs
--- a/mailnews/compose/src/SmtpClient.sys.mjs
+++ b/mailnews/compose/src/SmtpClient.sys.mjs
@@ -797,9 +797,13 @@ export class SmtpClient {
     }
 
     // Ask user what to do.
     const action = this._authenticator.promptAuthFailed();
-    if (action == 1) {
+    if (action == 0 && this._currentAuthMethod == "XOAUTH2") {
+      // Retry button pressed. Clear the OAuth access token to get a new one.
+      const oauth2Module = this._authenticator.getOAuthModule();
+      oauth2Module?.clearAccessToken();
+    } else if (action == 1) {
       // Cancel button pressed.
       this.logger.error(`Authentication failed: ${command.data}`);
       this._onNsError("smtpAuthFailure");
       return;
diff --git a/mailnews/compose/src/SmtpServer.sys.mjs b/mailnews/compose/src/SmtpServer.sys.mjs
--- a/mailnews/compose/src/SmtpServer.sys.mjs
+++ b/mailnews/compose/src/SmtpServer.sys.mjs
@@ -3,8 +3,9 @@
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 import { AppConstants } from "resource://gre/modules/AppConstants.sys.mjs";
 import { MailServices } from "resource:///modules/MailServices.sys.mjs";
+import { OAuth2Module } from "resource:///modules/OAuth2Module.sys.mjs";
 
 const lazy = {};
 ChromeUtils.defineESModuleGetters(lazy, {
   SmtpClient: "resource:///modules/SmtpClient.sys.mjs",
@@ -360,16 +361,27 @@ export class SmtpServer {
     return this.password;
   }
 
   forgetPassword() {
+    this.password = "";
+    if (!this.hostname) {
+      // Looks like we're not fully set up yet. There's no point in continuing.
+      return;
+    }
+
     const serverURI = this._getServerURISpec();
     const logins = Services.logins.findLogins(serverURI, "", serverURI);
     for (const login of logins) {
       if (login.username == this.username) {
         Services.logins.removeLogin(login);
       }
     }
-    this.password = "";
+    if (this.authMethod == Ci.nsMsgAuthMethod.OAuth2) {
+      const oauth2Module = new OAuth2Module();
+      if (oauth2Module.initFromOutgoing(this)) {
+        oauth2Module.clearTokens();
+      }
+    }
   }
 
   verifyLogon(urlListener) {
     const client = new lazy.SmtpClient(this);
