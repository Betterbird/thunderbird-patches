# HG changeset patch
# User Toby Pilling <toby@thunderbird.net>
# Date 1755624061 25200
# Node ID a89769b2785e89e5181001dd3974d2908f3d84b5
# Parent  a2c583495e37a5ad58c7bb4d1f7cd84f83b2d8d3
Bug 1981174 - Make address book email lookup from cache case-insensitive. r=darktrojan,mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D261163

diff --git a/mailnews/addrbook/modules/AddrBookManager.sys.mjs b/mailnews/addrbook/modules/AddrBookManager.sys.mjs
--- a/mailnews/addrbook/modules/AddrBookManager.sys.mjs
+++ b/mailnews/addrbook/modules/AddrBookManager.sys.mjs
@@ -594,28 +594,28 @@ AddrBookManager.prototype = {
   /**
    * @param {string} emailAddress - Email address to look up.
    * @returns {?nsIAbCard} the found card, if any.
    */
   cardForEmailAddress(emailAddress) {
     if (!emailAddress) {
       return null;
     }
-    emailAddress = emailAddress.toLowerCase();
+    emailAddress = emailAddress.trim().toLowerCase();
 
     if (!addressCache) {
       addressCache = new Map();
       ensureInitialized();
       // Iterate the directories and cards in reverse so cards that appear
       // first (in the usual ordering) are prioritized.
       for (const directory of sortedDirectoryList.toReversed()) {
         try {
           for (const card of directory.childCards.toReversed()) {
             for (const _emailAddress of card.emailAddresses) {
-              addressCache.set(_emailAddress, card);
+              addressCache.set(_emailAddress.trim().toLowerCase(), card);
             }
           }
         } catch (ex) {
           // Directories can throw, that's okay.
         }
       }
     }
 
