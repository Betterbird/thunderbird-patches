# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1767041943 -3600
# Parent  2ae20355801eb1f61fcd9ffc0273be02e9d67d1e
Bug 900117 - Handle 'file:' URIs containing commas in -compose attachment arguments.

diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -4684,9 +4684,19 @@ async function ComposeStartup() {
       if (args.subject) {
         composeFields.subject = args.subject;
       }
       if (args.attachment && window.arguments[1] instanceof Ci.nsICommandLine) {
-        const attachmentList = args.attachment.split(",");
+        // Workaround to support 'file:' URIs for attachments with commas in
+        // their paths.
+        // Note: Per RFC 3986, commas are 'sub-delimiters' and are technically
+        // legal in 'file:' URIs without encoding. Consequently, utilities like
+        // xdg-email pass literal commas in URIs, for example for the 'Send
+        // To/Mail Recipient' action in file managers.
+        const isUriMode = args.attachment.toLowerCase().startsWith("file:");
+        const processedAttachments = isUriMode
+          ? args.attachment.replace(/,(?!file:)/gi, "%2C")
+          : args.attachment;
+        const attachmentList = processedAttachments.split(",");
         for (const attachmentName of attachmentList) {
           // resolveURI does all the magic around working out what the
           // attachment is, including web pages, and generating the correct uri.
           const uri = window.arguments[1].resolveURI(attachmentName);
