# HG changeset patch
# User Kai Engert <kaie@kuix.de>
# Date 1756326879 -7200
# Node ID 01f43122dbbfbee12e88b4774b62ecd53de9e1f7
# Parent  36ae3d5790a01d935226b6515423d62e1e153cca
Bug 1982284 - Gracefully handle autoconfig in unexpected format like html page. r=freaktechnik

Differential Revision: https://phabricator.services.mozilla.com/D260626

diff --git a/mail/components/accountcreation/modules/ExchangeAutoDiscover.sys.mjs b/mail/components/accountcreation/modules/ExchangeAutoDiscover.sys.mjs
--- a/mail/components/accountcreation/modules/ExchangeAutoDiscover.sys.mjs
+++ b/mail/components/accountcreation/modules/ExchangeAutoDiscover.sys.mjs
@@ -335,12 +335,9 @@ function readAutoDiscoverResponse(
   assert(typeof successCallback == "function");
   assert(typeof errorCallback == "function");
 
   // redirect to other email address
-  if (
-    "Account" in autoDiscoverXML.Autodiscover.Response &&
-    "RedirectAddr" in autoDiscoverXML.Autodiscover.Response.Account
-  ) {
+  if (autoDiscoverXML?.Autodiscover?.Response?.Account?.RedirectAddr) {
     // <https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxdscli/49083e77-8dc2-4010-85c6-f40e090f3b17>
     const redirectEmailAddress = lazy.Sanitizer.emailAddress(
       autoDiscoverXML.Autodiscover.Response.Account.RedirectAddr
     );
@@ -361,10 +358,17 @@ function readAutoDiscoverResponse(
     );
     return;
   }
 
-  const config = readAutoDiscoverXML(autoDiscoverXML, username);
-  if (config.isComplete()) {
+  let success = false;
+  let config;
+  try {
+    config = readAutoDiscoverXML(autoDiscoverXML, username);
+    success = config.isComplete();
+  } catch (error) {
+    gAccountSetupLogger.log(error);
+  }
+  if (success) {
     successCallback(config);
   } else {
     errorCallback(new Exception("No valid configs found in AutoDiscover XML"));
   }
