# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1767042353 -3600
# Parent  2f994c3e69661f4822cf6b23f3156943a9643074
Bug 900117 - Allow escaping of comma in command line -compose "attachment='file\,part.txt'"

diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -4690,12 +4690,19 @@ async function ComposeStartup() {
         // Note: Per RFC 3986, commas are 'sub-delimiters' and are technically
         // legal in 'file:' URIs without encoding. Consequently, utilities like
         // xdg-email pass literal commas in URIs, for example for the 'Send
         // To/Mail Recipient' action in file managers.
-        const isUriMode = args.attachment.toLowerCase().startsWith("file:");
-        const processedAttachments = isUriMode
-          ? args.attachment.replace(/,(?!file:)/gi, "%2C")
-          : args.attachment;
+        let attachmentList;
+        if (args.attachment.toLowerCase().startsWith("file:")) {
+          attachmentList = args.attachment
+            .replace(/,(?!file:)/gi, "%2C")
+            .split(",");
+        } else {
+          // Use negative "lookbehind", don't split if preceded by backslash.
+          attachmentList = args.attachment
+            .split(/(?<!\\),/)
+            .map(s => s.replace(/\\,/g, ","));
+        }
         const attachmentList = processedAttachments.split(",");
         for (const attachmentName of attachmentList) {
           // resolveURI does all the magic around working out what the
           // attachment is, including web pages, and generating the correct uri.
