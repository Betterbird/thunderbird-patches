# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1767045811 -3600
# Parent  559ccba0601bf0f55a24b42ae043355e34e72de6
Bug 900117 - Allow escaping of comma in command line -compose "attachment='file\,part.txt'"

diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -4690,13 +4690,19 @@ async function ComposeStartup() {
         // Note: Per RFC 3986, commas are 'sub-delimiters' and are technically
         // legal in 'file:' URIs without encoding. Consequently, utilities like
         // xdg-email pass literal commas in URIs, for example for the 'Send
         // To/Mail Recipient' action in file managers.
-        const isUriMode = args.attachment.toLowerCase().startsWith("file:");
-        const processedAttachments = isUriMode
-          ? args.attachment.replace(/,(?!file:)/gi, "%2C")
-          : args.attachment;
-        const attachmentList = processedAttachments.split(",");
+        let attachmentList;
+        if (args.attachment.toLowerCase().startsWith("file:")) {
+          attachmentList = args.attachment
+            .replace(/,(?!file:)/gi, "%2C")
+            .split(",");
+        } else {
+          // Use negative "lookbehind", don't split if preceded by backslash.
+          attachmentList = args.attachment
+            .split(/(?<!\\),/)
+            .map(s => s.replace(/\\,/g, ","));
+        }
         for (const attachmentName of attachmentList) {
           // resolveURI does all the magic around working out what the
           // attachment is, including web pages, and generating the correct uri.
           const uri = window.arguments[1].resolveURI(attachmentName);
