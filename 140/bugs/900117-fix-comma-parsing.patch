# HG changeset patch
# User Betterbird <betterbird@betterbird.eu>
# Date 1766785511 -3600
# Parent  cf622a3bb147a36cfda36fc572e6de4dd5236c61
Bug 900117 - Fix comma parsing in Mail's nsICommandLineHandler.handle().

Should also fix bug 258887 and friends.

diff --git a/mail/components/MessengerContentHandler.sys.mjs b/mail/components/MessengerContentHandler.sys.mjs
--- a/mail/components/MessengerContentHandler.sys.mjs
+++ b/mail/components/MessengerContentHandler.sys.mjs
@@ -211,8 +211,48 @@ export class MessengerContentHandler {
     // "nsIContentHandler", // Don't! FIXME: remove QI and implementation?
     "nsIFactory",
   ]);
 
+  // Code provided by ChatGPT, why think for yourself if it's Christmas?
+  parseCommand(input) {
+    const m = /^\s*(\w+)\((.*)\)\s*$/.exec(input);
+    if (!m) {
+      throw new Error("Invalid command");
+    }
+
+    const verb = m[1].toLowerCase();
+    const params = [];
+
+    let current = "";
+    let inQuotes = false;
+    let quoteChar = null;
+
+    for (let i = 0; i < m[2].length; i++) {
+      const ch = m[2][i];
+
+      if (ch === '"' || ch === "'") {
+        if (!inQuotes) {
+          inQuotes = true;
+          quoteChar = ch;
+        } else if (ch === quoteChar) {
+          inQuotes = false;
+        }
+        current += ch;
+      } else if (ch === "," && !inQuotes) {
+        params.push(current.trim());
+        current = "";
+      } else {
+        current += ch;
+      }
+    }
+
+    if (current) {
+      params.push(current.trim());
+    }
+
+    return { verb, params };
+  }
+
   /** @see {nsICommandLineHandler} */
   handle(cmdLine) {
     // Migration is also handled from command line. But differently: the flag
     // is already removed by toolkit. We don't want any other windows.
@@ -278,11 +318,10 @@ export class MessengerContentHandler {
       throw Components.Exception("", Cr.NS_ERROR_ABORT);
     }
 
     if (remoteCommand) {
-      const a = /^\s*(\w+)\(([^\)]*)\)\s*$/.exec(remoteCommand);
-      const remoteVerb = a[1].toLowerCase();
-      const remoteParams = a[2].split(",");
+      const { verb: remoteVerb, params: remoteParams } =
+        this.parseCommand(remoteCommand);
 
       switch (remoteVerb) {
         case "mailto": {
           // -remote "mailto(foo@example.com)"
diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -4835,9 +4835,12 @@ async function ComposeStartup() {
       if (args.subject) {
         composeFields.subject = args.subject;
       }
       if (args.attachment && window.arguments[1] instanceof Ci.nsICommandLine) {
-        const attachmentList = args.attachment.split(",");
+        // Use negative "lookbehind", don't split if preceded by backslash.
+        const attachmentList = args.attachment
+          .split(/(?<!\\),/)
+          .map(s => s.replace(/\\,/g, ","));
         for (const attachmentName of attachmentList) {
           // resolveURI does all the magic around working out what the
           // attachment is, including web pages, and generating the correct uri.
           const uri = window.arguments[1].resolveURI(attachmentName);
