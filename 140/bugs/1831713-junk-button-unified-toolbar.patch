# HG changeset patch
# User solange@thunderbird.net
# Date 1758932329 -7200
# Parent  ce94ed414d0fcd3b54a4237de8906bd2dac40d3b
Bug 1831713 - 'Junk' button does not change to 'Not Junk' button in supernova's unified toolbar.

Based on https://phabricator.services.mozilla.com/D234776

diff --git a/mail/components/unifiedtoolbar/content/items/junk-button.mjs b/mail/components/unifiedtoolbar/content/items/junk-button.mjs
new file mode 100644
--- /dev/null
+++ b/mail/components/unifiedtoolbar/content/items/junk-button.mjs
@@ -0,0 +1,67 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */
+
+import { MailTabButton } from "chrome://messenger/content/unifiedtoolbar/mail-tab-button.mjs";
+
+/* import-globals-from ../../../../base/content/globalOverlay.js */
+
+/**
+ * Unified toolbar button that marks the selected message as junk or not junk.
+ */
+class JunkButton extends MailTabButton {
+  #isJunk;
+  /**
+   * Handle the context changing, updating the disabled state for the button
+   * etc.
+   * @returns {void}
+   */
+  onCommandContextChange() {
+    const message = document.getElementById("tabmail").currentTabInfo.message;
+    try {
+      this.#isJunk = message.getStringProperty("junkscore") != 0;
+      const controller = this.#isJunk
+        ? getEnabledControllerForCommand("cmd_markAsNotJunk")
+        : getEnabledControllerForCommand("cmd_markAsJunk");
+      this.disabled = !controller || !message;
+
+      if (this.disabled) {
+        return;
+      }
+      this.#updateJunkButton();
+    } catch {
+      this.disabled = true;
+      console.log(
+        "Warning: Unified junk button is disabled. The controller or the select message is null."
+      );
+    }
+  }
+
+  /**
+   * Handle the updating of the junk button's label
+   * @param {bool} isJunk
+   */
+  #updateJunkButton(isJunk) {
+    const state = this.#isJunk ? "not-junk" : "junk";
+    this.setAttribute("label-id", `toolbar-${state}-label`);
+    document.l10n.setAttributes(this, `toolbar-${state}-title`);
+  }
+
+  /**
+   * Runs the correspondent command when the user clicks on the unified 'junk'
+   * or 'not junk' button.
+   * @param {Event} event
+   */
+  handleClick(event) {
+    const message = document.getElementById("tabmail").currentTabInfo.message;
+    this.#isJunk = message.getStringProperty("junkscore") != 0;
+    goDoCommand(this.#isJunk ? "cmd_markAsNotJunk" : "cmd_markAsJunk");
+    event.preventDefault();
+    event.stopPropagation();
+    this.#isJunk = !this.#isJunk;
+    this.#updateJunkButton();
+  }
+}
+customElements.define("junk-button", JunkButton, {
+  extends: "button",
+});
diff --git a/mail/components/unifiedtoolbar/content/unifiedToolbarCustomizableItems.inc.xhtml b/mail/components/unifiedtoolbar/content/unifiedToolbarCustomizableItems.inc.xhtml
--- a/mail/components/unifiedtoolbar/content/unifiedToolbarCustomizableItems.inc.xhtml
+++ b/mail/components/unifiedtoolbar/content/unifiedToolbarCustomizableItems.inc.xhtml
@@ -148,10 +148,9 @@
 </html:template>
 
 <html:template id="junkTemplate"
                xmlns="http://www.w3.org/1999/xhtml">
-  <button is="mail-tab-button"
-          command="cmd_markAsJunk"
+  <button is="junk-button"
           label-id="toolbar-junk-label"
           data-l10n-id="toolbar-junk"></button>
 </html:template>
 
diff --git a/mail/components/unifiedtoolbar/jar.mn b/mail/components/unifiedtoolbar/jar.mn
--- a/mail/components/unifiedtoolbar/jar.mn
+++ b/mail/components/unifiedtoolbar/jar.mn
@@ -13,8 +13,9 @@ messenger.jar:
     content/messenger/unifiedtoolbar/delete-button.mjs                 (content/items/delete-button.mjs)
     content/messenger/unifiedtoolbar/folder-location-button.mjs        (content/items/folder-location-button.mjs)
     content/messenger/unifiedtoolbar/get-messages-button.mjs           (content/items/get-messages-button.mjs)
     content/messenger/unifiedtoolbar/global-search-bar.mjs             (content/items/global-search-bar.mjs)
+    content/messenger/unifiedtoolbar/junk-button.mjs                   (content/items/junk-button.mjs)
     content/messenger/unifiedtoolbar/mail-go-button.mjs                (content/items/mail-go-button.mjs)
     content/messenger/unifiedtoolbar/quick-filter-bar-toggle.mjs       (content/items/quick-filter-bar-toggle.mjs)
     content/messenger/unifiedtoolbar/space-button.mjs                  (content/items/space-button.mjs)
     content/messenger/unifiedtoolbar/view-picker-button.mjs            (content/items/view-picker-button.mjs)
diff --git a/mail/components/unifiedtoolbar/modules/CustomizableItemsDetails.mjs b/mail/components/unifiedtoolbar/modules/CustomizableItemsDetails.mjs
--- a/mail/components/unifiedtoolbar/modules/CustomizableItemsDetails.mjs
+++ b/mail/components/unifiedtoolbar/modules/CustomizableItemsDetails.mjs
@@ -247,9 +247,9 @@ export default [
     labelId: "toolbar-junk",
     spaces: ["mail"],
     templateId: "junkTemplate",
     requiredModules: [
-      "chrome://messenger/content/unifiedtoolbar/mail-tab-button.mjs",
+      "chrome://messenger/content/unifiedtoolbar/junk-button.mjs",
     ],
   },
   {
     id: "delete",
diff --git a/mail/locales/en-US/messenger/unifiedToolbarItems.ftl b/mail/locales/en-US/messenger/unifiedToolbarItems.ftl
--- a/mail/locales/en-US/messenger/unifiedToolbarItems.ftl
+++ b/mail/locales/en-US/messenger/unifiedToolbarItems.ftl
@@ -87,12 +87,17 @@ toolbar-next-label = Next
 
 toolbar-next =
     .title = Move to the next message
 
-toolbar-junk-label = Junk
+toolbar-junk-label = { toolbar-junk-button.label }
+
+toolbar-junk-title =
+    .title = { toolbar-junk-button.tooltiptext }
 
-toolbar-junk =
-    .title = Mark the selected messages as junk
+toolbar-not-junk-label = { toolbar-not-junk-button.label }
+
+toolbar-not-junk-title =
+    .title = { toolbar-not-junk-button.tooltiptext }
 
 toolbar-delete-label = Delete
 
 toolbar-delete-title =
