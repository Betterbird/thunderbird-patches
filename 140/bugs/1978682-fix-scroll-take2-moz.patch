# HG changeset patch
# User Hiroyuki Ikezoe <hikezoe.birchill@mozilla.com>
# Date 1761644052 -3600
# Node ID f0dedf9da0fb30282c9c058e4e05e29ff8af63c5
# Parent  32d0acd1b6fa3468361867b2d32144ebedc2b7c9
Bug 1978682 - Skip applying relative/instant scroll position updates if the APZC is default and there was no absolute/instant updates before the relative ones.

diff --git a/gfx/layers/apz/src/AsyncPanZoomController.cpp b/gfx/layers/apz/src/AsyncPanZoomController.cpp
--- a/gfx/layers/apz/src/AsyncPanZoomController.cpp
+++ b/gfx/layers/apz/src/AsyncPanZoomController.cpp
@@ -5839,8 +5839,9 @@ void AsyncPanZoomController::NotifyLayer
   bool instantScrollMayTriggerTransform = false;
   bool scrollOffsetUpdated = false;
   bool smoothScrollRequested = false;
   bool didCancelAnimation = false;
+  bool instantAbsoluteUpdated = false;
   Maybe<CSSPoint> cumulativeRelativeDelta;
   for (const auto& scrollUpdate : aScrollMetadata.GetScrollUpdates()) {
     APZC_LOG("%p processing scroll update %s\n", this,
              ToString(scrollUpdate).c_str());
@@ -5935,28 +5936,41 @@ void AsyncPanZoomController::NotifyLayer
 
     Maybe<CSSPoint> relativeDelta;
     if (scrollUpdate.GetType() == ScrollUpdateType::Relative) {
       APZC_LOG(
-          "%p relative updating scroll offset from %s by %s\n", this,
-          ToString(Metrics().GetVisualScrollOffset()).c_str(),
+          "%p relative updating scroll offset from %s by %s, isDefault(%d)\n",
+          this, ToString(Metrics().GetVisualScrollOffset()).c_str(),
           ToString(scrollUpdate.GetDestination() - scrollUpdate.GetSource())
-              .c_str());
-
-      scrollOffsetUpdated = true;
-
-      // It's possible that the main thread has ignored an APZ scroll offset
-      // update for the pending relative scroll that we have just received.
-      // When this happens, we need to send a new scroll offset update with
-      // the combined scroll offset or else the main thread may have an
-      // incorrect scroll offset for a period of time.
-      if (Metrics().HasPendingScroll(aLayerMetrics)) {
+              .c_str(),
+          isDefault);
+
+      // If this APZC is default, i.e. newly created one, any relative instant
+      // scroll position update has been already reflected other than cases
+      // where there was no instant/absolute position update so that we don't
+      // need to apply the update.
+      if (!isDefault || instantAbsoluteUpdated) {
+        scrollOffsetUpdated = true;
+
+        // It's possible that the main thread has ignored an APZ scroll offset
+        // update for the pending relative scroll that we have just received.
+        // When this happens, we need to send a new scroll offset update with
+        // the combined scroll offset or else the main thread may have an
+        // incorrect scroll offset for a period of time.
+        if (Metrics().HasPendingScroll(aLayerMetrics)) {
+          needContentRepaint = true;
+          contentRepaintType = RepaintUpdateType::eUserAction;
+        }
+
+        relativeDelta =
+            Some(Metrics().ApplyRelativeScrollUpdateFrom(scrollUpdate));
+        Metrics().RecalculateLayoutViewportOffset();
+      } else if (Metrics().IsRootContent()) {
+        // Even though the relative instant scroll has been already reflected as
+        // a layout scroll offset, it hasn't yet been reflected on the
+        // main-thread as a visual scroll offset, we need to notify it.
         needContentRepaint = true;
-        contentRepaintType = RepaintUpdateType::eUserAction;
+        contentRepaintType = RepaintUpdateType::eVisualUpdate;
       }
-
-      relativeDelta =
-          Some(Metrics().ApplyRelativeScrollUpdateFrom(scrollUpdate));
-      Metrics().RecalculateLayoutViewportOffset();
     } else if (scrollUpdate.GetType() == ScrollUpdateType::PureRelative) {
       APZC_LOG("%p pure-relative updating scroll offset from %s by %s\n", this,
                ToString(Metrics().GetVisualScrollOffset()).c_str(),
                ToString(scrollUpdate.GetDelta()).c_str());
@@ -5987,8 +6001,9 @@ void AsyncPanZoomController::NotifyLayer
                ToString(Metrics().GetVisualScrollOffset()).c_str(),
                ToString(scrollUpdate.GetDestination()).c_str());
       bool offsetChanged = Metrics().ApplyScrollUpdateFrom(scrollUpdate);
       Metrics().RecalculateLayoutViewportOffset();
+      instantAbsoluteUpdated = true;
 
       if (offsetChanged || scrollUpdate.GetMode() != ScrollMode::Instant ||
           scrollUpdate.GetType() != ScrollUpdateType::Absolute ||
           scrollUpdate.GetOrigin() != ScrollOrigin::None) {
