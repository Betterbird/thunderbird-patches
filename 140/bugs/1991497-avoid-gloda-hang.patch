# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1768149824 -3600
# Parent  1697eb972fb2d126b3d8dbe989413e51511d5eee
Bug 1991497 - Fix Gloda indexing for offline IMAP folders with corrupt summary files.

diff --git a/mailnews/db/gloda/modules/MimeMessage.sys.mjs b/mailnews/db/gloda/modules/MimeMessage.sys.mjs
--- a/mailnews/db/gloda/modules/MimeMessage.sys.mjs
+++ b/mailnews/db/gloda/modules/MimeMessage.sys.mjs
@@ -73,11 +73,13 @@ CallbackStreamListener.prototype = {
   // nsIUrlListener part
 
   OnStartRunningUrl() {},
   OnStopRunningUrl(aUrl, aExitCode) {
-    if (!Components.isSuccessCode(aExitCode)) {
+    if (!Components.isSuccessCode(aExitCode) || this._msgHdr) {
       // Connection errors are not seen by onStopRequest, so we finalize on
-      // fails here.
+      // fails here. For offline IMAP folders, the exit code might differ from
+      // the one passed to onStopRequest, so we ensure the message is finalized
+      // to avoid the indexing process hanging.
       this._finalize(null);
     }
   },
 
